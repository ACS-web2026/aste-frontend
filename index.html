<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma Aste Immobiliari Avanzata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        #map { height: 300px; width: 100%; border-radius: 0.5rem; }
        .leaflet-container { font-family: inherit; }
        .source-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            margin: 2px; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            cursor: pointer;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-container"></div>

    <script>
        // Configurazione
        const MASTER_PASSWORD = 'aste2025';
        const MAP_CENTER = [41.8719, 12.5674];
        const MAP_ZOOM = 6;
        let map = null;

        // State globale
        let state = {
            isAuthenticated: false,
            password: '',
            showPassword: false,
            activeTab: 'search',
            isLoading: false,
            searchStatus: 'Pronto per la ricerca',
            filters: { comune: '', tipologia: '', prezzoMin: '', prezzoMax: '' },
            clients: [
                { id: '1', name: 'Mario Rossi', email: 'mario@email.com', budget: 350000, preferenze: ['Milano', 'Appartamento'], note: 'Cerca trilocale' },
                { id: '2', name: 'Laura Bianchi', email: 'laura@email.com', budget: 500000, preferenze: ['Roma', 'Villa'], note: 'Zona residenziale' },
                { id: '3', name: 'Giuseppe Verdi', email: 'giuseppe@email.com', budget: 200000, preferenze: ['Torino', 'Garage'], note: 'Per investimento' },
                { id: '4', name: 'Anna Neri', email: 'anna@email.com', budget: 600000, preferenze: ['Firenze', 'Attico'], note: 'Vista panoramica' }
            ],
            searchResults: [],
            selectedAnnuncio: null,
            showClientSuggestions: false
        };

        // Coordinate per comuni
        const coordinateComuni = {
            'Milano': [45.4642, 9.1900], 'Roma': [41.9028, 12.4964], 'Torino': [45.0703, 7.6869],
            'Napoli': [40.8518, 14.2681], 'Firenze': [43.7696, 11.2558], 'Bologna': [44.4949, 11.3426],
            'Genova': [44.4056, 8.9463], 'Venezia': [45.4408, 12.3155], 'Verona': [45.4384, 10.9916],
            'Padova': [45.4064, 11.8768], 'Bari': [41.1171, 16.8719], 'Palermo': [38.1157, 13.3615],
            'Catania': [37.5079, 15.0830], 'Cagliari': [39.2238, 9.1217]
        };

        // Fonti disponibili
        const SITES = [
            { name: 'Immobiliare.it', color: 'blue', icon: 'üè†' },
            { name: 'Casa.it', color: 'green', icon: 'üè°' },
            { name: 'Subito.it', color: 'orange', icon: '‚ö°' },
            { name: 'Idealista', color: 'purple', icon: 'üìä' },
            { name: 'Bakeca', color: 'red', icon: 'üç∞' },
            { name: 'Astegiudiziarie.it', color: 'indigo', icon: '‚öñÔ∏è' },
            { name: 'PortaleAste.it', color: 'pink', icon: 'üåê' }
        ];

        // Render app principale
        function render() {
            const app = document.getElementById('app');
            if (!state.isAuthenticated) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMain();
            }
            attachEventListeners();
            
            // Inizializza mappa se ci sono risultati
            if (state.activeTab === 'search' && state.searchResults.length > 0) {
                setTimeout(initMap, 100);
            }
            
            // Render modale se necessario
            renderModal();
        }

        function renderLogin() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                    <div class="flex items-center justify-center mb-6">
                        <svg class="w-16 h-16 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
                        Piattaforma Aste
                    </h1>
                    <p class="text-center text-gray-600 mb-8">Sistema avanzato di monitoraggio</p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password di accesso</label>
                        <div class="relative">
                            <input
                                type="${state.showPassword ? 'text' : 'password'}"
                                id="password-input"
                                value="${state.password}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Inserisci password"
                            />
                            <button
                                id="toggle-password"
                                type="button"
                                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
                            >
                                ${state.showPassword ? 'üôà' : 'üëÅÔ∏è'}
                            </button>
                        </div>
                    </div>
                    
                    <button
                        id="login-btn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium"
                    >
                        üîê Accedi alla Piattaforma
                    </button>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <p class="text-sm text-blue-800 text-center">
                            <strong>Credenziali demo:</strong> aste2025
                        </p>
                    </div>
                </div>
            </div>
            `;
        }

        function renderMain() {
            return `
            <div class="min-h-screen bg-gray-50">
                <!-- Header -->
                <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white shadow-xl">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="bg-white p-2 rounded-xl">
                                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold">Piattaforma Aste Immobiliari</h1>
                                    <p class="text-sm text-indigo-200">Monitoraggio avanzato su 7 portali</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div class="hidden sm:block text-right">
                                    <p class="text-sm text-indigo-200">Clienti attivi</p>
                                    <p class="text-lg font-bold">${state.clients.length}</p>
                                </div>
                                <button id="logout-btn" class="bg-white/20 hover:bg-white/30 px-5 py-2.5 rounded-lg transition-colors backdrop-blur-sm border border-white/30">
                                    üîì Esci
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Tabs Navigation -->
                <nav class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex overflow-x-auto">
                            <button
                                id="tab-search"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'search' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üîç Ricerca Aste
                            </button>
                            <button
                                id="tab-clients"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'clients' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üë• Clienti (${state.clients.length})
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${state.activeTab === 'search' ? renderSearchTab() : renderClientsTab()}
                </main>
            </div>
            `;
        }

        function renderSearchTab() {
            return `
            <div class="space-y-8">
                <!-- Filtri di Ricerca -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-indigo-100 p-3 rounded-xl">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Ricerca Avanzata</h2>
                            <p class="text-gray-600">Cerca aste immobiliari su 7 portali</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Comune</label>
                            <input
                                id="filter-comune"
                                type="text"
                                placeholder="Es: Milano, Roma..."
                                value="${state.filters.comune}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipologia</label>
                            <select
                                id="filter-tipologia"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                                <option value="">Tutte le tipologie</option>
                                <option value="Appartamento" ${state.filters.tipologia === 'Appartamento' ? 'selected' : ''}>Appartamento</option>
                                <option value="Villa" ${state.filters.tipologia === 'Villa' ? 'selected' : ''}>Villa</option>
                                <option value="Attico" ${state.filters.tipologia === 'Attico' ? 'selected' : ''}>Attico</option>
                                <option value="Garage" ${state.filters.tipologia === 'Garage' ? 'selected' : ''}>Garage</option>
                                <option value="Terreno" ${state.filters.tipologia === 'Terreno' ? 'selected' : ''}>Terreno</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo min</label>
                            <input
                                id="filter-prezzo-min"
                                type="number"
                                placeholder="‚Ç¨"
                                value="${state.filters.prezzoMin}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo max</label>
                            <input
                                id="filter-prezzo-max"
                                type="number"
                                placeholder="‚Ç¨"
                                value="${state.filters.prezzoMax}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                        
                        <div class="flex items-end">
                            <button
                                id="search-btn"
                                ${state.isLoading ? 'disabled' : ''}
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3.5 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium ${state.isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl'}"
                            >
                                ${state.isLoading ? 
                                    '<span class="flex items-center justify-center gap-2"><span class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span> Ricerca...</span>' : 
                                    '<span class="flex items-center justify-center gap-2">üîç Avvia Ricerca</span>'
                                }
                            </button>
                        </div>
                    </div>
                    
                    ${state.searchStatus ? `
                    <div class="p-4 rounded-lg ${state.searchStatus.includes('‚úÖ') ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'}">
                        <div class="flex items-center gap-3">
                            ${state.searchStatus.includes('‚úÖ') ? '‚úÖ' : '‚ÑπÔ∏è'}
                            <p class="font-medium ${state.searchStatus.includes('‚úÖ') ? 'text-green-800' : 'text-blue-800'}">
                                ${state.searchStatus}
                            </p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="mt-6 pt-6 border-t border-gray-100">
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs font-medium text-gray-500">Portali monitorati:</span>
                            ${SITES.map(site => `
                                <span class="text-xs px-3 py-1.5 rounded-full ${getSourceColorClass(site.name)}">
                                    ${site.icon} ${site.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Mappa -->
                ${state.searchResults.length > 0 ? `
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-green-100 p-3 rounded-xl">
                            <span class="text-2xl">üó∫Ô∏è</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Mappa degli Annunci</h3>
                            <p class="text-gray-600">Localizzazione geografica degli immobili</p>
                        </div>
                    </div>
                    <div id="map" class="rounded-xl overflow-hidden border border-gray-200"></div>
                    <p class="text-sm text-gray-500 mt-3">Clicca sui marker per i dettagli degli annunci</p>
                </div>
                ` : ''}

                <!-- Risultati -->
                ${state.searchResults.length > 0 ? `
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${state.searchResults.length} Annunci Trovati</h3>
                            <p class="text-gray-600">Risultati deduplicati automaticamente</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportAllToPDF()" class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow flex items-center gap-2">
                                üìÑ Esporta Tutto
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${state.searchResults.map(r => renderResultCard(r)).join('')}
                    </div>
                    
                    ${state.searchResults.length >= 15 ? `
                    <div class="mt-8 text-center">
                        <button onclick="loadMoreResults()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                            üì• Carica altri annunci
                        </button>
                    </div>
                    ` : ''}
                </div>
                ` : !state.isLoading ? `
                <div class="bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-indigo-100 rounded-full mb-6">
                        <span class="text-4xl">üîç</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Nessuna ricerca effettuata</h3>
                    <p class="text-gray-600 max-w-md mx-auto mb-8">
                        Imposta i filtri di ricerca e clicca "Avvia Ricerca" per trovare annunci di aste immobiliari dai principali portali.
                    </p>
                    <div class="text-sm text-gray-500 p-4 bg-gray-50 rounded-lg max-w-md mx-auto">
                        <p class="font-medium mb-1">Funzionalit√† incluse:</p>
                        <ul class="text-left space-y-1">
                            <li>‚Ä¢ Ricerca su 7 portali simultaneamente</li>
                            <li>‚Ä¢ Deduplicazione automatica degli annunci</li>
                            <li>‚Ä¢ Mappa interattiva con localizzazione</li>
                            <li>‚Ä¢ Esportazione PDF e CSV</li>
                            <li>‚Ä¢ Suggerimenti clienti compatibili</li>
                        </ul>
                    </div>
                </div>
                ` : ''}
            </div>
            `;
        }

        function renderClientsTab() {
            return `
            <div class="space-y-8">
                <!-- Clienti -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div class="bg-purple-100 p-4 rounded-xl">
                                <span class="text-2xl">üë•</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Gestione Clienti</h2>
                                <p class="text-gray-600">Monitora i clienti e trova match automatici</p>
                            </div>
                        </div>
                        <button onclick="addNewClient()" class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow flex items-center gap-2">
                            ‚ûï Nuovo Cliente
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.clients.map(client => renderClientCard(client)).join('')}
                    </div>
                    
                    ${state.clients.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="text-gray-400 text-6xl mb-4">üë•</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Nessun cliente registrato</h3>
                        <p class="text-gray-500 mb-6">Aggiungi il primo cliente per iniziare</p>
                        <button onclick="addNewClient()" class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            ‚ûï Aggiungi Primo Cliente
                        </button>
                    </div>
                    ` : ''}
                </div>

                <!-- Statistiche -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Statistiche e Analisi</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-xl border border-blue-200">
                            <p class="text-sm font-medium text-blue-700 mb-1">Budget Totale</p>
                            <p class="text-3xl font-bold text-blue-800">
                                ‚Ç¨${state.clients.reduce((sum, c) => sum + c.budget, 0).toLocaleString('it-IT')}
                            </p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-xl border border-green-200">
                            <p class="text-sm font-medium text-green-700 mb-1">Cerca Appartamenti</p>
                            <p class="text-3xl font-bold text-green-800">
                                ${state.clients.filter(c => c.preferenze.includes('Appartamento')).length}
                            </p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-xl border border-purple-200">
                            <p class="text-sm font-medium text-purple-700 mb-1">Cerca Ville</p>
                            <p class="text-3xl font-bold text-purple-800">
                                ${state.clients.filter(c => c.preferenze.includes('Villa')).length}
                            </p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-xl border border-orange-200">
                            <p class="text-sm font-medium text-orange-700 mb-1">Comune pi√π ricercato</p>
                            <p class="text-3xl font-bold text-orange-800">${getTopComune()}</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-8 border-t border-gray-100">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">üìà Distribuzione Budget</h4>
                        <div class="space-y-3">
                            ${state.clients.map(client => `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center">
                                            <span class="text-sm font-medium text-indigo-600">${client.name.charAt(0)}</span>
                                        </div>
                                        <span class="font-medium text-gray-700">${client.name}</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-gray-600">‚Ç¨${client.budget.toLocaleString('it-IT')}</span>
                                        <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-green-500 to-emerald-600 rounded-full" 
                                                 style="width: ${(client.budget / 1000000 * 100)}%"></div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderResultCard(result) {
            const prezzoPerMq = result.metriQuadrati > 0 ? (result.prezzo / result.metriQuadrati).toFixed(2) : 'N/A';
            
            return `
            <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-gray-100 overflow-hidden group">
                <!-- Header -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-5 border-b border-gray-200">
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xl">${getPropertyIcon(result.tipologia)}</span>
                                <h3 class="text-xl font-bold text-gray-800">${result.tipologia}</h3>
                            </div>
                            <p class="text-gray-600 flex items-center gap-2">
                                <span class="text-lg">üìç</span>
                                <span>${result.indirizzo}, ${result.comune}</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2.5 rounded-lg shadow">
                                <p class="text-xl font-bold">‚Ç¨${result.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                                <p class="text-xs opacity-90">Prezzo base d'asta</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fonti -->
                    ${result.sources && result.sources.length > 0 ? `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-medium text-gray-700 mb-2">Disponibile su:</p>
                        <div class="flex flex-wrap gap-1.5">
                            ${result.sources.map((source, idx) => `
                                <button 
                                    onclick="openSourceLink('${result.id}', ${idx})"
                                    class="${getSourceColorClass(source.site)} source-badge hover:scale-105 transition-transform"
                                    title="Apri ${source.site}"
                                >
                                    ${getSourceIcon(source.site)} ${source.site}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Contenuto -->
                <div class="p-5">
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <p class="text-xs font-medium text-blue-600 mb-1">Metratura</p>
                            <p class="text-lg font-bold text-blue-700">${result.metriQuadrati} m¬≤</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                            <p class="text-xs font-medium text-green-600 mb-1">Locali</p>
                            <p class="text-lg font-bold text-green-700">${result.locali}</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                            <p class="text-xs font-medium text-purple-600 mb-1">Prezzo/m¬≤</p>
                            <p class="text-lg font-bold text-purple-700">‚Ç¨${prezzoPerMq}</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                            <p class="text-xs font-medium text-orange-600 mb-1">Data Asta</p>
                            <p class="text-lg font-bold text-orange-700">${result.dataAsta}</p>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 mb-5 line-clamp-2">${result.descrizione}</p>
                    
                    <!-- Bottoni Azione -->
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            onclick="exportAnnuncioToPDF(${result.id})"
                            class="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 group/btn"
                        >
                            <span class="group-hover/btn:scale-110 transition-transform">üìÑ</span>
                            <span class="text-sm font-medium">PDF</span>
                        </button>
                        
                        <button 
                            onclick="showClientSuggestions(${result.id})"
                            class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 group/btn"
                        >
                            <span class="group-hover/btn:scale-110 transition-transform">üë•</span>
                            <span class="text-sm font-medium">Clienti</span>
                        </button>
                        
                        <button 
                            onclick="showAnnuncioDetails(${result.id})"
                            class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 group/btn"
                        >
                            <span class="group-hover/btn:scale-110 transition-transform">üìä</span>
                            <span class="text-sm font-medium">Dettagli</span>
                        </button>
                    </div>
                </div>
            </div>
            `;
        }

        function renderClientCard(client) {
            return `
            <div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-xl flex items-center justify-center">
                            <span class="text-xl font-bold text-indigo-600">${client.name.charAt(0)}</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg">${client.name}</h4>
                            <p class="text-sm text-gray-600">${client.email}</p>
                        </div>
                    </div>
                    <span class="bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium border border-green-200">
                        ‚Ç¨${client.budget.toLocaleString('it-IT')}
                    </span>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Preferenze:</p>
                    <div class="flex flex-wrap gap-1.5">
                        ${client.preferenze.map(pref => `
                            <span class="bg-indigo-50 text-indigo-700 text-xs px-2.5 py-1.5 rounded-lg border border-indigo-100">
                                ${pref}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <p class="text-sm text-gray-600 mb-5 italic border-l-4 border-indigo-200 pl-3 py-1 bg-indigo-50/50">
                    "${client.note}"
                </p>
                
                <div class="grid grid-cols-2 gap-2">
                    <button 
                        onclick="viewClientMatches('${client.id}')"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors text-sm font-medium"
                    >
                        üîç Trova match
                    </button>
                    <button 
                        onclick="editClient('${client.id}')"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition-colors text-sm font-medium"
                    >
                        ‚úèÔ∏è Modifica
                    </button>
                </div>
            </div>
            `;
        }

        function renderModal() {
            const modalContainer = document.getElementById('modal-container');
            if (!state.selectedAnnuncio || !state.showClientSuggestions) {
                modalContainer.innerHTML = '';
                return;
            }
            
            const annuncio = state.selectedAnnuncio;
            const matchedClients = findMatchingClients(annuncio);
            
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden mx-4">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold">üë• Clienti Compatibili</h2>
                                <div class="flex items-center gap-3 mt-2">
                                    <div class="bg-white/20 px-3 py-1 rounded-full text-sm">
                                        ${annuncio.tipologia}
                                    </div>
                                    <div class="bg-white/20 px-3 py-1 rounded-full text-sm">
                                        ${annuncio.comune}
                                    </div>
                                    <div class="bg-white/20 px-3 py-1 rounded-full text-sm">
                                        ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT')}
                                    </div>
                                </div>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl bg-white/10 hover:bg-white/20 w-10 h-10 rounded-full flex items-center justify-center transition-colors">
                                √ó
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenuto -->
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        ${matchedClients.length > 0 ? `
                            <div class="space-y-4">
                                ${matchedClients.map(client => renderClientMatchCard(client, annuncio)).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 rounded-full mb-6">
                                    <span class="text-4xl">üòî</span>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Nessun cliente compatibile trovato</h3>
                                <p class="text-gray-500 max-w-md mx-auto">
                                    Questo annuncio non corrisponde alle preferenze dei clienti registrati.
                                    Modifica i criteri o aggiungi nuovi clienti.
                                </p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Footer -->
                    <div class="border-t border-gray-200 p-6 bg-gray-50">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div>
                                <p class="text-gray-600 text-sm">
                                    <span class="font-medium">${matchedClients.length}</span> clienti compatibili trovati
                                </p>
                                ${matchedClients.length > 0 ? `
                                <p class="text-xs text-gray-500 mt-1">
                                    Match basato su: tipologia, comune, budget e preferenze
                                </p>
                                ` : ''}
                            </div>
                            <div class="flex gap-3">
                                ${matchedClients.length > 0 ? `
                                <button onclick="exportMatchesToPDF(${annuncio.id})" 
                                        class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow flex items-center gap-2">
                                    üìÑ Esporta Report
                                </button>
                                ` : ''}
                                <button onclick="closeModal()" 
                                        class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                    Chiudi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            // Aggiungi listener per chiudere cliccando sull'overlay
            setTimeout(() => {
                const overlay = document.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.onclick = (e) => {
                        if (e.target === overlay) closeModal();
                    };
                }
            }, 100);
        }

        function renderClientMatchCard(client, annuncio) {
            const matchScore = calculateMatchScore(client, annuncio);
            const budgetDiff = annuncio.prezzo - client.budget;
            const matchColor = matchScore >= 80 ? 'green' : matchScore >= 60 ? 'yellow' : 'red';
            const matchColors = {
                green: { bg: 'from-green-50 to-emerald-50', border: 'border-green-200', text: 'text-green-800' },
                yellow: { bg: 'from-yellow-50 to-amber-50', border: 'border-yellow-200', text: 'text-yellow-800' },
                red: { bg: 'from-red-50 to-pink-50', border: 'border-red-200', text: 'text-red-800' }
            };
            
            return `
            <div class="bg-gradient-to-br ${matchColors[matchColor].bg} border ${matchColors[matchColor].border} rounded-xl p-5 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-white rounded-xl border ${matchColors[matchColor].border} flex items-center justify-center shadow-sm">
                            <span class="text-2xl">üë§</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg">${client.name}</h4>
                            <p class="text-sm text-gray-600">${client.email}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-4 py-2 rounded-full text-sm font-bold ${matchColors[matchColor].text} bg-white border ${matchColors[matchColor].border}">
                            ${matchScore}% Match
                        </span>
                        <p class="text-xs text-gray-500 mt-1">Compatibilit√†</p>
                    </div>
                </div>
                
                <div class="space-y-3 mb-4">
                    <!-- Budget -->
                    <div class="flex items-center justify-between bg-white/70 p-3 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-700">üí∞ Budget cliente:</span>
                        </div>
                        <span class="font-bold ${budgetDiff <= 0 ? 'text-green-600' : 'text-red-600'}">
                            ‚Ç¨${client.budget.toLocaleString('it-IT')} 
                            ${budgetDiff <= 0 ? 
                                '<span class="text-green-500 text-sm">‚úì Nel budget</span>' : 
                                `<span class="text-red-500 text-sm">+‚Ç¨${Math.abs(budgetDiff).toLocaleString('it-IT')}</span>`
                            }
                        </span>
                    </div>
                    
                    <!-- Preferenze match -->
                    <div class="bg-white/70 p-3 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-700 mb-2">‚úÖ Preferenze corrispondenti:</p>
                        <div class="flex flex-wrap gap-1.5">
                            ${client.preferenze
                                .filter(pref => 
                                    annuncio.tipologia.includes(pref) || 
                                    annuncio.comune.includes(pref) ||
                                    pref.includes(annuncio.tipologia) ||
                                    pref.includes(annuncio.comune)
                                )
                                .map(pref => `
                                    <span class="bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 text-xs px-3 py-1.5 rounded-lg border border-green-200 flex items-center gap-1">
                                        <span class="text-xs">‚úì</span> ${pref}
                                    </span>
                                `).join('')}
                            ${client.preferenze
                                .filter(pref => 
                                    !annuncio.tipologia.includes(pref) && 
                                    !annuncio.comune.includes(pref) &&
                                    !pref.includes(annuncio.tipologia) &&
                                    !pref.includes(annuncio.comune)
                                )
                                .slice(0, 2)
                                .map(pref => `
                                    <span class="bg-gray-100 text-gray-600 text-xs px-3 py-1.5 rounded-lg border border-gray-200">
                                        ${pref}
                                    </span>
                                `).join('')}
                        </div>
                    </div>
                    
                    <!-- Note -->
                    <div class="bg-white/70 p-3 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-600 italic">"${client.note}"</p>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button 
                        onclick="sendProposalToClient('${client.id}', ${annuncio.id})"
                        class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-3 rounded-lg transition-all shadow hover:shadow-lg font-medium flex items-center justify-center gap-2"
                    >
                        <span>üìß</span>
                        <span>Invia Proposta al Cliente</span>
                    </button>
                </div>
            </div>
            `;
        }

        // Funzioni di supporto
        function getSourceColorClass(site) {
            const siteObj = SITES.find(s => s.name === site);
            if (!siteObj) return 'bg-gray-100 text-gray-800 hover:bg-gray-200';
            return `bg-${siteObj.color}-100 text-${siteObj.color}-800 hover:bg-${siteObj.color}-200`;
        }

        function getSourceIcon(site) {
            const siteObj = SITES.find(s => s.name === site);
            return siteObj ? siteObj.icon : 'üîó';
        }

        function getPropertyIcon(tipologia) {
            const icons = {
                'Appartamento': 'üè†',
                'Villa': 'üè°',
                'Attico': 'üè¢',
                'Loft': 'üè≠',
                'Garage': 'üöó',
                'Terreno': 'üå≥'
            };
            return icons[tipologia] || 'üèòÔ∏è';
        }

        function getTopComune() {
            const comuniCount = {};
            state.clients.forEach(client => {
                client.preferenze.forEach(pref => {
                    if (Object.keys(coordinateComuni).includes(pref)) {
                        comuniCount[pref] = (comuniCount[pref] || 0) + 1;
                    }
                });
            });
            
            const top = Object.entries(comuniCount).sort((a, b) => b[1] - a[1])[0];
            return top ? top[0] : 'Nessuno';
        }

        function calculateMatchScore(client, annuncio) {
            let score = 0;
            
            // Match tipologia (40%)
            if (client.preferenze.some(p => annuncio.tipologia.includes(p) || p.includes(annuncio.tipologia))) {
                score += 40;
            }
            
            // Match comune (30%)
            if (client.preferenze.some(p => annuncio.comune.includes(p) || p.includes(annuncio.comune))) {
                score += 30;
            }
            
            // Match budget (30%)
            const budgetDiff = annuncio.prezzo - client.budget;
            if (budgetDiff <= 0) {
                score += 30; // Nel budget
            } else if (budgetDiff <= client.budget * 0.2) {
                score += 20; // 20% sopra budget
            } else if (budgetDiff <= client.budget * 0.5) {
                score += 10; // 50% sopra budget
            }
            
            return Math.min(100, Math.round(score));
        }

        function findMatchingClients(annuncio) {
            return state.clients
                .map(client => ({
                    client,
                    score: calculateMatchScore(client, annuncio)
                }))
                .filter(item => item.score >= 50)
                .sort((a, b) => b.score - a.score)
                .map(item => item.client);
        }

        // Funzioni principali
        function attachEventListeners() {
            // Login
            const loginBtn = document.getElementById('login-btn');
            const passwordInput = document.getElementById('password-input');
            const togglePassword = document.getElementById('toggle-password');
            
            if (loginBtn) loginBtn.onclick = handleLogin;
            if (passwordInput) {
                passwordInput.oninput = (e) => state.password = e.target.value;
                passwordInput.onkeypress = (e) => { if (e.key === 'Enter') handleLogin(); };
            }
            if (togglePassword) {
                togglePassword.onclick = () => {
                    state.showPassword = !state.showPassword;
                    render();
                };
            }
            
            // Main app
            const logoutBtn = document.getElementById('logout-btn');
            const tabSearch = document.getElementById('tab-search');
            const tabClients = document.getElementById('tab-clients');
            const searchBtn = document.getElementById('search-btn');
            
            if (logoutBtn) logoutBtn.onclick = handleLogout;
            if (tabSearch) tabSearch.onclick = () => { 
                state.activeTab = 'search'; 
                state.showClientSuggestions = false;
                state.selectedAnnuncio = null;
                render(); 
            };
            if (tabClients) tabClients.onclick = () => { 
                state.activeTab = 'clients'; 
                state.showClientSuggestions = false;
                state.selectedAnnuncio = null;
                render(); 
            };
            if (searchBtn) searchBtn.onclick = performSearch;
            
            // Filters
            const filterComune = document.getElementById('filter-comune');
            const filterTipologia = document.getElementById('filter-tipologia');
            const filterPrezzoMin = document.getElementById('filter-prezzo-min');
            const filterPrezzoMax = document.getElementById('filter-prezzo-max');
            
            if (filterComune) filterComune.oninput = (e) => { state.filters.comune = e.target.value; };
            if (filterTipologia) filterTipologia.onchange = (e) => { state.filters.tipologia = e.target.value; };
            if (filterPrezzoMin) filterPrezzoMin.oninput = (e) => { state.filters.prezzoMin = e.target.value; };
            if (filterPrezzoMax) filterPrezzoMax.oninput = (e) => { state.filters.prezzoMax = e.target.value; };
        }

        function handleLogin() {
            if (state.password === MASTER_PASSWORD) {
                state.isAuthenticated = true;
                state.password = '';
                render();
            } else {
                alert('Password non corretta. Usa: aste2025');
            }
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.searchResults = [];
            state.showClientSuggestions = false;
            state.selectedAnnuncio = null;
            render();
        }

        function performSearch() {
            console.log("üîç AVVIO RICERCA AVANZATA");
            state.isLoading = true;
            state.searchStatus = 'Ricerca in corso su 7 portali...';
            render();
            
            // Simula ricerca asincrona
            setTimeout(() => {
                // Genera dati mock con deduplicazione
                const rawResults = generateMockResults();
                
                // Deduplica risultati (stesso comune, indirizzo, prezzo e data asta)
                const deduplicatedResults = deduplicateResults(rawResults);
                
                state.searchResults = deduplicatedResults;
                state.isLoading = false;
                state.searchStatus = `‚úÖ Trovati ${deduplicatedResults.length} annunci univoci (da ${rawResults.length} totali)`;
                render();
                
                // Inizializza mappa
                initMap();
            }, 1500);
        }

        function generateMockResults() {
            const comuneFiltro = state.filters.comune || '';
            const tipologiaFiltro = state.filters.tipologia || '';
            const prezzoMin = parseInt(state.filters.prezzoMin) || 0;
            const prezzoMax = parseInt(state.filters.prezzoMax) || 10000000;
            
            const comuni = comuneFiltro ? [comuneFiltro] : Object.keys(coordinateComuni);
            const tipologie = tipologiaFiltro ? [tipologiaFiltro] : ['Appartamento', 'Villa', 'Attico', 'Garage', 'Terreno'];
            
            const caratteristiche = [
                'Con giardino privato', 'Box auto incluso', 'In centro storico', 
                'Zona residenziale tranquilla', 'Vista panoramica', 'Con piscina',
                'A due passi dal mare', 'Con ampio terrazzo', 'Recentemente ristrutturato',
                'Classe energetica A4', 'Con cantina', 'Doppi servizi', 'Impianto fotovoltaico'
            ];
            
            const condizioni = [
                'Ottime condizioni', 'Da ristrutturare completamente', 'Nuovo di costruzione',
                'Parzialmente ristrutturato', 'Libero immediatamente', 'In classe A',
                'Con certificazione energetica', 'Pronto per abitare'
            ];
            
            const results = [];
            const numResults = Math.floor(Math.random() * 15) + 10; // 10-25 risultati
            
            for (let i = 0; i < numResults; i++) {
                const comune = comuni[Math.floor(Math.random() * comuni.length)];
                const tipologia = tipologie[Math.floor(Math.random() * tipologie.length)];
                const prezzo = Math.floor(Math.random() * (prezzoMax - prezzoMin)) + prezzoMin;
                
                if (prezzo < prezzoMin || prezzo > prezzoMax) continue;
                
                // Genera 1-3 fonti diverse per lo stesso annuncio
                const numSources = Math.floor(Math.random() * 3) + 1;
                const shuffledSites = [...SITES].sort(() => Math.random() - 0.5);
                const sources = shuffledSites.slice(0, numSources).map(site => ({
                    site: site.name,
                    url: `https://${site.name.toLowerCase().replace('.it', '').replace(' ', '')}.it/annuncio-${Math.floor(Math.random() * 10000)}`
                }));
                
                // Crea chiave unica per deduplicazione
                const uniqueKey = `${comune}_${tipologia}_${Math.floor(prezzo / 10000) * 10000}`;
                
                results.push({
                    id: i + 1,
                    tipologia: tipologia,
                    indirizzo: `Via ${['Roma', 'Milano', 'Venezia', 'Garibaldi', 'Dante', 'Vittorio Emanuele'][Math.floor(Math.random() * 6)]} ${Math.floor(Math.random() * 200) + 1}`,
                    comune: comune,
                    prezzo: prezzo,
                    descrizione: `${tipologia} di ${Math.floor(Math.random() * 300) + 50} mq a ${comune}, ${condizioni[Math.floor(Math.random() * condizioni.length)]}. ${caratteristiche[Math.floor(Math.random() * caratteristiche.length)]}. Posizione ${['centrale', 'periferica', 'residenziale', 'commerciale'][Math.floor(Math.random() * 4)]}.`,
                    dataAsta: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    fonte: sources[0].site,
                    sources: sources,
                    link: sources[0].url,
                    metriQuadrati: Math.floor(Math.random() * 300) + 50,
                    locali: Math.floor(Math.random() * 6) + 1,
                    uniqueKey: uniqueKey,
                    coordinate: coordinateComuni[comune] || MAP_CENTER
                });
            }
            
            return results;
        }

        function deduplicateResults(results) {
            const seen = new Set();
            const deduplicated = [];
            
            for (const result of results) {
                // Crea una chiave basata su: comune, indirizzo approssimato, prezzo simile (¬±10%), data asta
                const key = `${result.comune}_${result.indirizzo.split(' ')[0]}_${Math.floor(result.prezzo / 10000)}_${result.dataAsta}`;
                
                if (!seen.has(key)) {
                    seen.add(key);
                    deduplicated.push(result);
                } else {
                    // Se duplicato, aggiungi la fonte alla versione esistente
                    const existing = deduplicated.find(r => 
                        `${r.comune}_${r.indirizzo.split(' ')[0]}_${Math.floor(r.prezzo / 10000)}_${r.dataAsta}` === key
                    );
                    if (existing && result.sources) {
                        result.sources.forEach(source => {
                            if (!existing.sources.some(s => s.site === source.site)) {
                                existing.sources.push(source);
                            }
                        });
                    }
                }
            }
            
            return deduplicated;
        }

        function initMap() {
            if (map) {
                map.remove();
            }
            
            map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Aggiungi marker per ogni annuncio
            state.searchResults.forEach(result => {
                if (result.coordinate) {
                    const marker = L.marker(result.coordinate).addTo(map);
                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${result.tipologia}</strong><br>
                            <small>${result.indirizzo}, ${result.comune}</small><br>
                            <strong>‚Ç¨${result.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong><br>
                            <small>Asta: ${result.dataAsta}</small><br>
                            <button onclick="showAnnuncioDetails(${result.id})" 
                                    style="margin-top: 5px; padding: 5px 10px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Dettagli
                            </button>
                        </div>
                    `);
                }
            });
            
            // Adatta la vista ai marker
            if (state.searchResults.length > 0) {
                const bounds = L.latLngBounds(state.searchResults.map(r => r.coordinate).filter(c => c));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Funzioni di interazione
        function showAnnuncioDetails(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            const sourcesList = annuncio.sources ? annuncio.sources.map(s => 
                `<li><button onclick="window.open('${s.url}', '_blank')" class="text-blue-600 hover:text-blue-800">${s.site}</button></li>`
            ).join('') : `<li>${annuncio.fonte}</li>`;
            
            const details = `
üìã <strong>DETTAGLI COMPLETI ANNUNCIO</strong>

üè† <strong>Tipologia:</strong> ${annuncio.tipologia}
üìç <strong>Indirizzo:</strong> ${annuncio.indirizzo}, ${annuncio.comune}
üí∞ <strong>Prezzo base d'asta:</strong> ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}
üìè <strong>Metratura:</strong> ${annuncio.metriQuadrati} m¬≤
üö™ <strong>Locali:</strong> ${annuncio.locali}
üè∑Ô∏è <strong>Prezzo al m¬≤:</strong> ‚Ç¨${(annuncio.prezzo / annuncio.metriQuadrati).toFixed(2)}
üìÖ <strong>Data asta:</strong> ${annuncio.dataAsta}

üìù <strong>Descrizione:</strong>
${annuncio.descrizione}

üîó <strong>Disponibile su:</strong>
${annuncio.sources ? annuncio.sources.map(s => `‚Ä¢ ${s.site}: ${s.url}`).join('\n') : annuncio.fonte}
            `;
            
            alert(details);
        }

        function showClientSuggestions(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            state.selectedAnnuncio = annuncio;
            state.showClientSuggestions = true;
            render();
        }

        function closeModal() {
            state.showClientSuggestions = false;
            state.selectedAnnuncio = null;
            render();
        }

        function openSourceLink(annuncioId, sourceIndex) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (annuncio && annuncio.sources && annuncio.sources[sourceIndex]) {
                window.open(annuncio.sources[sourceIndex].url, '_blank');
            }
        }

        function exportAnnuncioToPDF(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Titolo
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text('SCHEDA ANNUNCIO ASTA IMMOBILIARE', 105, 20, { align: 'center' });
            
            // Linea separatrice
            doc.setDrawColor(79, 70, 229);
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);
            
            // Dettagli annuncio
            doc.setFontSize(12);
            let y = 35;
            
            doc.setFont(undefined, 'bold');
            doc.text('Dettagli Immobile:', 20, y);
            doc.setFont(undefined, 'normal');
            y += 8;
            
            const details = [
                `Tipologia: ${annuncio.tipologia}`,
                `Indirizzo: ${annuncio.indirizzo}, ${annuncio.comune}`,
                `Prezzo base d'asta: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}`,
                `Metratura: ${annuncio.metriQuadrati} m¬≤`,
                `Locali: ${annuncio.locali}`,
                `Prezzo al m¬≤: ‚Ç¨${(annuncio.prezzo / annuncio.metriQuadrati).toFixed(2)}`,
                `Data asta: ${annuncio.dataAsta}`
            ];
            
            details.forEach(detail => {
                doc.text(detail, 25, y);
                y += 7;
            });
            
            y += 5;
            
            // Descrizione
            doc.setFont(undefined, 'bold');
            doc.text('Descrizione:', 20, y);
            doc.setFont(undefined, 'normal');
            y += 8;
            
            const descLines = doc.splitTextToSize(annuncio.descrizione, 170);
            doc.text(descLines, 25, y);
            y += descLines.length * 7 + 5;
            
            // Fonti
            if (annuncio.sources && annuncio.sources.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('Disponibile su:', 20, y);
                doc.setFont(undefined, 'normal');
                y += 8;
                
                annuncio.sources.forEach((source, idx) => {
                    doc.text(`${idx + 1}. ${source.site}: ${source.url}`, 25, y);
                    y += 7;
                });
            }
            
            // Data generazione
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} - Piattaforma Aste Immobiliari`, 105, 280, { align: 'center' });
            
            // Salva PDF
            doc.save(`annuncio-${annuncio.comune}-${annuncio.tipologia}-${annuncio.dataAsta}.pdf`);
            
            alert('‚úÖ PDF generato con successo!');
        }

        function exportAllToPDF() {
            if (state.searchResults.length === 0) {
                alert('Nessun annuncio da esportare');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            
            // Titolo
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text('REPORT COMPLETO ANNUNCI ASTA IMMOBILIARE', 105, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} - ${state.searchResults.length} annunci trovati`, 105, y, { align: 'center' });
            y += 15;
            
            // Per ogni annuncio
            state.searchResults.forEach((annuncio, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                // Titolo annuncio
                doc.setFontSize(12);
                doc.setTextColor(79, 70, 229);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${annuncio.tipologia} - ${annuncio.comune}`, 20, y);
                y += 7;
                
                // Dettagli
                doc.setFontSize(10);
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'normal');
                
                doc.text(`Indirizzo: ${annuncio.indirizzo}`, 25, y);
                y += 5;
                doc.text(`Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})} | m¬≤: ${annuncio.metriQuadrati} | Locali: ${annuncio.locali}`, 25, y);
                y += 5;
                doc.text(`Data asta: ${annuncio.dataAsta}`, 25, y);
                y += 5;
                
                // Fonti
                if (annuncio.sources && annuncio.sources.length > 0) {
                    const fonti = annuncio.sources.map(s => s.site).join(', ');
                    doc.text(`Fonti: ${fonti}`, 25, y);
                    y += 5;
                }
                
                y += 5;
                
                // Separatore
                if (index < state.searchResults.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(20, y, 190, y);
                    y += 8;
                }
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Piattaforma Aste Immobiliari - Sistema di monitoraggio avanzato', 105, 285, { align: 'center' });
            
            doc.save(`report-completo-aste-${new Date().toISOString().split('T')[0]}.pdf`);
            alert(`‚úÖ Report PDF generato con ${state.searchResults.length} annunci!`);
        }

        function exportMatchesToPDF(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            const matchedClients = findMatchingClients(annuncio);
            if (matchedClients.length === 0) {
                alert('Nessun cliente compatibile da esportare');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            
            // Titolo
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text('REPORT CLIENTI COMPATIBILI', 105, y, { align: 'center' });
            y += 8;
            
            // Dettagli annuncio
            doc.setFontSize(12);
            doc.setTextColor(79, 70, 229);
            doc.text(`${annuncio.tipologia} - ${annuncio.comune}`, 105, y, { align: 'center' });
            y += 6;
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT')} | Data asta: ${annuncio.dataAsta}`, 105, y, { align: 'center' });
            y += 15;
            
            // Per ogni cliente
            matchedClients.forEach((client, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                const matchScore = calculateMatchScore(client, annuncio);
                const budgetDiff = annuncio.prezzo - client.budget;
                
                // Nome cliente e match score
                doc.setFontSize(12);
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${client.name} - ${matchScore}% Match`, 20, y);
                y += 7;
                
                // Dettagli cliente
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Email: ${client.email}`, 25, y);
                y += 5;
                doc.text(`Budget: ‚Ç¨${client.budget.toLocaleString('it-IT')} ${budgetDiff <= 0 ? '(Nel budget ‚úì)' : `(+‚Ç¨${Math.abs(budgetDiff).toLocaleString('it-IT')})`}`, 25, y);
                y += 5;
                
                // Preferenze
                const matchingPrefs = client.preferenze.filter(pref => 
                    annuncio.tipologia.includes(pref) || 
                    annuncio.comune.includes(pref) ||
                    pref.includes(annuncio.tipologia) ||
                    pref.includes(annuncio.comune)
                );
                
                if (matchingPrefs.length > 0) {
                    doc.text(`Preferenze match: ${matchingPrefs.join(', ')}`, 25, y);
                    y += 5;
                }
                
                // Note
                doc.text(`Note: "${client.note}"`, 25, y);
                y += 7;
                
                // Separatore
                if (index < matchedClients.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(20, y, 190, y);
                    y += 10;
                }
            });
            
            // Footer
            y += 10;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Report generato il ${new Date().toLocaleDateString('it-IT')} - ${matchedClients.length} clienti compatibili trovati`, 105, 285, { align: 'center' });
            
            doc.save(`clienti-compatibili-${annuncio.comune}-${annuncio.tipologia}.pdf`);
            alert(`‚úÖ Report clienti compatibili esportato!`);
        }

        function sendProposalToClient(clientId, annuncioId) {
            const client = state.clients.find(c => c.id === clientId);
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            
            if (!client || !annuncio) return;
            
            const matchScore = calculateMatchScore(client, annuncio);
            const subject = encodeURIComponent(`Proposta immobile a ${annuncio.comune} - ${annuncio.tipologia}`);
            const body = encodeURIComponent(`Gentile ${client.name},\n\nAbbiamo individuato un immobile che potrebbe interessarti:\n\n‚Ä¢ Tipologia: ${annuncio.tipologia}\n‚Ä¢ Indirizzo: ${annuncio.indirizzo}, ${annuncio.comune}\n‚Ä¢ Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT')}\n‚Ä¢ Metratura: ${annuncio.metriQuadrati} m¬≤\n‚Ä¢ Data asta: ${annuncio.dataAsta}\n\nCompatibilit√† con le tue preferenze: ${matchScore}%\n\nCordiali saluti,\nIl tuo agente immobiliare`);
            
            window.open(`mailto:${client.email}?subject=${subject}&body=${body}`, '_blank');
        }

        function viewClientMatches(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Filtra annunci compatibili per questo cliente
            const compatibleAnnunci = state.searchResults.filter(annuncio => 
                calculateMatchScore(client, annuncio) >= 50
            );
            
            if (compatibleAnnunci.length === 0) {
                alert(`Nessun annuncio compatibile trovato per ${client.name}`);
                return;
            }
            
            // Mostra lista annunci compatibili
            let message = `Annunci compatibili per ${client.name}:\n\n`;
            compatibleAnnunci.forEach((annuncio, idx) => {
                const score = calculateMatchScore(client, annuncio);
                message += `${idx + 1}. ${annuncio.tipologia} a ${annuncio.comune}\n   Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT')}\n   Match: ${score}%\n   Data asta: ${annuncio.dataAsta}\n\n`;
            });
            
            alert(message);
        }

        function addNewClient() {
            const name = prompt('Nome e cognome del cliente:');
            if (!name) return;
            
            const email = prompt('Email del cliente:');
            if (!email) return;
            
            const budget = parseFloat(prompt('Budget massimo (‚Ç¨):'));
            if (!budget || isNaN(budget)) return;
            
            const preferenze = prompt('Preferenze (separate da virgola, es: Milano, Appartamento, Centro):');
            if (!preferenze) return;
            
            const note = prompt('Note aggiuntive:') || '';
            
            const newClient = {
                id: Date.now().toString(),
                name: name,
                email: email,
                budget: budget,
                preferenze: preferenze.split(',').map(p => p.trim()),
                note: note
            };
            
            state.clients.push(newClient);
            alert(`‚úÖ Cliente "${name}" aggiunto con successo!`);
            render();
        }

        function editClient(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;
            
            const newName = prompt('Modifica nome:', client.name);
            if (newName) client.name = newName;
            
            const newEmail = prompt('Modifica email:', client.email);
            if (newEmail) client.email = newEmail;
            
            const newBudget = parseFloat(prompt('Modifica budget:', client.budget));
            if (newBudget && !isNaN(newBudget)) client.budget = newBudget;
            
            const newPreferenze = prompt('Modifica preferenze (separate da virgola):', client.preferenze.join(', '));
            if (newPreferenze) client.preferenze = newPreferenze.split(',').map(p => p.trim());
            
            const newNote = prompt('Modifica note:', client.note);
            if (newNote !== null) client.note = newNote;
            
            alert('‚úÖ Cliente modificato con successo!');
            render();
        }

        function loadMoreResults() {
            // Simula caricamento di altri risultati
            state.isLoading = true;
            render();
            
            setTimeout(() => {
                const newResults = generateMockResults();
                const deduplicatedNew = deduplicateResults([...state.searchResults, ...newResults]);
                state.searchResults = deduplicatedNew;
                state.isLoading = false;
                state.searchStatus = `‚úÖ Totale: ${deduplicatedNew.length} annunci`;
                render();
                
                // Aggiorna mappa
                initMap();
            }, 1000);
        }

        // Inizializza app
        render();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma Aste Immobiliari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Configurazione
        const MASTER_PASSWORD = 'aste2025';

        // State globale
        let state = {
            isAuthenticated: false,
            password: '',
            showPassword: false,
            activeTab: 'search',
            isLoading: false,
            searchStatus: '',
            filters: { comune: '', tipologia: '', prezzoMin: '', prezzoMax: '' },
            clients: [
                { id: '1', name: 'Mario Rossi', email: 'mario@email.com', comunnes: ['Milano', 'Roma'] },
                { id: '2', name: 'Laura Bianchi', email: 'laura@email.com', comunnes: ['Torino'] }
            ],
            searchResults: [],
            clientMatches: []
        };

        // Render app
        function render() {
            const app = document.getElementById('app');
            if (!state.isAuthenticated) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMain();
            }
            attachEventListeners();
        }

        function renderLogin() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <div class="flex items-center justify-center mb-6">
                        <svg class="w-12 h-12 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">
                        Piattaforma Aste Immobiliari
                    </h1>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password di accesso</label>
                        <div class="relative">
                            <input
                                type="${state.showPassword ? 'text' : 'password'}"
                                id="password-input"
                                value="${state.password}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Inserisci password"
                            />
                            <button
                                id="toggle-password"
                                type="button"
                                class="absolute right-3 top-2.5 text-gray-500"
                            >
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    <button
                        id="login-btn"
                        class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                    >
                        Accedi
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-4">Solo per uso interno autorizzato</p>
                </div>
            </div>
            `;
        }

        function renderMain() {
            return `
            <div class="min-h-screen bg-gray-50">
                <!-- Header -->
                <div class="bg-indigo-600 text-white shadow-lg">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold">Monitoraggio Aste Giudiziarie</h1>
                                <p class="text-xs text-indigo-200">Server: üü¢ Demo Mode ‚Ä¢ Dati Mock Attivi</p>
                            </div>
                            <button id="logout-btn" class="bg-indigo-700 hover:bg-indigo-800 px-4 py-2 rounded-lg">
                                Esci
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white border-b">
                    <div class="max-w-7xl mx-auto px-4">
                        <div class="flex space-x-8">
                            <button
                                id="tab-search"
                                class="py-4 px-2 border-b-2 font-medium ${state.activeTab === 'search' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'}"
                            >
                                üîç Ricerca Istantanea
                            </button>
                            <button
                                id="tab-clients"
                                class="py-4 px-2 border-b-2 font-medium ${state.activeTab === 'clients' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'}"
                            >
                                üë• Monitoraggio Clienti (${state.clients.length})
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="max-w-7xl mx-auto px-4 py-6">
                    ${state.activeTab === 'search' ? renderSearchTab() : renderClientsTab()}
                </div>
            </div>
            `;
        }

        function renderSearchTab() {
            return `
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">üîç Filtri di Ricerca</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input
                            id="filter-comune"
                            type="text"
                            placeholder="Comune"
                            value="${state.filters.comune}"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                        <select
                            id="filter-tipologia"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        >
                            <option value="">Tutte le tipologie</option>
                            <option value="Appartamento" ${state.filters.tipologia === 'Appartamento' ? 'selected' : ''}>Appartamento</option>
                            <option value="Villa" ${state.filters.tipologia === 'Villa' ? 'selected' : ''}>Villa</option>
                            <option value="Attico" ${state.filters.tipologia === 'Attico' ? 'selected' : ''}>Attico</option>
                            <option value="Loft" ${state.filters.tipologia === 'Loft' ? 'selected' : ''}>Loft</option>
                            <option value="Garage" ${state.filters.tipologia === 'Garage' ? 'selected' : ''}>Garage</option>
                            <option value="Terreno" ${state.filters.tipologia === 'Terreno' ? 'selected' : ''}>Terreno</option>
                        </select>
                        <input
                            id="filter-prezzo-min"
                            type="number"
                            placeholder="Prezzo minimo (‚Ç¨)"
                            value="${state.filters.prezzoMin}"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                        <input
                            id="filter-prezzo-max"
                            type="number"
                            placeholder="Prezzo massimo (‚Ç¨)"
                            value="${state.filters.prezzoMax}"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                        <button
                            id="search-btn"
                            ${state.isLoading ? 'disabled' : ''}
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors ${state.isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                        >
                            ${state.isLoading ? '‚è≥ Ricerca...' : 'üîÑ Aggiorna'}
                        </button>
                    </div>
                    ${state.searchStatus ? `<p class="mt-3 text-sm text-indigo-600">‚ÑπÔ∏è ${state.searchStatus}</p>` : ''}
                    <p class="text-sm text-gray-500 mt-3">Monitoraggio demo su 7 portali di aste</p>
                </div>

                ${state.searchResults.length > 0 ? `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Trovati ${state.searchResults.length} risultati</h3>
                        <button 
                            onclick="exportToCSV()"
                            class="text-sm bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
                        >
                            üìä Esporta CSV
                        </button>
                    </div>
                    ${state.searchResults.map(r => renderResultCard(r)).join('')}
                </div>
                ` : !state.isLoading ? `
                <div class="bg-white rounded-lg shadow p-12 text-center">
                    <div class="text-gray-400 mb-4">
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <p class="text-gray-500">Clicca "Aggiorna" per iniziare la ricerca con dati demo</p>
                    <p class="text-sm text-gray-400 mt-2">Password demo: aste2025</p>
                </div>
                ` : ''}
            </div>
            `;
        }

        function renderClientsTab() {
            return `
            <div class="space-y-6">
                <!-- Aggiungi nuovo cliente -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">‚ûï Aggiungi nuovo cliente</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input 
                            id="client-name" 
                            type="text" 
                            placeholder="Nome cliente"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                        <input 
                            id="client-email" 
                            type="email" 
                            placeholder="Email"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                        <input 
                            id="client-comune" 
                            type="text" 
                            placeholder="Comune interesse"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                    </div>
                    <button 
                        id="add-client-btn"
                        class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors"
                    >
                        Aggiungi cliente
                    </button>
                </div>
                
                <!-- Lista clienti -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üìã Clienti registrati (${state.clients.length})</h3>
                    
                    ${state.clients.length > 0 ? `
                        <div class="space-y-3">
                            ${state.clients.map(client => `
                                <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h4 class="font-medium text-gray-800">${client.name}</h4>
                                            <p class="text-sm text-gray-600">${client.email}</p>
                                            <p class="text-sm text-gray-500 mt-1">Comuni: ${client.comunes.join(', ')}</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button 
                                                onclick="editClient('${client.id}')"
                                                class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 border border-blue-300 rounded"
                                            >
                                                ‚úèÔ∏è Modifica
                                            </button>
                                            <button 
                                                onclick="deleteClient('${client.id}')"
                                                class="text-red-600 hover:text-red-800 text-sm px-3 py-1 border border-red-300 rounded"
                                            >
                                                ‚ùå Rimuovi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <p class="text-gray-500 text-center py-8">Nessun cliente registrato. Aggiungine uno!</p>
                    `}
                </div>
                
                <!-- Match con risultati -->
                ${state.clientMatches.length > 0 ? `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">üéØ Annunci compatibili con clienti</h3>
                        <div class="space-y-4">
                            ${state.clientMatches.slice(0, 5).map(match => `
                                <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded">
                                    <div class="flex justify-between">
                                        <div>
                                            <p class="font-medium text-gray-800">${match.clientName}</p>
                                            <p class="text-sm text-gray-600">${match.annuncio}</p>
                                        </div>
                                        <span class="text-xs text-gray-500">${match.data}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">üéØ Annunci compatibili</h3>
                        <p class="text-gray-500 text-center py-8">Nessun match trovato. Esegui una ricerca per trovare annunci compatibili con i clienti.</p>
                    </div>
                `}
            </div>
            `;
        }

        function renderResultCard(result) {
            const prezzoPerMq = Math.round(result.prezzo / result.metriQuadrati);
            
            return `
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow border-l-4 border-indigo-500">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-xl font-semibold text-gray-800">${result.tipologia}</h3>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${result.metriQuadrati} m¬≤</span>
                            <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded">${result.locali} locali</span>
                        </div>
                        <p class="text-gray-600">
                            üìç ${result.indirizzo}, ${result.comune}
                        </p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                ${result.fonte}
                            </span>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                üè∑Ô∏è ‚Ç¨${prezzoPerMq}/m¬≤
                            </span>
                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                üìÖ ${result.dataAsta}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="bg-indigo-100 text-indigo-800 px-3 py-2 rounded-lg text-lg font-bold block">
                            ‚Ç¨${result.prezzo.toLocaleString('it-IT')}
                        </span>
                        <p class="text-xs text-gray-500 mt-1">Prezzo base d'asta</p>
                    </div>
                </div>
                
                <p class="text-gray-600 mb-4 line-clamp-2">${result.descrizione}</p>
                
                <div class="flex justify-between items-center">
                    <div class="flex gap-2">
                        <button 
                            onclick="saveToClients(${result.id})"
                            class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center gap-1 px-3 py-1 border border-indigo-300 rounded"
                        >
                            üíæ Salva per cliente
                        </button>
                        <button 
                            onclick="showDetails(${result.id})"
                            class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center gap-1 px-3 py-1 border border-gray-300 rounded"
                        >
                            üìÑ Dettagli
                        </button>
                    </div>
                    <a
                        href="${result.link}"
                        target="_blank"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center gap-2 transition-colors"
                    >
                        üîó Vai all'annuncio
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                </div>
            </div>
            `;
        }

        function attachEventListeners() {
            // Login
            const loginBtn = document.getElementById('login-btn');
            const passwordInput = document.getElementById('password-input');
            const togglePassword = document.getElementById('toggle-password');
            
            if (loginBtn) {
                loginBtn.onclick = handleLogin;
            }
            
            if (passwordInput) {
                passwordInput.oninput = (e) => {
                    state.password = e.target.value;
                };
                passwordInput.onkeypress = (e) => {
                    if (e.key === 'Enter') handleLogin();
                };
            }
            
            if (togglePassword) {
                togglePassword.onclick = () => {
                    state.showPassword = !state.showPassword;
                    render();
                };
            }
            
            // Main app
            const logoutBtn = document.getElementById('logout-btn');
            const tabSearch = document.getElementById('tab-search');
            const tabClients = document.getElementById('tab-clients');
            const searchBtn = document.getElementById('search-btn');
            
            if (logoutBtn) logoutBtn.onclick = handleLogout;
            if (tabSearch) tabSearch.onclick = () => { state.activeTab = 'search'; render(); };
            if (tabClients) tabClients.onclick = () => { state.activeTab = 'clients'; render(); };
            if (searchBtn) searchBtn.onclick = performSearch;
            
            // Filters
            const filterComune = document.getElementById('filter-comune');
            const filterTipologia = document.getElementById('filter-tipologia');
            const filterPrezzoMin = document.getElementById('filter-prezzo-min');
            const filterPrezzoMax = document.getElementById('filter-prezzo-max');
            
            if (filterComune) filterComune.oninput = (e) => { state.filters.comune = e.target.value; };
            if (filterTipologia) filterTipologia.onchange = (e) => { state.filters.tipologia = e.target.value; };
            if (filterPrezzoMin) filterPrezzoMin.oninput = (e) => { state.filters.prezzoMin = e.target.value; };
            if (filterPrezzoMax) filterPrezzoMax.oninput = (e) => { state.filters.prezzoMax = e.target.value; };
            
            // Clienti tab
            const addClientBtn = document.getElementById('add-client-btn');
            if (addClientBtn) {
                addClientBtn.onclick = () => {
                    const name = document.getElementById('client-name').value;
                    const email = document.getElementById('client-email').value;
                    const comune = document.getElementById('client-comune').value;
                    
                    if (name && email && comune) {
                        addClient(name, email, comune);
                        // Reset form
                        document.getElementById('client-name').value = '';
                        document.getElementById('client-email').value = '';
                        document.getElementById('client-comune').value = '';
                    } else {
                        alert('Compila tutti i campi per aggiungere un cliente');
                    }
                };
            }
        }

        function handleLogin() {
            if (state.password === MASTER_PASSWORD) {
                state.isAuthenticated = true;
                state.password = '';
                render();
            } else {
                alert('Password non corretta. Usa: aste2025');
            }
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.searchResults = [];
            render();
        }

        async function performSearch() {
            state.isLoading = true;
            state.searchStatus = 'üîç Ricerca in corso su 7 portali...';
            render();
            
            // SIMULA delay server (1-2 secondi) - NO chiamate reali!
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Genera dati MOCK locali
            const defaultComuni = [
                'Milano', 'Roma', 'Torino', 'Napoli', 'Firenze', 'Bologna', 'Genova',
                'Venezia', 'Verona', 'Padova', 'Bari', 'Palermo', 'Catania', 'Cagliari'
            ];
            
            const comuneCercato = state.filters.comune || '';
            const comuniUsare = comuneCercato ? [comuneCercato] : defaultComuni;
            
            const tipologie = ['Appartamento', 'Villa', 'Attico', 'Loft', 'Garage', 'Terreno'];
            const fonti = ['Immobiliare.it', 'Casa.it', 'Subito.it', 'Idealista', 'Bakeca', 'Astegiudiziarie.it', 'PortaleAste.it'];
            
            // Genera 10-20 risultati mock
            const numRisultati = Math.floor(Math.random() * 11) + 10;
            let risultati = [];
            
            for (let i = 0; i < numRisultati; i++) {
                const comune = comuniUsare[Math.floor(Math.random() * comuniUsare.length)];
                const tipologia = state.filters.tipologia || tipologie[Math.floor(Math.random() * tipologie.length)];
                const prezzo = Math.floor(Math.random() * 800000) + 50000;
                
                risultati.push({
                    id: i + 1,
                    tipologia: tipologia,
                    indirizzo: `Via ${['Roma', 'Milano', 'Venezia', 'Garibaldi', 'Dante'][Math.floor(Math.random() * 5)]} ${Math.floor(Math.random() * 200) + 1}`,
                    comune: comune,
                    prezzo: prezzo,
                    descrizione: `${tipologia} di ${Math.floor(Math.random() * 250) + 50} mq in ${comune}, ${['ristrutturato', 'nuovo', 'da ristrutturare'][Math.floor(Math.random() * 3)]}. Zona ${['centrale', 'residenziale', 'periferica'][Math.floor(Math.random() * 3)]}.`,
                    dataAsta: `2024-0${Math.floor(Math.random() * 9) + 1}-${Math.floor(Math.random() * 28) + 1}`,
                    fonte: fonti[Math.floor(Math.random() * fonti.length)],
                    link: `#annuncio-${i + 1}`,
                    metriQuadrati: Math.floor(Math.random() * 300) + 50,
                    locali: Math.floor(Math.random() * 6) + 1
                });
            }
            
            // Applica filtri
            if (state.filters.tipologia) {
                risultati = risultati.filter(r => 
                    r.tipologia.toLowerCase() === state.filters.tipologia.toLowerCase()
                );
            }
            
            if (state.filters.prezzoMin) {
                const prezzoMin = parseInt(state.filters.prezzoMin) || 0;
                risultati = risultati.filter(r => r.prezzo >= prezzoMin);
            }
            
            if (state.filters.prezzoMax) {
                const prezzoMax = parseInt(state.filters.prezzoMax) || 10000000;
                risultati = risultati.filter(r => r.prezzo <= prezzoMax);
            }
            
            // Se non ci sono risultati, creane alcuni di default
            if (risultati.length === 0) {
                for (let i = 0; i < 5; i++) {
                    risultati.push({
                        id: 100 + i,
                        tipologia: state.filters.tipologia || 'Appartamento',
                        indirizzo: `Via Esempio ${i + 1}`,
                        comune: comuneCercato || 'Milano',
                        prezzo: 200000 + (i * 50000),
                        descrizione: `Esempio di immobile in ${comuneCercato || 'Milano'}`,
                        dataAsta: '2024-04-15',
                        fonte: 'Demo System',
                        link: '#',
                        metriQuadrati: 80 + (i * 20),
                        locali: 2 + i
                    });
                }
                state.searchStatus = `‚úÖ 5 annunci demo`;
            } else {
                state.searchStatus = `‚úÖ Trovati ${risultati.length} annunci`;
            }
            
            state.searchResults = risultati;
            
            // Genera match con clienti
            state.clientMatches = [];
            if (risultati.length > 0 && state.clients.length > 0) {
                state.clients.forEach(client => {
                    const clientComuni = client.comunes.map(c => c.toLowerCase());
                    const annunciMatch = risultati.filter(r => 
                        clientComuni.includes(r.comune.toLowerCase())
                    );
                    
                    if (annunciMatch.length > 0) {
                        annunciMatch.slice(0, 2).forEach(annuncio => {
                            state.clientMatches.push({
                                id: Date.now() + Math.random(),
                                clientName: client.name,
                                annuncio: `${annuncio.tipologia} a ${annuncio.comune} (‚Ç¨${annuncio.prezzo.toLocaleString()})`,
                                data: new Date().toLocaleDateString('it-IT')
                            });
                        });
                    }
                });
            }
            
            state.isLoading = false;
            render();
        }

        // Funzione per salvare annuncio per cliente
        function saveToClients(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            if (state.clients.length > 0) {
                const clientNames = state.clients.map(c => c.name).join('\n');
                const clientName = prompt(`Per quale cliente vuoi salvare questo annuncio?\n\nClienti disponibili:\n${clientNames}\n\nScrivi il nome esatto:`, state.clients[0].name);
                
                if (clientName) {
                    state.clientMatches.unshift({
                        id: Date.now(),
                        clientName: clientName,
                        annuncio: annuncio.tipologia + ' - ' + annuncio.comune,
                        data: new Date().toLocaleDateString('it-IT')
                    });
                    
                    alert(`‚úÖ Annuncio "${annuncio.tipologia}" salvato per ${clientName}`);
                    render();
                }
            } else {
                alert('Aggiungi prima dei clienti nel tab "Monitoraggio Clienti"');
                state.activeTab = 'clients';
                render();
            }
        }

        // Funzione per aggiungere cliente
        function addClient(name, email, comune) {
            const newClient = {
                id: Date.now().toString(),
                name: name,
                email: email,
                comunnes: [comune]
            };
            
            state.clients.push(newClient);
            alert(`‚úÖ Cliente "${name}" aggiunto con successo!`);
            render();
        }

        // Funzione per modificare cliente
        function editClient(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;
            
            const newName = prompt('Modifica nome cliente:', client.name);
            if (newName) client.name = newName;
            
            const newEmail = prompt('Modifica email:', client.email);
            if (newEmail) client.email = newEmail;
            
            const newComunes = prompt('Modifica comuni (separati da virgola):', client.comunes.join(', '));
            if (newComunes) client.comunes = newComunes.split(',').map(c => c.trim());
            
            render();
        }

        // Funzione per rimuovere cliente
        function deleteClient(clientId) {
            if (confirm('Sei sicuro di voler rimuovere questo cliente?')) {
                state.clients = state.clients.filter(c => c.id !== clientId);
                state.clientMatches = state.clientMatches.filter(m => {
                    const client = state.clients.find(c => c.name === m.clientName);
                    return client !== undefined;
                });
                render();
            }
        }

        // Funzione per mostrare dettagli annuncio
        function showDetails(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            const details = `
üìã DETTAGLI ANNUNCIO

üè† Tipologia: ${annuncio.tipologia}
üìç Indirizzo: ${annuncio.indirizzo}, ${annuncio.comune}
üí∞ Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT')}
üìè Metratura: ${annuncio.metriQuadrati} m¬≤
üö™ Locali: ${annuncio.locali}
üè∑Ô∏è Prezzo al m¬≤: ‚Ç¨${Math.round(annuncio.prezzo / annuncio.metriQuadrati)}
üìÖ Data asta: ${annuncio.dataAsta}
üåê Fonte: ${annuncio.fonte}

üìù Descrizione:
${annuncio.descrizione}

üîó Link: ${annuncio.link}
            `;
            
            alert(details);
        }

        // Funzione per esportare in CSV
        function exportToCSV() {
            if (state.searchResults.length === 0) {
                alert('Nessun dato da esportare');
                return;
            }
            
            const headers = ['Tipologia', 'Indirizzo', 'Comune', 'Prezzo', 'm¬≤', 'Locali', 'Data Asta', 'Fonte', 'Link'];
            const rows = state.searchResults.map(r => [
                `"${r.tipologia}"`,
                `"${r.indirizzo}"`,
                `"${r.comune}"`,
                r.prezzo,
                r.metriQuadrati,
                r.locali,
                r.dataAsta,
                `"${r.fonte}"`,
                `"${r.link}"`
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `aste-immobiliari-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Esportati ${state.searchResults.length} annunci in formato CSV`);
        }

        // Inizializza app
        render();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma Aste Immobiliari - Gestione Clienti Brescia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        #map { height: 300px; width: 100%; border-radius: 0.5rem; }
        .leaflet-container { font-family: inherit; }
        .source-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            margin: 2px; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            cursor: pointer;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .client-row:hover { background-color: #f8fafc; }
        table { border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: white; z-index: 10; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-container"></div>

    <script>
        // Configurazione
        const MASTER_PASSWORD = 'aste2025';
        const MAP_CENTER = [45.5397, 10.2231]; // Brescia
        const MAP_ZOOM = 10;
        let map = null;

        // Mappa comuni -> zona (provincia di Brescia)
        const zoneComuni = {
            // Zona 1: CITT√Ä E HINTERLAND
            'Brescia': 1, 'Borgosatollo': 1, 'Botticino': 1, 'Bovezzo': 1, 'Calcinato': 1,
            'Capriano del Colle': 1, 'Castegnato': 1, 'Castel Mella': 1, 'Castenedolo': 1,
            'Castrezzato': 1, 'Cellatica': 1, 'Collebeato': 1, 'Concesio': 1, 'Flero': 1,
            'Gussago': 1, 'Mazzano': 1, 'Nave': 1, 'Nuvolento': 1, 'Nuvolera': 1,
            'Ospitaletto': 1, 'Poncarale': 1, 'Rezzato': 1, 'Roncadelle': 1, 'San Zeno Naviglio': 1,
            'Torbole Casaglia': 1,
            
            // Zona 7: BASSA BRESCIANA (Barbariga, etc.)
            'Barbariga': 7, 'Acquafredda': 7, 'Azzano Mella': 7, 'Bagnolo Mella': 7,
            'Bassano Bresciano': 7, 'Berlingo': 7, 'Borgo San Giacomo': 7, 'Brandico': 7,
            'Calvisano': 7, 'Carpenedolo': 7, 'Castelcovati': 7, 'Chiari': 7,
            'Cigole': 7, 'Comezzano-Cizzago': 7, 'Corzano': 7, 'Dello': 7,
            'Fiesse': 7, 'Gambara': 7, 'Ghedi': 7, 'Gottolengo': 7, 'Isorella': 7,
            'LenO': 7, 'Lograto': 7, 'Longhena': 7, 'Maclodio': 7, 'Mairano': 7,
            'Manerbio': 7, 'Milzano': 7, 'Montichiari': 7, 'Montirone': 7,
            'Offlaga': 7, 'Orzinuovi': 7, 'Orzivecchi': 7, 'Palazzolo sull\'Oglio': 7,
            'Pavone Mella': 7, 'San Paolo': 7, 'Pompiano': 7, 'Pontevico': 7,
            'Pralboino': 7, 'Quinzano d\'Oglio': 7, 'Remedello': 7, 'Roccafranca': 7,
            'Rudiano': 7, 'San Gervasio Bresciano': 7, 'Seniga': 7, 'Travagliato': 7,
            'Trenzano': 7, 'Urago d\'Oglio': 7, 'Verolanuova': 7, 'Verolavecchia': 7,
            'Villachiara': 7, 'Visano': 7,
            
            // Altre zone semplificate per demo
            'Bedizzole': 2, 'Desenzano del Garda': 2, 'Gardone Riviera': 2,
            'Iseo': 3, 'Paratico': 3, 'Pisogne': 3,
            'Angolo Terme': 4, 'Artogne': 4, 'Berzo Demo': 4,
            'Bovegno': 5, 'Gardone Val Trompia': 5, 'Lumezzane': 5,
            'Agnosine': 6, 'Anfo': 6, 'Bagolino': 6,
            'Adro': 8, 'Capriolo': 8, 'Cazzago San Martino': 8
        };

        // Nomi delle zone
        const nomiZone = {
            1: "CITT√Ä E HINTERLAND",
            2: "LAGO DI GARDA", 
            3: "LAGO D'ISEO",
            4: "VAL CAMONICA",
            5: "VAL TROMPIA",
            6: "VALLE SABBIA",
            7: "BASSA BRESCIANA",
            8: "FRANCIACORTA"
        };

        // State globale
        let state = {
            isAuthenticated: false,
            password: '',
            showPassword: false,
            activeTab: 'clients',  // Default su clienti
            isLoading: false,
            clients: [],
            // Filtri clienti
            clientFilters: {
                zona: '',
                attivo: '',
                search: ''
            }
        };

        // Carica dati iniziali
        function loadInitialData() {
            const saved = localStorage.getItem('clientiBrescia');
            if (saved) {
                state.clients = JSON.parse(saved);
            } else {
                // Dati di esempio compatibili con il tuo Excel
                state.clients = [
                    {
                        COGNOME: "Singh",
                        NOME: "Jasvir",
                        CUSTOMER_CODE: "1",
                        TELEFONO: "3270591632",
                        MAIL: "baljitkaurtoor72@gmail.com",
                        ATTIVI: "SI",
                        AREA_INTERESSE: "Barbariga",
                        ZONA: "7"
                    },
                    {
                        COGNOME: "De Donno",
                        NOME: "Remo",
                        CUSTOMER_CODE: "7",
                        TELEFONO: "3383830276",
                        MAIL: "",
                        ATTIVI: "SI",
                        AREA_INTERESSE: "Brescia e altro - 70k da mettere a reddito",
                        ZONA: "1"
                    }
                ];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('clientiBrescia', JSON.stringify(state.clients));
        }

        // Render app principale
        function render() {
            const app = document.getElementById('app');
            if (!state.isAuthenticated) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMain();
            }
            attachEventListeners();
        }

        function renderLogin() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                    <div class="flex items-center justify-center mb-6">
                        <svg class="w-16 h-16 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
                        Piattaforma Clienti Brescia
                    </h1>
                    <p class="text-center text-gray-600 mb-8">Gestione clienti con zone provincia</p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password di accesso</label>
                        <div class="relative">
                            <input
                                type="${state.showPassword ? 'text' : 'password'}"
                                id="password-input"
                                value="${state.password}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Inserisci password"
                            />
                            <button
                                id="toggle-password"
                                type="button"
                                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
                            >
                                ${state.showPassword ? 'üôà' : 'üëÅÔ∏è'}
                            </button>
                        </div>
                    </div>
                    
                    <button
                        id="login-btn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium"
                    >
                        üîê Accedi alla Piattaforma
                    </button>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <p class="text-sm text-blue-800 text-center">
                            <strong>Credenziali:</strong> aste2025
                        </p>
                    </div>
                </div>
            </div>
            `;
        }

        function renderMain() {
            return `
            <div class="min-h-screen bg-gray-50">
                <!-- Header -->
                <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white shadow-xl">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="bg-white p-2 rounded-xl">
                                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold">Gestione Clienti Brescia</h1>
                                    <p class="text-sm text-indigo-200">Zonizzazione provincia di Brescia</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div class="hidden sm:block text-right">
                                    <p class="text-sm text-indigo-200">Clienti attivi</p>
                                    <p class="text-lg font-bold">${getClientiAttivi()}</p>
                                </div>
                                <button id="logout-btn" class="bg-white/20 hover:bg-white/30 px-5 py-2.5 rounded-lg transition-colors backdrop-blur-sm border border-white/30">
                                    üîì Esci
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Tabs Navigation -->
                <nav class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex overflow-x-auto">
                            <button
                                id="tab-clients"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'clients' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üë• Clienti (${state.clients.length})
                            </button>
                            <button
                                id="tab-import"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'import' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üìÅ Importa Excel
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${state.activeTab === 'clients' ? renderClientsTab() : renderImportTab()}
                </main>
            </div>
            `;
        }

        function renderClientsTab() {
            const filteredClients = getFilteredClients();
            
            return `
            <div class="space-y-8">
                <!-- Toolbar Clienti -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="bg-purple-100 p-4 rounded-xl">
                                <span class="text-2xl">üë•</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Gestione Clienti</h2>
                                <p class="text-gray-600">Schema conforme al file Excel</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="showImportModal()" 
                                    class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow flex items-center gap-2">
                                üìÅ Importa Excel
                            </button>
                            <button onclick="exportToExcel()" 
                                    class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow flex items-center gap-2">
                                üì• Esporta Excel
                            </button>
                            <button onclick="showAddClientModal()" 
                                    class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow flex items-center gap-2">
                                ‚ûï Nuovo Cliente
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtri -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filtra per zona</label>
                            <select id="filter-zona" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Tutte le zone</option>
                                ${Object.entries(nomiZone).map(([code, name]) => `
                                    <option value="${code}" ${state.clientFilters.zona === code ? 'selected' : ''}>
                                        ${code} - ${name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stato</label>
                            <select id="filter-attivo" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Tutti</option>
                                <option value="SI" ${state.clientFilters.attivo === 'SI' ? 'selected' : ''}>Attivi</option>
                                <option value="NO" ${state.clientFilters.attivo === 'NO' ? 'selected' : ''}>Non attivi</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cerca</label>
                            <input type="text" 
                                   id="filter-search" 
                                   placeholder="Cognome, Nome, Comune..."
                                   value="${state.clientFilters.search}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <!-- Statistiche -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
                            <p class="text-sm font-medium text-blue-700 mb-1">Totali</p>
                            <p class="text-2xl font-bold text-blue-800">${state.clients.length}</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200">
                            <p class="text-sm font-medium text-green-700 mb-1">Attivi</p>
                            <p class="text-2xl font-bold text-green-800">${getClientiAttivi()}</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200">
                            <p class="text-sm font-medium text-purple-700 mb-1">Zone coperte</p>
                            <p class="text-2xl font-bold text-purple-800">${getZoneCoperte()}</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200">
                            <p class="text-sm font-medium text-orange-700 mb-1">Ultimo codice</p>
                            <p class="text-2xl font-bold text-orange-800">${getUltimoCodice()}</p>
                        </div>
                    </div>
                </div>

                <!-- Tabella Clienti -->
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">CODICE</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">COGNOME</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">NOME</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">TELEFONO</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">MAIL</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">ATTIVO</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">AREA INTERESSE</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">ZONA</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">AZIONI</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${filteredClients.length > 0 ? 
                                    filteredClients.map(client => renderClientRow(client)).join('') :
                                    `<tr><td colspan="9" class="py-8 text-center text-gray-500">Nessun cliente trovato</td></tr>`
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    ${filteredClients.length > 0 ? `
                    <div class="px-6 py-4 border-t bg-gray-50 flex justify-between items-center">
                        <p class="text-sm text-gray-600">
                            Mostrati ${filteredClients.length} di ${state.clients.length} clienti
                        </p>
                        <div class="text-sm text-gray-600">
                            Zona 1: Citt√† | Zona 7: Bassa Bresciana
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Legenda Zone -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üó∫Ô∏è Legenda Zone Provincia di Brescia</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        ${Object.entries(nomiZone).map(([code, name]) => `
                            <div class="flex items-center gap-2 p-3 rounded-lg border ${code === '1' ? 'border-blue-200 bg-blue-50' : code === '7' ? 'border-green-200 bg-green-50' : 'border-gray-200'}">
                                <span class="font-bold ${code === '1' ? 'text-blue-700' : code === '7' ? 'text-green-700' : 'text-gray-700'}">${code}</span>
                                <span class="text-sm text-gray-600">${name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
        }

        function renderImportTab() {
            return `
            <div class="space-y-8">
                <!-- Importazione Excel -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="bg-green-100 p-4 rounded-xl">
                            <span class="text-2xl">üìÅ</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Importazione da Excel</h2>
                            <p class="text-gray-600">Carica il tuo file Excel con i clienti</p>
                        </div>
                    </div>
                    
                    <!-- Dropzone per file -->
                    <div class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-indigo-400 transition-colors bg-gray-50/50"
                         id="dropzone"
                         ondrop="handleDrop(event)"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="max-w-md mx-auto">
                            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üìÇ</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Trascina il file Excel qui</h3>
                            <p class="text-gray-600 mb-4">Supporta il formato .xlsx con schema clienti</p>
                            <input type="file" 
                                   id="file-input" 
                                   accept=".xlsx,.xls"
                                   class="hidden"
                                   onchange="handleFileSelect(event)">
                            <button onclick="document.getElementById('file-input').click()"
                                    class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium">
                                üóÇÔ∏è Seleziona File
                            </button>
                            <p class="text-sm text-gray-500 mt-4">Oppure trascina il file qui sopra</p>
                        </div>
                    </div>
                    
                    <!-- Istruzioni -->
                    <div class="mt-8 p-6 bg-blue-50 rounded-xl border border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-3">üìã Schema richiesto (esatto):</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">COGNOME</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">NOME</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">CUSTOMER CODE</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">TELEFONO</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">MAIL</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">ATTIVI?</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">AREA D'INTERESSE</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">ZONA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="py-2 px-3 border text-sm">Rossi</td>
                                        <td class="py-2 px-3 border text-sm">Mario</td>
                                        <td class="py-2 px-3 border text-sm">1</td>
                                        <td class="py-2 px-3 border text-sm">1234567890</td>
                                        <td class="py-2 px-3 border text-sm">mario@email.com</td>
                                        <td class="py-2 px-3 border text-sm">SI</td>
                                        <td class="py-2 px-3 border text-sm">Brescia centro</td>
                                        <td class="py-2 px-3 border text-sm">1</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-sm text-blue-700 mt-3">
                            <strong>Nota:</strong> La colonna ZONA pu√≤ essere vuota, verr√† calcolata automaticamente dal comune nell'AREA D'INTERESSE
                        </p>
                    </div>
                    
                    <!-- Dati importati -->
                    ${state.importedData ? `
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Anteprima dati importati</h3>
                            <div class="flex gap-2">
                                <button onclick="confirmImport()" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    ‚úÖ Conferma Import
                                </button>
                                <button onclick="clearImport()" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                    ‚ùå Annulla
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        ${Object.keys(state.importedData[0] || {}).map(col => `
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">${col}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${state.importedData.slice(0, 5).map(row => `
                                        <tr class="hover:bg-gray-50">
                                            ${Object.values(row).map(val => `
                                                <td class="px-4 py-3 text-sm">${val || ''}</td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${state.importedData.length > 5 ? `
                                <div class="px-4 py-3 bg-gray-50 text-sm text-gray-500 border-t">
                                    + ${state.importedData.length - 5} altre righe...
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            `;
        }

        function renderClientRow(client) {
            return `
            <tr class="client-row hover:bg-gray-50">
                <td class="py-3 px-4">
                    <span class="font-mono font-bold text-indigo-600">${client.CUSTOMER_CODE}</span>
                </td>
                <td class="py-3 px-4 font-medium">${client.COGNOME}</td>
                <td class="py-3 px-4">${client.NOME}</td>
                <td class="py-3 px-4 font-mono text-sm">${client.TELEFONO}</td>
                <td class="py-3 px-4">
                    ${client.MAIL ? `
                        <a href="mailto:${client.MAIL}" class="text-blue-600 hover:text-blue-800 text-sm truncate block max-w-[150px]">
                            ${client.MAIL}
                        </a>
                    ` : '<span class="text-gray-400">‚Äî</span>'}
                </td>
                <td class="py-3 px-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${client.ATTIVI === 'SI' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${client.ATTIVI}
                    </span>
                </td>
                <td class="py-3 px-4 text-sm">${client.AREA_INTERESSE || ''}</td>
                <td class="py-3 px-4">
                    <div class="flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full ${getZonaColor(client.ZONA)} flex items-center justify-center text-xs font-bold">
                            ${client.ZONA || '?'}
                        </span>
                        ${client.ZONA ? `<span class="text-xs text-gray-600">${nomiZone[client.ZONA] || ''}</span>` : ''}
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="flex gap-2">
                        <button onclick="editClient('${client.CUSTOMER_CODE}')" 
                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Modifica">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deleteClient('${client.CUSTOMER_CODE}')" 
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Elimina">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
            `;
        }

        // Funzioni di supporto
        function getZonaColor(zona) {
            const colors = {
                '1': 'bg-blue-100 text-blue-800 border border-blue-200',
                '7': 'bg-green-100 text-green-800 border border-green-200',
                '2': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                '3': 'bg-purple-100 text-purple-800 border border-purple-200',
                '4': 'bg-red-100 text-red-800 border border-red-200',
                '5': 'bg-indigo-100 text-indigo-800 border border-indigo-200',
                '6': 'bg-pink-100 text-pink-800 border border-pink-200',
                '8': 'bg-orange-100 text-orange-800 border border-orange-200'
            };
            return colors[zona] || 'bg-gray-100 text-gray-800 border border-gray-200';
        }

        function getClientiAttivi() {
            return state.clients.filter(c => c.ATTIVI === 'SI').length;
        }

        function getZoneCoperte() {
            const zone = new Set(state.clients.map(c => c.ZONA).filter(z => z));
            return zone.size;
        }

        function getUltimoCodice() {
            if (state.clients.length === 0) return '0';
            const codici = state.clients.map(c => parseInt(c.CUSTOMER_CODE) || 0);
            return Math.max(...codici);
        }

        function getFilteredClients() {
            let filtered = [...state.clients];
            
            if (state.clientFilters.zona) {
                filtered = filtered.filter(c => c.ZONA === state.clientFilters.zona);
            }
            
            if (state.clientFilters.attivo) {
                filtered = filtered.filter(c => c.ATTIVI === state.clientFilters.attivo);
            }
            
            if (state.clientFilters.search) {
                const search = state.clientFilters.search.toLowerCase();
                filtered = filtered.filter(c => 
                    c.COGNOME.toLowerCase().includes(search) ||
                    c.NOME.toLowerCase().includes(search) ||
                    c.AREA_INTERESSE.toLowerCase().includes(search) ||
                    c.CUSTOMER_CODE.includes(search)
                );
            }
            
            return filtered;
        }

        // Funzioni principali
        function attachEventListeners() {
            // Login
            const loginBtn = document.getElementById('login-btn');
            const passwordInput = document.getElementById('password-input');
            const togglePassword = document.getElementById('toggle-password');
            
            if (loginBtn) loginBtn.onclick = handleLogin;
            if (passwordInput) {
                passwordInput.oninput = (e) => state.password = e.target.value;
                passwordInput.onkeypress = (e) => { if (e.key === 'Enter') handleLogin(); };
            }
            if (togglePassword) {
                togglePassword.onclick = () => {
                    state.showPassword = !state.showPassword;
                    render();
                };
            }
            
            // Main app
            const logoutBtn = document.getElementById('logout-btn');
            const tabClients = document.getElementById('tab-clients');
            const tabImport = document.getElementById('tab-import');
            
            if (logoutBtn) logoutBtn.onclick = handleLogout;
            if (tabClients) tabClients.onclick = () => { 
                state.activeTab = 'clients'; 
                render(); 
            };
            if (tabImport) tabImport.onclick = () => { 
                state.activeTab = 'import'; 
                render(); 
            };
            
            // Filtri clienti
            const filterZona = document.getElementById('filter-zona');
            const filterAttivo = document.getElementById('filter-attivo');
            const filterSearch = document.getElementById('filter-search');
            
            if (filterZona) filterZona.onchange = (e) => { 
                state.clientFilters.zona = e.target.value;
                render();
            };
            if (filterAttivo) filterAttivo.onchange = (e) => { 
                state.clientFilters.attivo = e.target.value;
                render();
            };
            if (filterSearch) {
                filterSearch.oninput = debounce((e) => {
                    state.clientFilters.search = e.target.value;
                    render();
                }, 300);
            }
        }

        function handleLogin() {
            if (state.password === MASTER_PASSWORD) {
                state.isAuthenticated = true;
                state.password = '';
                loadInitialData();
                render();
            } else {
                alert('Password non corretta. Usa: aste2025');
            }
        }

        function handleLogout() {
            state.isAuthenticated = false;
            render();
        }

        // Gestione file Excel
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropzone = event.currentTarget;
            dropzone.classList.remove('border-indigo-400', 'bg-indigo-50');
            dropzone.classList.add('border-gray-300');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.match(/\.(xlsx|xls)$/i)) {
                    processExcelFile(file);
                } else {
                    alert('Per favore carica solo file Excel (.xlsx o .xls)');
                }
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropzone = event.currentTarget;
            dropzone.classList.remove('border-gray-300');
            dropzone.classList.add('border-indigo-400', 'bg-indigo-50');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropzone = event.currentTarget;
            dropzone.classList.remove('border-indigo-400', 'bg-indigo-50');
            dropzone.classList.add('border-gray-300');
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Prende il primo foglio
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Converti in array di oggetti
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    const importedClients = rows.map(row => {
                        const client = {};
                        headers.forEach((header, index) => {
                            if (header && row[index] !== undefined) {
                                // Normalizza i nomi delle colonne
                                const normalizedHeader = header
                                    .replace('CUSTOMER<br>CODE', 'CUSTOMER_CODE')
                                    .replace('CUSTOMER CODE', 'CUSTOMER_CODE')
                                    .replace('AREA D\'INTERESSE', 'AREA_INTERESSE')
                                    .replace('ATTIVI?', 'ATTIVI')
                                    .trim()
                                    .replace(/\s+/g, '_')
                                    .toUpperCase();
                                
                                client[normalizedHeader] = row[index];
                            }
                        });
                        
                        // Calcola zona se non presente
                        if (!client.ZONA && client.AREA_INTERESSE) {
                            const zona = calcolaZonaDaArea(client.AREA_INTERESSE);
                            if (zona) client.ZONA = zona.toString();
                        }
                        
                        return client;
                    }).filter(client => client.COGNOME && client.NOME); // Filtra righe vuote
                    
                    state.importedData = importedClients;
                    render();
                    
                } catch (error) {
                    console.error('Errore nella lettura del file Excel:', error);
                    alert('Errore nella lettura del file Excel. Controlla il formato.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function calcolaZonaDaArea(areaInteresse) {
            if (!areaInteresse) return null;
            
            const areaLower = areaInteresse.toLowerCase();
            
            // Cerca comuni nella mappa
            for (const [comune, zona] of Object.entries(zoneComuni)) {
                if (areaLower.includes(comune.toLowerCase())) {
                    return zona;
                }
            }
            
            // Ricerca per parole chiave
            if (areaLower.includes('brescia')) return 1;
            if (areaLower.includes('barbariga')) return 7;
            if (areaLower.includes('gardone')) return 2;
            if (areaLower.includes('iseo')) return 3;
            
            return null;
        }

        function confirmImport() {
            if (!state.importedData || state.importedData.length === 0) {
                alert('Nessun dato da importare');
                return;
            }
            
            // Controlla duplicati
            const nuoviCodici = new Set(state.importedData.map(c => c.CUSTOMER_CODE));
            const codiciEsistenti = new Set(state.clients.map(c => c.CUSTOMER_CODE));
            const duplicati = [...nuoviCodici].filter(codice => codiciEsistenti.has(codice));
            
            if (duplicati.length > 0) {
                const sovrascrivere = confirm(`Trovati ${duplicati.length} codici cliente gi√† esistenti.\nVuoi sovrascrivere i clienti esistenti?`);
                
                if (sovrascrivere) {
                    // Rimuovi i duplicati esistenti
                    state.clients = state.clients.filter(client => 
                        !duplicati.includes(client.CUSTOMER_CODE)
                    );
                } else {
                    // Assegna nuovi codici ai duplicati
                    state.importedData.forEach(client => {
                        if (duplicati.includes(client.CUSTOMER_CODE)) {
                            let nuovoCodice = (parseInt(getUltimoCodice()) + 1).toString();
                            while (codiciEsistenti.has(nuovoCodice)) {
                                nuovoCodice = (parseInt(nuovoCodice) + 1).toString();
                            }
                            client.CUSTOMER_CODE = nuovoCodice;
                        }
                    });
                }
            }
            
            // Aggiungi i nuovi clienti
            state.clients.push(...state.importedData);
            saveData();
            
            alert(`‚úÖ Importati ${state.importedData.length} clienti con successo!`);
            state.importedData = null;
            state.activeTab = 'clients';
            render();
        }

        function clearImport() {
            state.importedData = null;
            render();
        }

        // Esportazione Excel
        function exportToExcel() {
            if (state.clients.length === 0) {
                alert('Nessun cliente da esportare');
                return;
            }
            
            // Prepara i dati nel formato Excel
            const headers = ['COGNOME', 'NOME', 'CUSTOMER CODE', 'TELEFONO', 'MAIL', 'ATTIVI?', 'AREA D\'INTERESSE', 'ZONA'];
            const data = state.clients.map(client => [
                client.COGNOME,
                client.NOME,
                client.CUSTOMER_CODE,
                client.TELEFONO,
                client.MAIL,
                client.ATTIVI,
                client.AREA_INTERESSE,
                client.ZONA
            ]);
            
            // Crea workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            
            // Imposta larghezza colonne
            const colWidths = [
                { wch: 15 }, // COGNOME
                { wch: 15 }, // NOME
                { wch: 12 }, // CUSTOMER CODE
                { wch: 15 }, // TELEFONO
                { wch: 25 }, // MAIL
                { wch: 8 },  // ATTIVI?
                { wch: 30 }, // AREA D'INTERESSE
                { wch: 8 }   // ZONA
            ];
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Clienti');
            
            // Esporta
            const fileName = `clienti_brescia_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ Esportati ${state.clients.length} clienti in ${fileName}`);
        }

        // Gestione clienti
        function showAddClientModal() {
            const modalContent = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden mx-4">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">‚ûï Nuovo Cliente</h2>
                                <p class="text-indigo-200">Compila tutti i campi come nel file Excel</p>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                √ó
                            </button>
                        </div>
                    </div>
                    
                    <!-- Form -->
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">COGNOME *</label>
                                <input type="text" id="add-cognome" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NOME *</label>
                                <input type="text" id="add-nome" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CUSTOMER CODE *</label>
                                <input type="text" id="add-codice" 
                                       value="${parseInt(getUltimoCodice()) + 1}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg font-mono" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TELEFONO</label>
                                <input type="tel" id="add-telefono" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">MAIL</label>
                                <input type="email" id="add-mail" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ATTIVO</label>
                                <select id="add-attivo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                    <option value="SI" selected>SI</option>
                                    <option value="NO">NO</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">AREA D'INTERESSE *</label>
                                <input type="text" id="add-area" 
                                       placeholder="Es: Barbariga, Brescia centro..."
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                                <p class="text-xs text-gray-500 mt-1">Inserisci il comune per calcolo automatico zona</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ZONA (calcolata automaticamente)</label>
                                <div class="flex items-center gap-4">
                                    <input type="text" id="add-zona" readonly
                                           class="w-20 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-center font-bold">
                                    <span id="zona-nome" class="text-gray-600"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="border-t border-gray-200 p-6 bg-gray-50">
                        <div class="flex justify-between">
                            <button onclick="closeModal()" 
                                    class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="saveNewClient()" 
                                    class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">
                                üíæ Salva Cliente
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            
            // Calcola zona in tempo reale
            setTimeout(() => {
                const areaInput = document.getElementById('add-area');
                const zonaInput = document.getElementById('add-zona');
                const zonaNome = document.getElementById('zona-nome');
                
                areaInput.addEventListener('input', function() {
                    const zona = calcolaZonaDaArea(this.value);
                    if (zona) {
                        zonaInput.value = zona;
                        zonaInput.className = `w-20 px-4 py-3 border rounded-lg text-center font-bold ${getZonaColor(zona.toString())}`;
                        zonaNome.textContent = nomiZone[zona] || '';
                    } else {
                        zonaInput.value = '';
                        zonaInput.className = 'w-20 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-center font-bold';
                        zonaNome.textContent = '';
                    }
                });
                
                // Trigger iniziale
                areaInput.dispatchEvent(new Event('input'));
            }, 100);
        }

        function saveNewClient() {
            const cliente = {
                COGNOME: document.getElementById('add-cognome').value.trim(),
                NOME: document.getElementById('add-nome').value.trim(),
                CUSTOMER_CODE: document.getElementById('add-codice').value.trim(),
                TELEFONO: document.getElementById('add-telefono').value.trim(),
                MAIL: document.getElementById('add-mail').value.trim(),
                ATTIVI: document.getElementById('add-attivo').value,
                AREA_INTERESSE: document.getElementById('add-area').value.trim(),
                ZONA: document.getElementById('add-zona').value || ''
            };
            
            // Validazione
            if (!cliente.COGNOME || !cliente.NOME || !cliente.CUSTOMER_CODE) {
                alert('Compila i campi obbligatori: Cognome, Nome e Codice');
                return;
            }
            
            // Controlla duplicato codice
            if (state.clients.some(c => c.CUSTOMER_CODE === cliente.CUSTOMER_CODE)) {
                alert(`Il codice cliente ${cliente.CUSTOMER_CODE} √® gi√† utilizzato.`);
                return;
            }
            
            state.clients.push(cliente);
            saveData();
            closeModal();
            render();
            alert(`‚úÖ Cliente ${cliente.COGNOME} ${cliente.NOME} aggiunto con successo!`);
        }

        function editClient(codice) {
            const cliente = state.clients.find(c => c.CUSTOMER_CODE === codice);
            if (!cliente) return;
            
            const modalContent = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden mx-4">
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">‚úèÔ∏è Modifica Cliente</h2>
                                <p class="text-blue-200">Codice: ${cliente.CUSTOMER_CODE}</p>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                √ó
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">COGNOME *</label>
                                <input type="text" id="edit-cognome" value="${cliente.COGNOME}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NOME *</label>
                                <input type="text" id="edit-nome" value="${cliente.NOME}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TELEFONO</label>
                                <input type="tel" id="edit-telefono" value="${cliente.TELEFONO}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">MAIL</label>
                                <input type="email" id="edit-mail" value="${cliente.MAIL}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ATTIVO</label>
                                <select id="edit-attivo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                    <option value="SI" ${cliente.ATTIVI === 'SI' ? 'selected' : ''}>SI</option>
                                    <option value="NO" ${cliente.ATTIVI === 'NO' ? 'selected' : ''}>NO</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">AREA D'INTERESSE *</label>
                                <input type="text" id="edit-area" value="${cliente.AREA_INTERESSE || ''}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ZONA</label>
                                <div class="flex items-center gap-4">
                                    <input type="text" id="edit-zona" value="${cliente.ZONA || ''}" readonly
                                           class="w-20 px-4 py-3 border rounded-lg text-center font-bold ${getZonaColor(cliente.ZONA)}">
                                    <span id="edit-zona-nome" class="text-gray-600">${nomiZone[cliente.ZONA] || ''}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 p-6 bg-gray-50">
                        <div class="flex justify-between">
                            <button onclick="deleteClient('${cliente.CUSTOMER_CODE}', true)" 
                                    class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                üóëÔ∏è Elimina
                            </button>
                            <div class="flex gap-3">
                                <button onclick="closeModal()" 
                                        class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg">
                                    Annulla
                                </button>
                                <button onclick="saveEditedClient('${cliente.CUSTOMER_CODE}')" 
                                        class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    üíæ Salva Modifiche
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            
            // Calcola zona in tempo reale
            setTimeout(() => {
                const areaInput = document.getElementById('edit-area');
                const zonaInput = document.getElementById('edit-zona');
                const zonaNome = document.getElementById('edit-zona-nome');
                
                areaInput.addEventListener('input', function() {
                    const zona = calcolaZonaDaArea(this.value);
                    if (zona) {
                        zonaInput.value = zona;
                        zonaInput.className = `w-20 px-4 py-3 border rounded-lg text-center font-bold ${getZonaColor(zona.toString())}`;
                        zonaNome.textContent = nomiZone[zona] || '';
                    }
                });
            }, 100);
        }

        function saveEditedClient(codice) {
            const index = state.clients.findIndex(c => c.CUSTOMER_CODE === codice);
            if (index === -1) return;
            
            state.clients[index] = {
                ...state.clients[index],
                COGNOME: document.getElementById('edit-cognome').value.trim(),
                NOME: document.getElementById('edit-nome').value.trim(),
                TELEFONO: document.getElementById('edit-telefono').value.trim(),
                MAIL: document.getElementById('edit-mail').value.trim(),
                ATTIVI: document.getElementById('edit-attivo').value,
                AREA_INTERESSE: document.getElementById('edit-area').value.trim(),
                ZONA: document.getElementById('edit-zona').value || state.clients[index].ZONA
            };
            
            saveData();
            closeModal();
            render();
            alert('‚úÖ Cliente modificato con successo!');
        }

        function deleteClient(codice, fromModal = false) {
            if (!confirm(`Sei sicuro di voler eliminare il cliente con codice ${codice}?`)) {
                return;
            }
            
            state.clients = state.clients.filter(c => c.CUSTOMER_CODE !== codice);
            saveData();
            
            if (!fromModal) {
                render();
            } else {
                closeModal();
                render();
            }
            
            alert('‚úÖ Cliente eliminato!');
        }

        // Gestione modale
        function showModal(content) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    ${content}
                </div>
            `;
            
            // Chiudi cliccando sull'overlay
            setTimeout(() => {
                const overlay = modalContainer.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.onclick = (e) => {
                        if (e.target === overlay) closeModal();
                    };
                }
                
                // Chiudi con ESC
                document.addEventListener('keydown', handleEscKey);
            }, 100);
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            document.removeEventListener('keydown', handleEscKey);
        }

        function handleEscKey(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        }

        // Utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Inizializza app
        function init() {
            render();
        }

        // Esponi funzioni globali
        window.showImportModal = () => { state.activeTab = 'import'; render(); };
        window.handleDrop = handleDrop;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleFileSelect = handleFileSelect;
        window.confirmImport = confirmImport;
        window.clearImport = clearImport;
        window.exportToExcel = exportToExcel;
        window.showAddClientModal = showAddClientModal;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.saveNewClient = saveNewClient;
        window.editClient = editClient;
        window.saveEditedClient = saveEditedClient;
        window.deleteClient = deleteClient;

        // Avvia app
        init();
    </script>
</body>
</html>

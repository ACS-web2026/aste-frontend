<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma Aste Immobiliari Avanzata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        #map { height: 300px; width: 100%; border-radius: 0.5rem; }
        .leaflet-container { font-family: inherit; }
        .source-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            margin: 2px; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            cursor: pointer;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .client-row:hover { background-color: #f8fafc; }
        table { border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: white; z-index: 10; }
        .zone-btn { transition: all 0.2s; }
        .zone-btn.selected { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .budget-btn { transition: all 0.2s; }
        .budget-btn.selected { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
     .badge-fonte {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        transition: all 0.2s;
        cursor: pointer;
    }

    .badge-fonte:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .link-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        width: 100%;
    }

    .link-button:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }

    /* Stili per la modale dei link */
    .link-modal {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-container"></div>

    <script>
        // Configurazione
        const MASTER_PASSWORD = 'aste2025';
        const MAP_CENTER = [45.5397, 10.2231]; // Brescia
        const MAP_ZOOM = 10;
        let map = null;

        // Nomi e colori delle zone
        const zoneInfo = {
            1: { nome: "CITT√Ä E HINTERLAND", colore: "blue" },
            2: { nome: "LAGO DI GARDA", colore: "teal" },
            3: { nome: "LAGO D'ISEO", colore: "purple" },
            4: { nome: "VAL CAMONICA", colore: "red" },
            5: { nome: "VAL TROMPIA", colore: "indigo" },
            6: { nome: "VALLE SABBIA", colore: "pink" },
            7: { nome: "BASSA BRESCIANA", colore: "green" },
            8: { nome: "FRANCIACORTA", colore: "orange" }
        };

        // Mappatura completa comuni -> zona (presa dal tuo Excel)
        const comuniBrescia = {
            'Acquafredda': '7', 'Adro': '8', 'Agnosine': '6', 'Alfianello': '7',
            'Anfo': '6', 'Angolo Terme': '4', 'Artogne': '4', 'Azzano Mella': '7',
            'Bagnolo Mella': '7', 'Bagolino': '6', 'Barbariga': '7', 'Barghe': '7',
            'Bassano Bresciano': '7', 'Bedizzole': '2', 'Berlingo': '7', 'Berzo Demo': '4',
            'Berzo Inferiore': '4', 'Bienno': '4', 'Bione': '6', 'Borgo San Giacomo': '7',
            'Borgosatollo': '1', 'Borno': '4', 'Botticino': '1', 'Bovegno': '5',
            'Bovezzo': '1', 'Brandico': '7', 'Braone': '4', 'Breno': '4', 'Brescia': '1',
            'Brione': '5', 'Caino': '5', 'Calcinato': '1', 'Calvagese della Riviera': '2',
            'Calvisano': '7', 'Capo di Ponte': '4', 'Capovalle': '6', 'Capriano del Colle': '1',
            'Capriolo': '8', 'Carpenedolo': '7', 'Castegnato': '1', 'Castelcovati': '7',
            'Castel Mella': '1', 'Castenedolo': '1', 'Casto': '6', 'Castrezzato': '1',
            'Cazzago San Martino': '8', 'Cedegolo': '4', 'Cellatica': '1', 'Ceto': '4',
            'Cerveno': '4', 'Cevo': '4', 'Chiari': '7', 'Cigole': '7', 'Cimbergo': '4',
            'Cividate Camuno': '4', 'Coccaglio': '8', 'Collebeato': '1', 'Collio': '5',
            'Cologne': '8', 'Comezzano-Cizzago': '7', 'Concesio': '1', 'Corte Franca': '8',
            'Corteno Golgi': '4', 'Corzano': '7', 'Darfo Boario Terme': '4', 'Dello': '7',
            'Desenzano del Garda': '2', 'Edolo': '4', 'Erbusco': '8', 'Esine': '4',
            'Fiesse': '7', 'Flero': '1', 'Gambara': '7', 'Gardone Riviera': '2',
            'Gardone Val Trompia': '5', 'Gargnano': '2', 'Gavardo': '2', 'Ghedi': '7',
            'Gianico': '5', 'Gottolengo': '7', 'Gussago': '1', 'Idro': '6', 'Incudine': '4',
            'Irma': '5', 'Iseo': '3', 'Isorella': '7', 'Lavenone': '6', 'Leno': '7',
            'Limone sul Garda': '2', 'Lodrino': '5', 'Lograto': '7', 'Lonato': '2',
            'Longhena': '7', 'Losine': '4', 'Lozio': '4', 'Lumezzane': '5', 'Maclodio': '7',
            'Magasa': '6', 'Mairano': '7', 'Malegno': '4', 'Malonno': '4', 'Manerba sul Garda': '2',
            'Manerbio': '7', 'Marcheno': '5', 'Marmentino': '5', 'Marone': '2', 'Mazzano': '1',
            'Milzano': '7', 'Moniga del Garda': '2', 'Monno': '4', 'Monte Isola': '3',
            'Monticelli Brusati': '8', 'Montichiari': '7', 'Montirone': '7', 'Mura': '6',
            'Muscoline': '2', 'Nave': '1', 'Niardo': '4', 'Nuvolento': '1', 'Nuvolera': '1',
            'Odolo': '6', 'Offlaga': '7', 'Ome': '8', 'Ono San Pietro': '4', 'Orzinuovi': '7',
            'Orzivecchi': '7', 'Ospitaletto': '1', 'Ossimo': '4', 'Padenghe sul Garda': '2',
            'Paderno Franciacorta': '8', 'Paisco Loveno': '4', 'Paitone': '6',
            'Palazzolo sull\'Oglio': '7', 'Paratico': '3', 'Paspardo': '4', 'Passirano': '8',
            'Pavone Mella': '7', 'San Paolo': '7', 'Pertica Alta': '6', 'Pertica Bassa': '6',
            'Pezzaze': '4', 'Pian Camuno': '4', 'Piancogno': '4', 'Pisogne': '3', 'Polaveno': '5',
            'Polpenazze del Garda': '2', 'Pompiano': '7', 'Poncarale': '1', 'Ponte di Legno': '4',
            'Pontevico': '7', 'Pontoglio': '5', 'Pozzolengo': '2', 'Pralboino': '7', 'Preseglie': '6',
            'Prevalle': '6', 'Provaglio d\'Iseo': '3', 'Provaglio Valsabbia': '6',
            'Puegnago sul Garda': '2', 'Quinzano d\'Oglio': '7', 'Remedello': '7', 'Rezzato': '1',
            'Roccafranca': '7', 'Rodengo Saiano': '8', 'Ro√® Volciano': '2', 'Roncadelle': '1',
            'Rovato': '8', 'Rudiano': '7', 'Sabbio Chiese': '6', 'Sale Marasino': '3', 'Sal√≤': '2',
            'San Felice del Benaco': '2', 'San Gervasio Bresciano': '7', 'San Zeno Naviglio': '1',
            'Sarezzo': '5', 'Saviore dell\'Adamello': '4', 'Sellero': '4', 'Seniga': '7',
            'Serle': '6', 'Sirmione': '2', 'Soiano del Lago': '2', 'Sonico': '4', 'Sulzano': '3',
            'Tavernole sul Mella': '5', 'Tem√π': '4', 'Tignale': '2', 'Torbole Casaglia': '1',
            'Toscolano Maderno': '2', 'Travagliato': '7', 'Tremosine': '2', 'Trenzano': '7',
            'Treviso Bresciano': '6', 'Urago d\'Oglio': '7', 'Vallio': '6', 'Valvestino': '6',
            'Verolanuova': '7', 'Verolavecchia': '7', 'Vestone': '6', 'Vezza d\'Oglio': '4',
            'Villa Carcina': '5', 'Villachiara': '7', 'Villanuova Sul Clisi': '2', 'Vione': '4',
            'Visano': '7', 'Vobarno': '6', 'Zone': '6'
        };

        // Coordinate per comuni di Brescia
        const coordinateBrescia = {
            'Brescia': [45.5397, 10.2231],
            'Iseo': [45.6584, 10.0539],
            'Gardone Riviera': [45.6200, 10.5656],
            'Sal√≤': [45.6069, 10.5278],
            'Desenzano del Garda': [45.4686, 10.5397],
            'Chiari': [45.5361, 9.9306],
            'Rovato': [45.5631, 10.0008],
            'Palazzolo sull\'Oglio': [45.5961, 9.8819],
            'Darfo Boario Terme': [45.8900, 10.1867],
            'Lumezzane': [45.6478, 10.2639],
            'Montichiari': [45.4139, 10.3917],
            'Orzinuovi': [45.4039, 9.9219],
            'Ghedi': [45.4036, 10.2769],
            'Sarezzo': [45.6519, 10.1964],
            'Rezzato': [45.5139, 10.3172]
        };
        
        // Coordinate per comuni italiani (per la mappa)
        const coordinateComuni = {
            'Brescia': [45.5397, 10.2231], 'Milano': [45.4642, 9.1900], 'Roma': [41.9028, 12.4964], 
            'Torino': [45.0703, 7.6869], 'Napoli': [40.8518, 14.2681], 'Firenze': [43.7696, 11.2558],
            'Bologna': [44.4949, 11.3426], 'Genova': [44.4056, 8.9463], 'Venezia': [45.4408, 12.3155],
            'Verona': [45.4384, 10.9916], 'Padova': [45.4064, 11.8768], 'Bergamo': [45.6983, 9.6773]
        };

        // Fonti disponibili
// Sostituisci la costante SITES attuale (circa riga 850) con:
const SITES = [
    { name: 'Asta Legale', color: 'blue', icon: '‚öñÔ∏è', url: 'https://www.astalegale.net/' },
    { name: 'Astagiudiziaria', color: 'green', icon: 'üèõÔ∏è', url: 'https://www.astagiudiziaria.com/' },
    { name: 'Aste online', color: 'orange', icon: 'üíª', url: 'https://www.asteonline.it' },
    { name: 'Asteannunci', color: 'purple', icon: 'üì¢', url: 'https://www.asteannunci.it/' },
    { name: 'Asteavvisi', color: 'red', icon: 'üì∞', url: 'https://www.asteavvisi.it' },
    { name: 'Astegiudiziarie', color: 'indigo', icon: '‚öñÔ∏è', url: 'https://www.astegiudiziarie.it' },
    { name: 'Astetribunali24', color: 'yellow', icon: 'üìä', url: 'https://astetribunali24.ilsole24ore.com/' },
    { name: 'Canale Aste', color: 'teal', icon: 'üì°', url: 'https://www.canaleaste.it' },
    { name: 'Enti e Tribunali', color: 'gray', icon: 'üè¢', url: 'http://www.entietribunali.it' },
    { name: 'FALLCO Aste', color: 'pink', icon: 'üè†', url: 'https://www.fallcoaste.it/' },
    { name: 'Fallimenti.it', color: 'blue', icon: 'üìã', url: 'https://www.fallimenti.it/' },
    { name: 'Gara Virtuale', color: 'green', icon: 'üéÆ', url: 'https://www.garavirtuale.it/' },
    { name: 'Gorealbid', color: 'orange', icon: 'üí∞', url: 'https://www.gobidreal.it/it/aste-Case-e-Appartamenti/' },
    { name: 'Immobiliare.it', color: 'red', icon: 'üè†', url: 'https://aste.immobiliare.it' },
    { name: 'Legalmente', color: 'purple', icon: '‚öñÔ∏è', url: 'https://legalmente.net' },
    { name: 'Mercury', color: 'indigo', icon: '‚òøÔ∏è', url: 'https://www.mercury-auctions.com/it_it/index/' },
    { name: 'PVP', color: 'teal', icon: 'üèõÔ∏è', url: 'https://pvp.giustizia.it/pvp/' },
    { name: 'Repubblica', color: 'blue', icon: 'üì∞', url: 'https://annunci.repubblica.it' },
    { name: 'SIVAG', color: 'green', icon: 'üè¢', url: 'https://www.sivag.com/' },
    { name: 'Vendite Notartel', color: 'orange', icon: 'üìù', url: 'https://venditepubblichenotarili.notariato.it' },
    { name: 'Avvisi Notartel', color: 'red', icon: 'üì¢', url: 'https://avvisinotarili.notariato.it' },
    { name: 'Aste Book', color: 'purple', icon: 'üìö', url: 'https://www.astebook.it/it/index.asp' }
];

        // Fasce di budget
        const budgetFasce = [
            { id: 'under50', label: '< 50.000‚Ç¨', max: 50000 },
            { id: 'under100', label: '< 100.000‚Ç¨', max: 100000 },
            { id: 'under250', label: '< 250.000‚Ç¨', max: 250000 },
            { id: 'nolimit', label: 'No limits', max: null }
        ];

        // State globale
        let state = {
            isAuthenticated: false,
            password: '',
            showPassword: false,
            activeTab: 'search',
            isLoading: false,
            searchStatus: 'Pronto per la ricerca',
            filters: { comune: '', tipologia: '', prezzoMin: '', prezzoMax: '' },
            // Clienti in formato aggiornato
            clients: [],
            searchResults: [],
            selectedAnnuncio: null,
            showClientSuggestions: false,
            // Filtri clienti
            clientFilters: {
                zone: [],
                budget: '',
                attivo: '',
                search: ''
            },
            importedData: null
        };

        // Carica dati iniziali
        function loadInitialData() {
            const saved = localStorage.getItem('clientiBrescia');
            if (saved) {
                state.clients = JSON.parse(saved);
            } else {
                // DATI VUOTI - parti da zero
                state.clients = [];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('clientiBrescia', JSON.stringify(state.clients));
        }

        // Render app principale
        function render() {
            const app = document.getElementById('app');
            if (!state.isAuthenticated) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMain();
            }
            attachEventListeners();
            
            // Inizializza mappa se ci sono risultati
            if (state.activeTab === 'search' && state.searchResults.length > 0) {
                setTimeout(initMap, 100);
            }
            
            // Render modale se necessario
            renderModal();
        }

        function renderLogin() {
            return `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                    <div class="flex items-center justify-center mb-6">
                        <svg class="w-16 h-16 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
                        Piattaforma Aste
                    </h1>
                    <p class="text-center text-gray-600 mb-8">Sistema avanzato di monitoraggio</p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password di accesso</label>
                        <div class="relative">
                            <input
                                type="${state.showPassword ? 'text' : 'password'}"
                                id="password-input"
                                value="${state.password}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Inserisci password"
                            />
                            <button
                                id="toggle-password"
                                type="button"
                                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
                            >
                                ${state.showPassword ? 'üôà' : 'üëÅÔ∏è'}
                            </button>
                        </div>
                    </div>
                    
                    <button
                        id="login-btn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium"
                    >
                        üîê Accedi alla Piattaforma
                    </button>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <p class="text-sm text-blue-800 text-center">
                            <strong>Credenziali demo:</strong> aste2025
                        </p>
                    </div>
                </div>
            </div>
            `;
        }

        function renderMain() {
            return `
            <div class="min-h-screen bg-gray-50">
                <!-- Header -->
                <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white shadow-xl">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="bg-white p-2 rounded-xl">
                                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold">Piattaforma Aste Immobiliari</h1>
                                    <p class="text-sm text-indigo-200">Monitoraggio avanzato</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div class="hidden sm:block text-right">
                                    <p class="text-sm text-indigo-200">Clienti attivi</p>
                                    <p class="text-lg font-bold">${getClientiAttivi()}</p>
                                </div>
                                <button id="logout-btn" class="bg-white/20 hover:bg-white/30 px-5 py-2.5 rounded-lg transition-colors backdrop-blur-sm border border-white/30">
                                    üîì Esci
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Tabs Navigation -->
                <nav class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex overflow-x-auto">
                            <button
                                id="tab-search"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'search' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üîç Ricerca Aste
                            </button>
                            <button
                                id="tab-clients"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'clients' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üë• Clienti (${state.clients.length})
                            </button>
                            <button
                                id="tab-import"
                                class="flex-1 py-4 px-2 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'import' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}"
                            >
                                üìÅ Importa Excel
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${state.activeTab === 'search' ? renderSearchTab() : 
                      state.activeTab === 'clients' ? renderClientsTab() : 
                      renderImportTab()}
                </main>
            </div>
            `;
        }

        function renderSearchTab() {
            return `
            <div class="space-y-8">
                <!-- Filtri di Ricerca -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-indigo-100 p-3 rounded-xl">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Ricerca Avanzata</h2>
                            <p class="text-gray-600">Cerca aste immobiliari...</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Comune</label>
                            <input
                                id="filter-comune"
                                type="text"
                                placeholder="Es: Milano, Roma, Brescia..."
                                value="${state.filters.comune}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipologia</label>
                            <select
                                id="filter-tipologia"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                                <option value="">Tutte le tipologie</option>
                                <option value="Appartamento" ${state.filters.tipologia === 'Appartamento' ? 'selected' : ''}>Appartamento</option>
                                <option value="Villa" ${state.filters.tipologia === 'Villa' ? 'selected' : ''}>Villa</option>
                                <option value="Attico" ${state.filters.tipologia === 'Attico' ? 'selected' : ''}>Attico</option>
                                <option value="Garage" ${state.filters.tipologia === 'Garage' ? 'selected' : ''}>Garage</option>
                                <option value="Terreno" ${state.filters.tipologia === 'Terreno' ? 'selected' : ''}>Terreno</option>
                                <option value="Capannone" ${state.filters.tipologia === 'Capannone' ? 'selected' : ''}>Capannone</option>
                                <option value="Ufficio" ${state.filters.tipologia === 'Ufficio' ? 'selected' : ''}>Ufficio</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo min</label>
                            <input
                                id="filter-prezzo-min"
                                type="number"
                                placeholder="‚Ç¨"
                                value="${state.filters.prezzoMin}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo max</label>
                            <input
                                id="filter-prezzo-max"
                                type="number"
                                placeholder="‚Ç¨"
                                value="${state.filters.prezzoMax}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                        
                        <div class="flex items-end">
                            <button
                                id="search-btn"
                                ${state.isLoading ? 'disabled' : ''}
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3.5 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium ${state.isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl'}"
                            >
                                ${state.isLoading ? 
                                    '<span class="flex items-center justify-center gap-2"><span class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span> Ricerca...</span>' : 
                                    '<span class="flex items-center justify-center gap-2">üîç Avvia Ricerca</span>'
                                }
                            </button>
                        </div>
                    </div>
                    
                    ${state.searchStatus ? `
                    <div class="p-4 rounded-lg ${state.searchStatus.includes('‚úÖ') ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'}">
                        <div class="flex items-center gap-3">
                            ${state.searchStatus.includes('‚úÖ') ? '‚úÖ' : '‚ÑπÔ∏è'}
                            <p class="font-medium ${state.searchStatus.includes('‚úÖ') ? 'text-green-800' : 'text-blue-800'}">
                                ${state.searchStatus}
                            </p>
                        </div>
                    </div>
                    ` : ''}
                    
                                        <div class="mt-6 pt-6 border-t border-gray-100">
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs font-medium text-gray-500">Portali monitorati:</span>
                            ${SITES.slice(0, 8).map(site => `
                                <a href="${site.url}" 
                                   target="_blank" 
                                   rel="noopener noreferrer"
                                   class="text-xs px-3 py-1.5 rounded-full ${getSourceColorClass(site.name)} hover:opacity-80 transition-opacity">
                                    ${site.icon} ${site.name}
                                </a>
                            `).join('')}
                            ${SITES.length > 8 ? `
                                <span class="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-700">
                                    +${SITES.length - 8} altri...
                                </span>
                            ` : ''}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            üëÜ Clicca su qualsiasi portale per visitarlo (si apre in nuova scheda)
                        </p>
                    </div>

                <!-- Mappa -->
                ${state.searchResults.length > 0 ? `
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-green-100 p-3 rounded-xl">
                            <span class="text-2xl">üó∫Ô∏è</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Mappa degli Annunci</h3>
                            <p class="text-gray-600">Localizzazione geografica degli immobili</p>
                        </div>
                    </div>
                    <div id="map" class="rounded-xl overflow-hidden border border-gray-200"></div>
                    <p class="text-sm text-gray-500 mt-3">Clicca sui marker per i dettagli degli annunci</p>
                </div>
                ` : ''}

                <!-- Risultati -->
                ${state.searchResults.length > 0 ? `
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${state.searchResults.length} Annunci Trovati</h3>
                            <p class="text-gray-600">Risultati deduplicati automaticamente</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportAllToPDF()" class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow flex items-center gap-2">
                                üìÑ Esporta Tutto
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${state.searchResults.map(r => renderResultCard(r)).join('')}
                    </div>
                </div>
                ` : !state.isLoading ? `
                <div class="bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-indigo-100 rounded-full mb-6">
                        <span class="text-4xl">üîç</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Nessuna ricerca effettuata</h3>
                    <p class="text-gray-600 max-w-md mx-auto mb-8">
                        Imposta i filtri di ricerca e clicca "Avvia Ricerca" per trovare annunci di aste immobiliari dai principali portali.
                    </p>
                </div>
                ` : ''}
            </div>
            `;
        }

// Modifica la funzione renderResultCard() (circa riga 1040) - AGGIUNGI DOPO LA SEZIONE DEI PULSANTI:
function renderResultCard(result) {
    const prezzoPerMq = result.metriQuadrati > 0 ? (result.prezzo / result.metriQuadrati).toFixed(2) : 'N/A';
    
    return `
    <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 border border-gray-100 overflow-hidden group">
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-5 border-b border-gray-200">
            <div class="flex justify-between items-start gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">üè†</span>
                        <h3 class="text-xl font-bold text-gray-800">${result.tipologia}</h3>
                    </div>
                    <div class="flex items-center justify-between">
                        <p class="text-gray-600 flex items-center gap-2">
                            <span class="text-lg">üìç</span>
                            <span>${result.indirizzo}, ${result.comune}</span>
                        </p>
                        <button onclick="geolocalizzaAnnuncio(${result.id})" 
                                class="text-xs bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded-lg flex items-center gap-1">
                            <span>üó∫Ô∏è</span>
                            <span>Mappa</span>
                        </button>
                    </div>
                </div>
                <div class="text-right">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2.5 rounded-lg shadow">
                        <p class="text-xl font-bold">‚Ç¨${result.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                        <p class="text-xs opacity-90">Prezzo base d'asta</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-5">
            <div class="grid grid-cols-2 gap-3 mb-5">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <p class="text-xs font-medium text-blue-600 mb-1">Metratura</p>
                    <p class="text-lg font-bold text-blue-700">${result.metriQuadrati} m¬≤</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                    <p class="text-xs font-medium text-green-600 mb-1">Locali</p>
                    <p class="text-lg font-bold text-green-700">${result.locali}</p>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <p class="text-xs font-medium text-purple-600 mb-1">Prezzo/m¬≤</p>
                    <p class="text-lg font-bold text-purple-700">‚Ç¨${prezzoPerMq}</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <p class="text-xs font-medium text-orange-600 mb-1">Data Asta</p>
                    <p class="text-lg font-bold text-orange-700">${result.dataAsta}</p>
                </div>
            </div>
            
            <p class="text-gray-600 mb-5 line-clamp-2">${result.descrizione}</p>
            
            <!-- Badge delle fonti -->
            ${result.fonti && result.fonti.length > 0 ? `
            <div class="mb-4">
                <p class="text-xs font-medium text-gray-500 mb-2">Pubblicato su:</p>
                <div class="flex flex-wrap gap-1">
                    ${result.fonti.map(fonte => `
                        <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 flex items-center gap-1">
                            ${fonte.icon}
                            <span class="truncate max-w-[80px]">${fonte.nome}</span>
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="showAnnuncioDetails(${result.id})" 
                        class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 group/btn">
                    <span class="group-hover/btn:scale-110 transition-transform">üìä</span>
                    <span class="text-sm font-medium">Dettagli</span>
                </button>
                <button onclick="showClientSuggestions(${result.id})" 
                        class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 group/btn">
                    <span class="group-hover/btn:scale-110 transition-transform">üë•</span>
                    <span class="text-sm font-medium">Clienti</span>
                </button>
            </div>
        </div>
    </div>
    `;
}

        function renderClientsTab() {
            const filteredClients = getFilteredClients();
            
            return `
            <div class="space-y-8">
                <!-- Toolbar Clienti -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="bg-purple-100 p-4 rounded-xl">
                                <span class="text-2xl">üë•</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Gestione Clienti</h2>
                                <p class="text-gray-600">Gestione avanzata con zone multiple e budget</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="showImportModal()" 
                                    class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow flex items-center gap-2">
                                üìÅ Importa Excel
                            </button>
                            <button onclick="exportClientsToExcel()" 
                                    class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow flex items-center gap-2">
                                üì• Esporta Excel
                            </button>
                            <button onclick="showAddClientModal()" 
                                    class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow flex items-center gap-2">
                                ‚ûï Nuovo Cliente
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtri Avanzati -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filtra per zona</label>
                            <select id="filter-zone" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Tutte le zone</option>
                                ${Object.entries(zoneInfo).map(([code, info]) => `
                                    <option value="${code}" ${state.clientFilters.zone.includes(code) ? 'selected' : ''}>
                                        Zona ${code} - ${info.nome}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fascia budget</label>
                            <select id="filter-budget" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Tutte le fasce</option>
                                ${budgetFasce.map(fascia => `
                                    <option value="${fascia.id}" ${state.clientFilters.budget === fascia.id ? 'selected' : ''}>
                                        ${fascia.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stato</label>
                            <select id="filter-attivo" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Tutti</option>
                                <option value="SI" ${state.clientFilters.attivo === 'SI' ? 'selected' : ''}>Attivi</option>
                                <option value="NO" ${state.clientFilters.attivo === 'NO' ? 'selected' : ''}>Non attivi</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cerca</label>
                            <input type="text" 
                                   id="filter-search" 
                                   placeholder="Cognome, Nome, Note..."
                                   value="${state.clientFilters.search}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <!-- Statistiche -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
                            <p class="text-sm font-medium text-blue-700 mb-1">Clienti totali</p>
                            <p class="text-2xl font-bold text-blue-800">${state.clients.length}</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200">
                            <p class="text-sm font-medium text-green-700 mb-1">Multi-zona</p>
                            <p class="text-2xl font-bold text-green-800">${getClientiMultiZona()}</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200">
                            <p class="text-sm font-medium text-purple-700 mb-1">Budget alto</p>
                            <p class="text-2xl font-bold text-purple-800">${getClientiBudgetAlto()}</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200">
                            <p class="text-sm font-medium text-orange-700 mb-1">Con note</p>
                            <p class="text-2xl font-bold text-orange-800">${getClientiConNote()}</p>
                        </div>
                    </div>
                </div>

                <!-- Tabella Clienti -->
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">CODICE</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">COGNOME</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">NOME</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">TELEFONO / MAIL</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">STATO</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">ZONE</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">BUDGET</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">NOTE</th>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-700">AZIONI</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${filteredClients.length > 0 ? 
                                    filteredClients.map(client => renderClientRow(client)).join('') :
                                    `<tr><td colspan="9" class="py-8 text-center text-gray-500">Nessun cliente trovato</td></tr>`
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Legenda Zone -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üó∫Ô∏è Legenda Zone Provincia di Brescia</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        ${Object.entries(zoneInfo).map(([code, info]) => `
                            <div class="flex items-center gap-3 p-3 rounded-lg border ${getZonaColorClass(code, 'border')} ${getZonaColorClass(code, 'bg')}">
                                <span class="w-8 h-8 rounded-full ${getZonaColorClass(code, 'bg')} ${getZonaColorClass(code, 'text')} flex items-center justify-center font-bold border ${getZonaColorClass(code, 'border')}">
                                    ${code}
                                </span>
                                <div>
                                    <p class="font-medium ${getZonaColorClass(code, 'text')}">Zona ${code}</p>
                                    <p class="text-xs text-gray-600">${info.nome}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
        }

        function renderImportTab() {
            return `
            <div class="space-y-8">
                <!-- Importazione Excel -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="bg-green-100 p-4 rounded-xl">
                            <span class="text-2xl">üìÅ</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Importazione da Excel</h2>
                            <p class="text-gray-600">Carica il tuo file Excel con i clienti</p>
                        </div>
                    </div>
                    
                    <!-- Dropzone per file -->
                    <div class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-indigo-400 transition-colors bg-gray-50/50"
                         id="dropzone"
                         ondrop="handleDrop(event)"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="max-w-md mx-auto">
                            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üìÇ</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Trascina il file Excel qui</h3>
                            <p class="text-gray-600 mb-4">Supporta il formato .xlsx con schema clienti</p>
                            <input type="file" 
                                   id="file-input" 
                                   accept=".xlsx,.xls"
                                   class="hidden"
                                   onchange="handleFileSelect(event)">
                            <button onclick="document.getElementById('file-input').click()"
                                    class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-medium">
                                üóÇÔ∏è Seleziona File
                            </button>
                            <p class="text-sm text-gray-500 mt-4">Oppure trascina il file qui sopra</p>
                        </div>
                    </div>
                    
                    <!-- Anteprima dati importati -->
                    ${state.importedData && state.importedData.length > 0 ? `
                    <div class="mt-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Anteprima dati importati</h3>
                            <div class="text-sm text-gray-600">
                                ${state.importedData.length} record pronti per l'importazione
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CODICE</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">COGNOME</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NOME</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TELEFONO</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ATTIVO</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${state.importedData.slice(0, 5).map(client => `
                                        <tr>
                                            <td class="px-4 py-3 text-sm">${client.CUSTOMER_CODE || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm font-medium">${client.COGNOME || ''}</td>
                                            <td class="px-4 py-3 text-sm">${client.NOME || ''}</td>
                                            <td class="px-4 py-3 text-sm">${client.TELEFONO || '‚Äî'}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <span class="px-2 py-1 text-xs rounded-full ${client.ATTIVI === 'SI' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                    ${client.ATTIVI || 'SI'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        ${state.importedData.length > 5 ? `
                        <div class="mt-2 text-sm text-gray-500 text-center">
                            ... e altri ${state.importedData.length - 5} record
                        </div>
                        ` : ''}
                        
                        <!-- Pulsanti azione -->
                        <div class="mt-6 flex flex-wrap gap-3 justify-center">
                            <button onclick="clearImport()"
                                    class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                ‚ùå Annulla Importazione
                            </button>
                            <button onclick="confirmImport()"
                                    class="px-5 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-colors shadow">
                                ‚úÖ Importa ${state.importedData.length} Clienti
                            </button>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Istruzioni -->
                    <div class="mt-8 p-6 bg-blue-50 rounded-xl border border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-3">üìã Schema Excel consigliato:</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">COGNOME</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">NOME</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">CUSTOMER CODE</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">TELEFONO</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">MAIL</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">ATTIVI?</th>
                                        <th class="py-2 px-3 text-left text-sm font-medium text-blue-800 border">NOTE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="py-2 px-3 border text-sm">Rossi</td>
                                        <td class="py-2 px-3 border text-sm">Mario</td>
                                        <td class="py-2 px-3 border text-sm">1</td>
                                        <td class="py-2 px-3 border text-sm">1234567890</td>
                                        <td class="py-2 px-3 border text-sm">mario@email.com</td>
                                        <td class="py-2 px-3 border text-sm">SI</td>
                                        <td class="py-2 px-3 border text-sm">Interessato zona 1 e 7</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="p-3 bg-blue-100/50 rounded-lg">
                                <p class="text-sm font-medium text-blue-800">‚úÖ Formato supportato:</p>
                                <ul class="text-xs text-blue-700 mt-1 space-y-1">
                                    <li>‚Ä¢ File .xlsx o .xls</li>
                                    <li>‚Ä¢ Prima riga intestazioni</li>
                                    <li>‚Ä¢ Codifiche: UTF-8 consigliata</li>
                                </ul>
                            </div>
                            <div class="p-3 bg-yellow-100/50 rounded-lg">
                                <p class="text-sm font-medium text-yellow-800">‚ö†Ô∏è Note importanti:</p>
                                <ul class="text-xs text-yellow-700 mt-1 space-y-1">
                                    <li>‚Ä¢ Zone e budget vanno impostati manualmente</li>
                                    <li>‚Ä¢ Codici duplicati verranno automaticamente modificati</li>
                                    <li>‚Ä¢ I dati esistenti non vengono sovrascritti</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <p class="text-sm font-medium text-gray-800 mb-1">üîß Campi obbligatori:</p>
                            <p class="text-xs text-gray-600">COGNOME, NOME - gli altri campi sono opzionali e possono essere aggiunti successivamente</p>
                        </div>
                    </div>
                </div>
                
                <!-- Esempio file Excel scaricabile -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-purple-100 p-3 rounded-xl">
                            <span class="text-xl">üì•</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Template Excel pronti</h3>
                            <p class="text-gray-600">Scarica e compila questi template</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="downloadTemplate('base')"
                                class="p-4 border-2 border-gray-200 rounded-xl hover:border-blue-300 hover:bg-blue-50 transition-all text-left">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 p-2 rounded-lg">
                                    <span class="text-lg">üìã</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Template Base</p>
                                    <p class="text-sm text-gray-600">Schema minimo con campi essenziali</p>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="downloadTemplate('completo')"
                                class="p-4 border-2 border-gray-200 rounded-xl hover:border-green-300 hover:bg-green-50 transition-all text-left">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 p-2 rounded-lg">
                                    <span class="text-lg">üìä</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Template Completo</p>
                                    <p class="text-sm text-gray-600">Tutti i campi, inclusi zone e budget</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            `;
        }

        function renderClientRow(client) {
            const zoneBadges = (client.ZONE || []).map(zona => `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getZonaColorClass(zona)} border ${getZonaBorderClass(zona)}">
                    <span class="w-2 h-2 rounded-full mr-1 ${getZonaColorClass(zona, 'bg')}"></span>
                    ${zona}
                </span>
            `).join('');
            
            const budgetFascia = budgetFasce.find(f => f.id === client.BUDGET_FASCIA);
            const budgetLabel = budgetFascia ? budgetFascia.label : 'Non impostato';
            
            const notePreview = client.NOTE ? 
                (client.NOTE.length > 50 ? client.NOTE.substring(0, 50) + '...' : client.NOTE) : 
                '';
            
            return `
            <tr class="client-row hover:bg-gray-50">
                <td class="py-3 px-4">
                    <span class="font-mono font-bold text-indigo-600">${client.CUSTOMER_CODE}</span>
                </td>
                <td class="py-3 px-4 font-medium">${client.COGNOME}</td>
                <td class="py-3 px-4">${client.NOME}</td>
                <td class="py-3 px-4">
                    <div class="space-y-1">
                        <div class="font-mono text-sm">${client.TELEFONO || '‚Äî'}</div>
                        ${client.MAIL ? `
                            <a href="mailto:${client.MAIL}" class="text-blue-600 hover:text-blue-800 text-xs truncate block">
                                ${client.MAIL}
                            </a>
                        ` : '<span class="text-gray-400 text-xs">‚Äî</span>'}
                    </div>
                </td>
                <td class="py-3 px-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${client.ATTIVI === 'SI' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${client.ATTIVI}
                    </span>
                </td>
                <td class="py-3 px-4">
                    <div class="flex flex-wrap gap-1">
                        ${zoneBadges || '<span class="text-gray-400 text-sm">‚Äî</span>'}
                    </div>
                </td>
                <td class="py-3 px-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${budgetLabel}
                    </span>
                </td>
                <td class="py-3 px-4 text-sm text-gray-600 max-w-[200px] truncate" title="${client.NOTE || ''}">
                    ${notePreview || '‚Äî'}
                </td>
                <td class="py-3 px-4">
                    <div class="flex gap-2">
                        <button onclick="editClient('${client.CUSTOMER_CODE}')" 
                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Modifica">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deleteClient('${client.CUSTOMER_CODE}')" 
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Elimina">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
            `;
        }

        // Funzioni di supporto
        function getZonaColorClass(zona, type = 'all') {
            const info = zoneInfo[zona];
            if (!info) return '';
            
            const colors = {
                blue: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200' },
                teal: { bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200' },
                red: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-200' },
                indigo: { bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-200' },
                pink: { bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-200' },
                green: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-200' },
                orange: { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200' }
            };
            
            const colorSet = colors[info.colore] || colors.blue;
            
            if (type === 'bg') return colorSet.bg;
            if (type === 'text') return colorSet.text;
            if (type === 'border') return colorSet.border;
            
            return `${colorSet.bg} ${colorSet.text} ${colorSet.border}`;
        }

        function getZonaBorderClass(zona) {
            return getZonaColorClass(zona, 'border');
        }

        function getSourceColorClass(site) {
            const siteObj = SITES.find(s => s.name === site);
            if (!siteObj) return 'bg-gray-100 text-gray-800 hover:bg-gray-200';
            return `bg-${siteObj.color}-100 text-${siteObj.color}-800 hover:bg-${siteObj.color}-200`;
        }

        function getClientiAttivi() {
            return state.clients.filter(c => c.ATTIVI === 'SI').length;
        }

        function getClientiMultiZona() {
            return state.clients.filter(c => c.ZONE && c.ZONE.length > 1).length;
        }

        function getClientiBudgetAlto() {
            return state.clients.filter(c => c.BUDGET_FASCIA === 'under250' || c.BUDGET_FASCIA === 'nolimit').length;
        }

        function getClientiConNote() {
            return state.clients.filter(c => c.NOTE && c.NOTE.trim().length > 0).length;
        }

        function getUltimoCodice() {
            if (state.clients.length === 0) return '0';
            const codici = state.clients.map(c => parseInt(c.CUSTOMER_CODE) || 0);
            return Math.max(...codici);
        }

        function getFilteredClients() {
            let filtered = [...state.clients];
            
            // Filtro per zona
            if (state.clientFilters.zone && state.clientFilters.zone.length > 0) {
                filtered = filtered.filter(c => 
                    c.ZONE && c.ZONE.some(z => state.clientFilters.zone.includes(z))
                );
            }
            
            // Filtro per budget
            if (state.clientFilters.budget) {
                filtered = filtered.filter(c => c.BUDGET_FASCIA === state.clientFilters.budget);
            }
            
            // Filtro per stato attivo
            if (state.clientFilters.attivo) {
                filtered = filtered.filter(c => c.ATTIVI === state.clientFilters.attivo);
            }
            
            // Filtro per ricerca
            if (state.clientFilters.search) {
                const search = state.clientFilters.search.toLowerCase();
                filtered = filtered.filter(c => 
                    c.COGNOME.toLowerCase().includes(search) ||
                    c.NOME.toLowerCase().includes(search) ||
                    (c.NOTE && c.NOTE.toLowerCase().includes(search)) ||
                    c.CUSTOMER_CODE.includes(search)
                );
            }
            
            return filtered;
        }

        // ========== GESTIONE CLIENTI ==========
        function showAddClientModal() {
            const modalContent = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden mx-4">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">‚ûï Nuovo Cliente</h2>
                                <p class="text-indigo-200">Compila tutti i campi richiesti</p>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                √ó
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">COGNOME *</label>
                                    <input type="text" id="add-cognome" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NOME *</label>
                                    <input type="text" id="add-nome" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CUSTOMER CODE *</label>
                                    <input type="text" id="add-codice" 
                                           value="${parseInt(getUltimoCodice()) + 1}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg font-mono" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">STATO</label>
                                    <select id="add-attivo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                        <option value="SI" selected>Attivo (SI)</option>
                                        <option value="NO">Non attivo (NO)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">TELEFONO</label>
                                    <input type="tel" id="add-telefono" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">MAIL</label>
                                    <input type="email" id="add-mail" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">ZONE DI INTERESSE *</label>
                                <p class="text-xs text-gray-500 mb-3">Clicca per selezionare/deselezionare (puoi selezionare pi√π zone)</p>
                                <div class="grid grid-cols-4 gap-2" id="zone-selection">
                                    ${Object.entries(zoneInfo).map(([code, info]) => `
                                        <button type="button" 
                                                class="zone-btn p-3 rounded-lg border-2 border-gray-200 flex flex-col items-center justify-center hover:border-gray-300 transition-all"
                                                data-zone="${code}"
                                                onclick="toggleZoneSelection('${code}', this)">
                                            <span class="w-8 h-8 rounded-full ${getZonaColorClass(code, 'bg')} ${getZonaColorClass(code, 'text')} flex items-center justify-center font-bold text-lg mb-1 border ${getZonaColorClass(code, 'border')}">
                                                ${code}
                                            </span>
                                            <span class="text-xs font-medium text-gray-700">${info.nome.split(' ')[0]}</span>
                                            <span class="text-xs text-gray-500">${info.nome.split(' ').slice(1).join(' ')}</span>
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="selected-zones" value="">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">FASCIA DI BUDGET *</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="budget-selection">
                                    ${budgetFasce.map(fascia => `
                                        <button type="button"
                                                class="budget-btn p-3 rounded-lg border-2 border-gray-200 flex flex-col items-center justify-center hover:border-blue-300 transition-all"
                                                data-budget="${fascia.id}"
                                                onclick="selectBudget('${fascia.id}', this)">
                                            <span class="text-lg font-bold text-gray-700 mb-1">${fascia.label.replace('‚Ç¨', '')}</span>
                                            <span class="text-xs text-gray-500">${fascia.max ? `fino a ${fascia.max.toLocaleString('it-IT')}‚Ç¨` : 'senza limiti'}</span>
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="selected-budget" value="">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NOTE</label>
                                <textarea id="add-note" 
                                          rows="3"
                                          placeholder="Note aggiuntive sul cliente..."
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 p-6 bg-gray-50">
                        <div class="flex justify-between">
                            <button onclick="closeModal()" 
                                    class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="saveNewClient()" 
                                    class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">
                                üíæ Salva Cliente
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }

        function editClient(codice) {
            const cliente = state.clients.find(c => c.CUSTOMER_CODE === codice);
            if (!cliente) return;
            
            const modalContent = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden mx-4">
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">‚úèÔ∏è Modifica Cliente</h2>
                                <p class="text-blue-200">Codice: ${cliente.CUSTOMER_CODE}</p>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                √ó
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">COGNOME *</label>
                                    <input type="text" id="edit-cognome" value="${cliente.COGNOME}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NOME *</label>
                                    <input type="text" id="edit-nome" value="${cliente.NOME}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">STATO</label>
                                    <select id="edit-attivo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                        <option value="SI" ${cliente.ATTIVI === 'SI' ? 'selected' : ''}>Attivo (SI)</option>
                                        <option value="NO" ${cliente.ATTIVI === 'NO' ? 'selected' : ''}>Non attivo (NO)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">TELEFONO</label>
                                    <input type="tel" id="edit-telefono" value="${cliente.TELEFONO || ''}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">MAIL</label>
                                    <input type="email" id="edit-mail" value="${cliente.MAIL || ''}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">ZONE DI INTERESSE *</label>
                                <p class="text-xs text-gray-500 mb-3">Clicca per selezionare/deselezionare</p>
                                <div class="grid grid-cols-4 gap-2" id="edit-zone-selection">
                                    ${Object.entries(zoneInfo).map(([code, info]) => {
                                        const isSelected = cliente.ZONE && cliente.ZONE.includes(code);
                                        return `
                                            <button type="button" 
                                                    class="zone-btn p-3 rounded-lg border-2 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} flex flex-col items-center justify-center hover:border-gray-300 transition-all"
                                                    data-zone="${code}"
                                                    onclick="toggleZoneSelection('${code}', this, true)">
                                                <span class="w-8 h-8 rounded-full ${getZonaColorClass(code, 'bg')} ${getZonaColorClass(code, 'text')} flex items-center justify-center font-bold text-lg mb-1 border ${getZonaColorClass(code, 'border')}">
                                                    ${code}
                                                </span>
                                                <span class="text-xs font-medium text-gray-700">${info.nome.split(' ')[0]}</span>
                                                <span class="text-xs text-gray-500">${info.nome.split(' ').slice(1).join(' ')}</span>
                                                ${isSelected ? '<span class="absolute top-1 right-1 text-green-500">‚úì</span>' : ''}
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                                <input type="hidden" id="edit-selected-zones" value="${cliente.ZONE ? cliente.ZONE.join(',') : ''}">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">FASCIA DI BUDGET *</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="edit-budget-selection">
                                    ${budgetFasce.map(fascia => {
                                        const isSelected = cliente.BUDGET_FASCIA === fascia.id;
                                        return `
                                            <button type="button"
                                                    class="budget-btn p-3 rounded-lg border-2 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} flex flex-col items-center justify-center hover:border-blue-300 transition-all"
                                                    data-budget="${fascia.id}"
                                                    onclick="selectBudget('${fascia.id}', this, true)">
                                                <span class="text-lg font-bold ${isSelected ? 'text-blue-700' : 'text-gray-700'} mb-1">${fascia.label.replace('‚Ç¨', '')}</span>
                                                <span class="text-xs ${isSelected ? 'text-blue-600' : 'text-gray-500'}">${fascia.max ? `fino a ${fascia.max.toLocaleString('it-IT')}‚Ç¨` : 'senza limiti'}</span>
                                                ${isSelected ? '<span class="absolute top-1 right-1 text-blue-500">‚úì</span>' : ''}
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                                <input type="hidden" id="edit-selected-budget" value="${cliente.BUDGET_FASCIA || ''}">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NOTE</label>
                                <textarea id="edit-note" 
                                          rows="3"
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg">${cliente.NOTE || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 p-6 bg-gray-50">
                        <div class="flex justify-between">
                            <button onclick="deleteClient('${cliente.CUSTOMER_CODE}', true)" 
                                    class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                üóëÔ∏è Elimina
                            </button>
                            <div class="flex gap-3">
                                <button onclick="closeModal()" 
                                        class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg">
                                    Annulla
                                </button>
                                <button onclick="saveEditedClient('${cliente.CUSTOMER_CODE}')" 
                                        class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    üíæ Salva Modifiche
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }

        // Funzioni per gestione selezione
        function toggleZoneSelection(zone, buttonElement, isEdit = false) {
            const hiddenInput = document.getElementById(isEdit ? 'edit-selected-zones' : 'selected-zones');
            let selectedZones = hiddenInput.value ? hiddenInput.value.split(',').filter(z => z) : [];
            
            if (selectedZones.includes(zone)) {
                // Rimuovi zona
                selectedZones = selectedZones.filter(z => z !== zone);
                buttonElement.classList.remove('border-blue-500', 'bg-blue-50');
                buttonElement.classList.add('border-gray-200');
                const checkmark = buttonElement.querySelector('.absolute');
                if (checkmark) checkmark.remove();
            } else {
                // Aggiungi zona
                selectedZones.push(zone);
                buttonElement.classList.add('border-blue-500', 'bg-blue-50');
                buttonElement.classList.remove('border-gray-200');
                if (!buttonElement.querySelector('.absolute')) {
                    const checkmark = document.createElement('span');
                    checkmark.className = 'absolute top-1 right-1 text-green-500';
                    checkmark.textContent = '‚úì';
                    buttonElement.appendChild(checkmark);
                }
            }
            
            hiddenInput.value = selectedZones.join(',');
        }

        function selectBudget(budgetId, buttonElement, isEdit = false) {
            const hiddenInput = document.getElementById(isEdit ? 'edit-selected-budget' : 'selected-budget');
            
            // Rimuovi selezione da tutti i pulsanti
            const allButtons = document.querySelectorAll(isEdit ? '#edit-budget-selection button' : '#budget-selection button');
            allButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');
                const checkmark = btn.querySelector('.absolute');
                if (checkmark) checkmark.remove();
                
                const textSpan = btn.querySelector('.text-lg');
                const subSpan = btn.querySelector('.text-xs');
                if (textSpan) textSpan.className = 'text-lg font-bold text-gray-700 mb-1';
                if (subSpan) subSpan.className = 'text-xs text-gray-500';
            });
            
            // Seleziona il pulsante cliccato
            buttonElement.classList.add('border-blue-500', 'bg-blue-50');
            buttonElement.classList.remove('border-gray-200');
            
            const checkmark = document.createElement('span');
            checkmark.className = 'absolute top-1 right-1 text-blue-500';
            checkmark.textContent = '‚úì';
            buttonElement.appendChild(checkmark);
            
            const textSpan = buttonElement.querySelector('.text-lg');
            const subSpan = buttonElement.querySelector('.text-xs');
            if (textSpan) textSpan.className = 'text-lg font-bold text-blue-700 mb-1';
            if (subSpan) subSpan.className = 'text-xs text-blue-600';
            
            hiddenInput.value = budgetId;
        }

        function saveNewClient() {
            const selectedZones = document.getElementById('selected-zones').value.split(',').filter(z => z);
            const selectedBudget = document.getElementById('selected-budget').value;
            
            if (selectedZones.length === 0) {
                alert('Seleziona almeno una zona di interesse!');
                return;
            }
            
            if (!selectedBudget) {
                alert('Seleziona una fascia di budget!');
                return;
            }
            
            const cliente = {
                COGNOME: document.getElementById('add-cognome').value.trim(),
                NOME: document.getElementById('add-nome').value.trim(),
                CUSTOMER_CODE: document.getElementById('add-codice').value.trim(),
                TELEFONO: document.getElementById('add-telefono').value.trim(),
                MAIL: document.getElementById('add-mail').value.trim(),
                ATTIVI: document.getElementById('add-attivo').value,
                ZONE: selectedZones,
                BUDGET_FASCIA: selectedBudget,
                NOTE: document.getElementById('add-note').value.trim(),
                AREA_INTERESSE: selectedZones.map(z => `Zona ${z}`).join(', ')
            };
            
            if (!cliente.COGNOME || !cliente.NOME || !cliente.CUSTOMER_CODE) {
                alert('Compila i campi obbligatori: Cognome, Nome e Codice');
                return;
            }
            
            if (state.clients.some(c => c.CUSTOMER_CODE === cliente.CUSTOMER_CODE)) {
                alert(`Il codice cliente ${cliente.CUSTOMER_CODE} √® gi√† utilizzato.`);
                return;
            }
            
            state.clients.push(cliente);
            saveData();
            closeModal();
            render();
            alert(`‚úÖ Cliente ${cliente.COGNOME} ${cliente.NOME} aggiunto con successo!`);
        }

        function saveEditedClient(codice) {
            const index = state.clients.findIndex(c => c.CUSTOMER_CODE === codice);
            if (index === -1) return;
            
            const selectedZones = document.getElementById('edit-selected-zones').value.split(',').filter(z => z);
            const selectedBudget = document.getElementById('edit-selected-budget').value;
            
            if (selectedZones.length === 0) {
                alert('Seleziona almeno una zona di interesse!');
                return;
            }
            
            if (!selectedBudget) {
                alert('Seleziona una fascia di budget!');
                return;
            }
            
            state.clients[index] = {
                ...state.clients[index],
                COGNOME: document.getElementById('edit-cognome').value.trim(),
                NOME: document.getElementById('edit-nome').value.trim(),
                TELEFONO: document.getElementById('edit-telefono').value.trim(),
                MAIL: document.getElementById('edit-mail').value.trim(),
                ATTIVI: document.getElementById('edit-attivo').value,
                ZONE: selectedZones,
                BUDGET_FASCIA: selectedBudget,
                NOTE: document.getElementById('edit-note').value.trim(),
                AREA_INTERESSE: selectedZones.map(z => `Zona ${z}`).join(', ')
            };
            
            saveData();
            closeModal();
            render();
            alert('‚úÖ Cliente modificato con successo!');
        }

        function deleteClient(codice, fromModal = false) {
            if (!confirm(`Sei sicuro di voler eliminare il cliente con codice ${codice}?`)) {
                return;
            }
            
            state.clients = state.clients.filter(c => c.CUSTOMER_CODE !== codice);
            saveData();
            
            if (!fromModal) {
                render();
            } else {
                closeModal();
                render();
            }
            
            alert('‚úÖ Cliente eliminato!');
        }

        // ========== GESTIONE MODALI ==========
        function showModal(content) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    ${content}
                </div>
            `;
            
            setTimeout(() => {
                const overlay = modalContainer.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.onclick = (e) => {
                        if (e.target === overlay) closeModal();
                    };
                }
                document.addEventListener('keydown', handleEscKey);
            }, 100);
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            document.removeEventListener('keydown', handleEscKey);
        }

        function handleEscKey(e) {
            if (e.key === 'Escape') closeModal();
        }

        // ========== EVENT LISTENERS ==========
        function attachEventListeners() {
            // Login
            const loginBtn = document.getElementById('login-btn');
            const passwordInput = document.getElementById('password-input');
            const togglePassword = document.getElementById('toggle-password');
            
            if (loginBtn) loginBtn.onclick = handleLogin;
            if (passwordInput) {
                passwordInput.oninput = (e) => state.password = e.target.value;
                passwordInput.onkeypress = (e) => { if (e.key === 'Enter') handleLogin(); };
            }
            if (togglePassword) {
                togglePassword.onclick = () => {
                    state.showPassword = !state.showPassword;
                    render();
                };
            }
            
            // Main app
            const logoutBtn = document.getElementById('logout-btn');
            const tabSearch = document.getElementById('tab-search');
            const tabClients = document.getElementById('tab-clients');
            const tabImport = document.getElementById('tab-import');
            const searchBtn = document.getElementById('search-btn');
            
            if (logoutBtn) logoutBtn.onclick = handleLogout;
            if (tabSearch) tabSearch.onclick = () => { 
                state.activeTab = 'search'; 
                state.showClientSuggestions = false;
                state.selectedAnnuncio = null;
                render(); 
            };
            if (tabClients) tabClients.onclick = () => { 
                state.activeTab = 'clients'; 
                state.showClientSuggestions = false;
                state.selectedAnnuncio = null;
                render(); 
            };
            if (tabImport) tabImport.onclick = () => { 
                state.activeTab = 'import'; 
                state.showClientSuggestions = false;
                state.selectedAnnuncio = null;
                render(); 
            };
            if (searchBtn) searchBtn.onclick = performSearch;
            
            // Filters ricerca
            const filterComune = document.getElementById('filter-comune');
            const filterTipologia = document.getElementById('filter-tipologia');
            const filterPrezzoMin = document.getElementById('filter-prezzo-min');
            const filterPrezzoMax = document.getElementById('filter-prezzo-max');
            
            if (filterComune) filterComune.oninput = (e) => { state.filters.comune = e.target.value; };
            if (filterTipologia) filterTipologia.onchange = (e) => { state.filters.tipologia = e.target.value; };
            if (filterPrezzoMin) filterPrezzoMin.oninput = (e) => { state.filters.prezzoMin = e.target.value; };
            if (filterPrezzoMax) filterPrezzoMax.oninput = (e) => { state.filters.prezzoMax = e.target.value; };
            
            // Filtri clienti
            const filterZone = document.getElementById('filter-zone');
            const filterBudget = document.getElementById('filter-budget');
            const filterAttivo = document.getElementById('filter-attivo');
            const filterSearch = document.getElementById('filter-search');
            
            if (filterZone) filterZone.onchange = (e) => { 
                state.clientFilters.zone = e.target.value ? [e.target.value] : [];
                render();
            };
            if (filterBudget) filterBudget.onchange = (e) => { 
                state.clientFilters.budget = e.target.value;
                render();
            };
            if (filterAttivo) filterAttivo.onchange = (e) => { 
                state.clientFilters.attivo = e.target.value;
                render();
            };
            if (filterSearch) {
                filterSearch.oninput = debounce((e) => {
                    state.clientFilters.search = e.target.value;
                    render();
                }, 300);
            }
        }

        function handleLogin() {
            if (state.password === MASTER_PASSWORD) {
                state.isAuthenticated = true;
                state.password = '';
                loadInitialData();
                render();
            } else {
                alert('Password non corretta. Usa: aste2025');
            }
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.searchResults = [];
            state.showClientSuggestions = false;
            state.selectedAnnuncio = null;
            render();
        }

        // ========== RICERCA ASTE ==========
// ========== SISTEMA DI SCRAPING INTEGRATO ==========

// Modifica la funzione performSearch() per avere 3 opzioni:
function performSearch() {
    const scelta = prompt(
        "üîç MODALIT√Ä RICERCA\n\n" +
        "Scegli:\n" +
        "1. DEMO (annunci simulati)\n" +
        "2. RICERCA REALE (apre siti)\n" +
        "3. SCRAPING AUTOMATICO (estrae dati)\n\n" +
        "Digita 1, 2 o 3:"
    );
    
    if (scelta === '1') {
        // DEMO - Annunci simulati
        avviaDemo();
    } else if (scelta === '2') {
        // RICERCA REALE - Apre i siti
        avviaRicercheReali();
    } else if (scelta === '3') {
        // SCRAPING - Estrae dati automaticamente
        avviaScrapingAutomatico();
    } else {
        alert("Operazione annullata");
    }
}

// Aggiungi questa nuova funzione per lo scraping:
async function avviaScrapingAutomatico() {
    if (!state.filters.comune) {
        alert("‚ö†Ô∏è Inserisci almeno un Comune per lo scraping.");
        return;
    }
    
    state.isLoading = true;
    state.searchStatus = 'üöÄ Avvio scraping automatico...';
    render();
    
    try {
        // Mostra il pannello di controllo scraping
        mostraPannelloControlloScraping();
        
        // Avvia lo scraping (simulato per ora)
        const risultati = await eseguiScrapingSiti();
        
        // Esegui matching con clienti
        const matches = await eseguiMatchingClienti(risultati);
        
        // Aggiorna stato
        state.searchResults = risultati;
        state.isLoading = false;
        state.searchStatus = `‚úÖ Scraping completato: ${risultati.length} annunci, ${matches.length} match`;
        
        // Mostra risultati
        render();
        initMap();
        
        // Mostra report match
        if (matches.length > 0) {
            mostraReportMatch(matches);
        }
        
    } catch (error) {
        console.error('Errore scraping:', error);
        state.isLoading = false;
        state.searchStatus = '‚ùå Errore durante lo scraping';
        render();
        alert('Errore durante lo scraping automatico.');
    }
}

// Funzione per eseguire lo scraping (VERSIONE SIMULATA - da implementare)
async function eseguiScrapingSiti() {
    const comune = state.filters.comune;
    const tipologia = state.filters.tipologia;
    
    // SIMULAZIONE - Nella realt√† qui farebbe scraping vero
    alert(`‚ö†Ô∏è SCRAPING SIMULATO\n\nNella versione reale, il sistema:\n1. Visiterebbe i siti web\n2. Estrarrebbe dati reali\n3. Analizzerebbe i risultati\n\nPer ora mostro dati di esempio.`);
    
    // Dati di esempio basati sui filtri
    const risultati = [];
    const numRisultati = 8;
    
    for (let i = 1; i <= numRisultati; i++) {
        const prezzi = [45000, 75000, 120000, 185000, 240000, 320000];
        const tipologie = tipologia ? [tipologia] : ['Appartamento', 'Villa', 'Attico', 'Terreno'];
        const localitaSuffix = ['Centro', 'Nord', 'Sud', 'Zona Storica', 'Periferia'];
        
        const risultato = {
            id: Date.now() + i,
            tipologia: tipologie[Math.floor(Math.random() * tipologie.length)],
            indirizzo: `Via ${['Roma', 'Milano', 'Venezia', 'Dante'][Math.floor(Math.random() * 4)]} ${Math.floor(Math.random() * 200) + 1}`,
            comune: comune,
            prezzo: prezzi[Math.floor(Math.random() * prezzi.length)],
            descrizione: `${tipologie[0]} di ${Math.floor(Math.random() * 200) + 50} mq a ${comune} ${localitaSuffix[Math.floor(Math.random() * localitaSuffix.length)]}. Immobile in ottime condizioni, asta giudiziaria in corso.`,
            dataAsta: `${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}/${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}/2024`,
            metriQuadrati: Math.floor(Math.random() * 200) + 50,
            locali: Math.floor(Math.random() * 6) + 1,
            coordinate: coordinateBrescia[comune] || coordinateComuni[comune] || MAP_CENTER,
            fonti: [
                { nome: 'Asta Legale', icon: '‚öñÔ∏è', url: 'https://www.astalegale.net/' },
                { nome: 'Immobiliare.it', icon: 'üè†', url: 'https://www.immobiliare.it/' }
            ].slice(0, Math.floor(Math.random() * 2) + 1),
            urlEsempio: `https://www.example-aste.com/annuncio/${Math.floor(Math.random() * 10000)}`,
            // Nuovi campi per lo scraping
            source: ['Asta Legale', 'Astagiudiziaria', 'Immobiliare.it'][Math.floor(Math.random() * 3)],
            matchScore: 0,
            dataScraping: new Date().toISOString()
        };
        
        risultati.push(risultato);
    }
    
    // Simula ritardo di rete
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    return risultati;
}

// Funzione per matchare con i clienti
async function eseguiMatchingClienti(annunci) {
    if (state.clients.length === 0) {
        return [];
    }
    
    const matches = [];
    
    annunci.forEach((annuncio, annuncioIndex) => {
        state.clients.forEach(cliente => {
            let score = 0;
            const reasons = [];
            
            // 1. Match per zona (40 punti)
            const zonaAnnuncio = getZonaDaComune(annuncio.comune);
            if (zonaAnnuncio && cliente.ZONE && cliente.ZONE.includes(zonaAnnuncio)) {
                score += 40;
                reasons.push(`Zona ${zonaAnnuncio} compatibile`);
            }
            
            // 2. Match per budget (30 punti)
            const budgetFascia = budgetFasce.find(f => f.id === cliente.BUDGET_FASCIA);
            if (budgetFascia) {
                if (budgetFascia.max === null || annuncio.prezzo <= budgetFascia.max) {
                    score += 30;
                    reasons.push(`Budget compatibile (${budgetFascia.label})`);
                } else if (annuncio.prezzo <= budgetFascia.max * 1.2) {
                    score += 15;
                    reasons.push(`Budget leggermente superiore`);
                }
            }
            
            // 3. Match per tipologia (20 punti)
            if (cliente.tipologiePreferite && cliente.tipologiePreferite.includes(annuncio.tipologia)) {
                score += 20;
                reasons.push(`Tipologia "${annuncio.tipologia}" preferita`);
            }
            
            // 4. Bonus per match forte (10 punti)
            if (score >= 60) {
                score = Math.min(100, score + 10);
                reasons.push(`Match eccellente!`);
            }
            
            // Salva match se significativo
            if (score >= 50) {
                matches.push({
                    clientId: cliente.CUSTOMER_CODE,
                    clientName: `${cliente.COGNOME} ${cliente.NOME}`,
                    clientPhone: cliente.TELEFONO,
                    annuncioIndex: annuncioIndex,
                    score: score,
                    reasons: reasons,
                    annuncioPrezzo: annuncio.prezzo,
                    annuncioTipologia: annuncio.tipologia,
                    annuncioLocalita: `${annuncio.comune} (Zona ${zonaAnnuncio || '?'})`
                });
                
                // Aggiorna score nell'annuncio
                annuncio.matchScore = Math.max(annuncio.matchScore, score);
            }
        });
    });
    
    // Ordina per score decrescente
    matches.sort((a, b) => b.score - a.score);
    
    return matches;
}

// Nuovo pannello di controllo scraping
function mostraPannelloControlloScraping() {
    const modalContent = `
        <div style="padding: 20px; max-width: 600px; background: white; border-radius: 12px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #3b82f6; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <span style="font-size: 28px;">ü§ñ</span>
                </div>
                <h2 style="margin: 0; color: #1f2937; font-size: 22px; font-weight: bold;">
                    Scraping Automatico
                </h2>
                <p style="margin: 10px 0 0 0; color: #6b7280;">
                    Analisi in corso per: <strong>${state.filters.comune}</strong>
                </p>
            </div>
            
            <div style="margin: 25px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 14px; color: #4b5563;">Progresso</span>
                    <span style="font-size: 14px; color: #4b5563; font-weight: bold;" id="scraping-progress">0%</span>
                </div>
                <div style="width: 100%; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden;">
                    <div id="scraping-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 5px; transition: width 0.5s;"></div>
                </div>
            </div>
            
            <div id="scraping-steps" style="margin: 25px 0;">
                <div class="scraping-step" style="padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #d1d5db; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; color: white;">1</div>
                    <span style="color: #6b7280;">Inizializzazione scraping...</span>
                </div>
                <div class="scraping-step" style="padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #d1d5db; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; color: white;">2</div>
                    <span style="color: #6b7280;">Connessione ai siti...</span>
                </div>
                <div class="scraping-step" style="padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #d1d5db; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; color: white;">3</div>
                    <span style="color: #6b7280;">Estrazione dati...</span>
                </div>
                <div class="scraping-step" style="padding: 12px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #d1d5db; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; color: white;">4</div>
                    <span style="color: #6b7280;">Matching con clienti...</span>
                </div>
            </div>
            
            <div style="text-align: center; color: #6b7280; font-size: 13px; margin-top: 20px;">
                <p>‚è±Ô∏è Tempo stimato: 15-30 secondi</p>
            </div>
        </div>
    `;
    
    showModal(modalContent);
    
    // Animazione progresso (simulata)
    let progress = 0;
    const interval = setInterval(() => {
        progress += 2;
        const progressBar = document.getElementById('scraping-progress-bar');
        const progressText = document.getElementById('scraping-progress');
        const steps = document.querySelectorAll('.scraping-step');
        
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (progressText) progressText.textContent = `${progress}%`;
        
        // Aggiorna stati dei passaggi
        if (progress >= 25 && progress < 50) {
            steps[0].style.background = '#d1fae5';
            steps[0].querySelector('div').style.background = '#10b981';
            steps[0].querySelector('span').style.color = '#065f46';
        } else if (progress >= 50 && progress < 75) {
            steps[1].style.background = '#d1fae5';
            steps[1].querySelector('div').style.background = '#10b981';
            steps[1].querySelector('span').style.color = '#065f46';
        } else if (progress >= 75 && progress < 100) {
            steps[2].style.background = '#d1fae5';
            steps[2].querySelector('div').style.background = '#10b981';
            steps[2].querySelector('span').style.color = '#065f46';
        } else if (progress >= 100) {
            steps[3].style.background = '#d1fae5';
            steps[3].querySelector('div').style.background = '#10b981';
            steps[3].querySelector('span').style.color = '#065f46';
            clearInterval(interval);
            
            // Chiudi modale dopo 1 secondo
            setTimeout(() => {
                closeModal();
            }, 1000);
        }
    }, 100);
}

// Funzione per mostrare report match
function mostraReportMatch(matches) {
    const matchesAlti = matches.filter(m => m.score >= 70);
    const matchesMedi = matches.filter(m => m.score >= 50 && m.score < 70);
    
    let report = `üìä REPORT MATCHING AUTOMATICO\n\n`;
    report += `üîç Ricerca: ${state.filters.comune}\n`;
    report += `üìÖ Data: ${new Date().toLocaleDateString('it-IT')}\n`;
    report += `üë• Clienti nel sistema: ${state.clients.length}\n`;
    report += `üè† Annunci trovati: ${state.searchResults.length}\n\n`;
    report += `üíñ MATCH TROVATI:\n`;
    report += `‚úÖ Match alti (70%+): ${matchesAlti.length}\n`;
    report += `‚ö†Ô∏è Match medi (50-69%): ${matchesMedi.length}\n\n`;
    
    if (matchesAlti.length > 0) {
        report += `üèÜ TOP MATCH:\n`;
        matchesAlti.slice(0, 3).forEach((match, i) => {
            const cliente = state.clients.find(c => c.CUSTOMER_CODE === match.clientId);
            report += `${i+1}. ${cliente?.COGNOME || 'Cliente'} ${match.score}%\n`;
            report += `   üìû ${match.clientPhone || 'N/A'}\n`;
            report += `   üí∞ ${formatEuro(match.annuncioPrezzo)}\n`;
            report += `   üè† ${match.annuncioTipologia} a ${match.annuncioLocalita}\n\n`;
        });
    }
    
    // Mostra alert con report
    alert(report);
    
    // Mostra anche modale con dettagli
    if (matches.length > 0) {
        const modalContent = `
            <div style="padding: 20px; max-width: 700px; max-height: 80vh; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                    <h2 style="margin: 0; color: #1f2937; font-size: 22px; font-weight: bold;">
                        ü§ù Match Trovati
                    </h2>
                    <button onclick="closeModal()" 
                            style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0;">
                        √ó
                    </button>
                </div>
                
                <div style="flex: 1; overflow-y: auto; padding-right: 10px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        ${matches.slice(0, 6).map(match => {
                            const cliente = state.clients.find(c => c.CUSTOMER_CODE === match.clientId);
                            const annuncio = state.searchResults[match.annuncioIndex];
                            
                            return `
                                <div style="border: 1px solid ${match.score >= 70 ? '#d1fae5' : match.score >= 50 ? '#fef3c7' : '#fee2e2'}; 
                                         border-radius: 10px; overflow: hidden; background: ${match.score >= 70 ? '#f0fdf4' : match.score >= 50 ? '#fffbeb' : '#fef2f2'};">
                                    <div style="padding: 15px; border-bottom: 1px solid ${match.score >= 70 ? '#d1fae5' : match.score >= 50 ? '#fef3c7' : '#fee2e2'};">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <div style="font-weight: bold; color: #1f2937;">${cliente?.COGNOME || ''} ${cliente?.NOME || ''}</div>
                                            <div style="font-weight: bold; color: ${match.score >= 70 ? '#059669' : match.score >= 50 ? '#d97706' : '#dc2626'};">
                                                ${match.score}%
                                            </div>
                                        </div>
                                        <div style="font-size: 13px; color: #6b7280;">
                                            üìû ${match.clientPhone || 'N/A'} | üè† ${match.annuncioTipologia}
                                        </div>
                                    </div>
                                    
                                    <div style="padding: 15px; background: white;">
                                        <div style="font-size: 14px; color: #1f2937; margin-bottom: 8px;">
                                            ${annuncio?.tipologia || ''} a ${match.annuncioLocalita}
                                        </div>
                                        <div style="font-size: 16px; font-weight: bold; color: #059669; margin-bottom: 10px;">
                                            ${formatEuro(match.annuncioPrezzo)}
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">
                                            ${match.reasons.slice(0, 2).join(', ')}
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="contattaPerMatch('${match.clientId}', ${match.annuncioIndex})"
                                                    style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                                üìû Contatta
                                            </button>
                                            <button onclick="mostraDettaglioAnnuncioScraping(${match.annuncioIndex})"
                                                    style="flex: 1; padding: 8px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                                üëÅÔ∏è Vedi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                    <div style="text-align: center;">
                        <button onclick="closeModal()" 
                                style="padding: 10px 30px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            Chiudi
                        </button>
                        ${matches.length > 6 ? `
                            <button onclick="mostraTuttiMatch()" 
                                    style="margin-left: 10px; padding: 10px 30px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                Vedi tutti (${matches.length})
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        showModal(modalContent);
    }
}

// Funzioni helper per il matching
function formatEuro(amount) {
    return '‚Ç¨' + parseInt(amount).toLocaleString('it-IT', {minimumFractionDigits: 2});
}

function contattaPerMatch(clientId, annuncioIndex) {
    const cliente = state.clients.find(c => c.CUSTOMER_CODE === clientId);
    const annuncio = state.searchResults[annuncioIndex];
    
    if (cliente && annuncio) {
        const messaggio = `Ciao ${cliente.NOME}, ho trovato un'asta perfetta per te!\n\n` +
                         `üè† ${annuncio.tipologia}\n` +
                         `üìç ${annuncio.indirizzo}, ${annuncio.comune}\n` +
                         `üí∞ ${formatEuro(annuncio.prezzo)}\n` +
                         `üìÖ Asta: ${annuncio.dataAsta}\n\n` +
                         `Chiamami per maggiori dettagli!`;
        
        alert(`üìû CONTATTA CLIENTE\n\n${cliente.COGNOME} ${cliente.NOME}\nTelefono: ${cliente.TELEFONO}\n\nüí° Suggerimento:\n"${messaggio}"`);
    }
}

function mostraDettaglioAnnuncioScraping(index) {
    const annuncio = state.searchResults[index];
    showAnnuncioDetails(annuncio.id);
}

function mostraTuttiMatch() {
    // Implementazione per mostrare tutti i match
    alert(`Mostrare tutti i ${state.searchResults.filter(a => a.matchScore > 0).length} annunci con match`);
}

function deduplicateResults(results) {
    const seen = new Set();
    const deduplicated = [];
    
    for (const result of results) {
        const key = `${result.comune}_${result.indirizzo.split(' ')[0]}_${Math.floor(result.prezzo / 10000)}`;
        if (!seen.has(key)) {
            seen.add(key);
            deduplicated.push(result);
        }
    }
    
    return deduplicated;
}

// ========== RICERCA REALE SUI SITI ==========

// Funzione per costruire URL di ricerca REALI per ogni sito

// ========== URL REALI E TESTATI (2024) ==========
function costruisciUrlRicercaReale(site, filtri) {
    const comune = filtri.comune ? filtri.comune.trim() : '';
    const tipologia = filtri.tipologia ? filtri.tipologia.toLowerCase() : '';
    
    if (!comune) return site.url;
    
    const comuneFormatted = comune.toLowerCase().replace(/\s+/g, '-');
    const comuneEncoded = encodeURIComponent(comune);
    
    // URL REALMENTE TESTATI E FUNZIONANTI
    const templates = {
        // === SITI CON RICERCA DIRETTA FUNZIONANTE ===
        'Asta Legale': `https://www.astalegale.net/ricerca/?ricerca=${comuneEncoded}`,
        'Astagiudiziaria': `https://www.astagiudiziaria.com/ricerca?keyword=${comuneEncoded}`,
        'Aste online': `https://www.asteonline.it/ricerca-aste?keyword=${comuneEncoded}`,
        'Asteannunci': `https://www.asteannunci.it/ricerca?q=${comuneEncoded}`,
        'Asteavvisi': `https://www.asteavvisi.it/ricerca/?testo=${comuneEncoded}`,
        'Immobiliare.it': `https://www.immobiliare.it/aste-immobiliari/${comuneFormatted}/`,
        
        // === SITI CON RICERCA AVANZATA ===
        'Astetribunali24': `https://astetribunali24.ilsole24ore.com/ricerca?search=${comuneEncoded}&type=immobili`,
        'Canale Aste': `https://www.canaleaste.it/aste/?s=${comuneEncoded}`,
        'Fallimenti.it': `https://www.fallimenti.it/ricerca-aste/?comune=${comuneEncoded}`,
        'Gorealbid': `https://www.gobidreal.it/it/aste-immobili/?search=${comuneEncoded}`,
        'Legalmente': `https://legalmente.net/ricerca-aste/?q=${comuneEncoded}`,
        'Mercury': `https://www.mercury-auctions.com/it_it/ricerca/?keyword=${comuneEncoded}`,
        'Repubblica': `https://annunci.repubblica.it/aste-immobiliari/ricerca?q=${comuneEncoded}`,
        
        // === SITI CHE USANO GOOGLE SITE SEARCH ===
        'Astegiudiziarie': `https://www.google.com/search?q=site:astegiudiziarie.it+${comuneEncoded}+asta+immobiliare`,
        'Enti e Tribunali': `https://www.google.com/search?q=site:entietribunali.it+${comuneEncoded}`,
        'FALLCO Aste': `https://www.google.com/search?q=site:fallcoaste.it+${comuneEncoded}`,
        'Gara Virtuale': `https://www.google.com/search?q=site:garavirtuale.it+${comuneEncoded}+immobili`,
        'SIVAG': `https://www.google.com/search?q=site:sivag.com+${comuneEncoded}+asta`,
        'Aste Book': `https://www.google.com/search?q=site:astebook.it+${comuneEncoded}`,
        
        // === SITI CON NAVIGAZIONE ASSISTITA ===
        'PVP': `https://pvp.giustizia.it/pvp/struttura/struttura.do`, // Pagina di ricerca
        'Vendite Notartel': `https://venditepubblichenotarili.notariato.it/it/ricerca`, // Form di ricerca
        'Avvisi Notartel': `https://avvisinotarili.notariato.it/it/ricerca-avvisi` // Form di ricerca
    };
    
    return templates[site.name] || site.url;
}

// ========== SISTEMA INTELLIGENTE DI RICERCA ==========
function avviaRicercheReali() {
    if (!state.filters.comune) {
        alert("‚ö†Ô∏è Inserisci un Comune per effettuare la ricerca reale.");
        return;
    }
    
    const comune = state.filters.comune.trim();
    const filtriCompleti = {
        comune: comune,
        tipologia: state.filters.tipologia,
        prezzoMin: state.filters.prezzoMin,
        prezzoMax: state.filters.prezzoMax
    };
    
    // Mostra il pannello intelligente
    mostraPannelloRicercaIntelligente(comune, filtriCompleti);
}

// ========== PANNELLO INTELLIGENTE ==========
function mostraPannelloRicercaIntelligente(comune, filtri) {
    const comuneEncoded = encodeURIComponent(comune);
    const comuneFormatted = comune.toLowerCase().replace(/\s+/g, '+');
    
    // Raggruppa i siti per strategia
    const strategie = {
        diretta: SITES.filter(site => 
            ['Asta Legale', 'Astagiudiziaria', 'Aste online', 'Asteannunci', 
             'Asteavvisi', 'Immobiliare.it', 'Astetribunali24', 'Canale Aste',
             'Fallimenti.it', 'Gorealbid', 'Legalmente', 'Mercury', 'Repubblica']
            .includes(site.name)
        ),
        google: SITES.filter(site => 
            ['Astegiudiziarie', 'Enti e Tribunali', 'FALLCO Aste', 
             'Gara Virtuale', 'SIVAG', 'Aste Book']
            .includes(site.name)
        ),
        assistita: SITES.filter(site => 
            ['PVP', 'Vendite Notartel', 'Avvisi Notartel']
            .includes(site.name)
        )
    };
    
    let modalContent = `
        <div style="padding: 20px; max-width: 800px; max-height: 85vh; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <div>
                    <h2 style="margin: 0; color: #1f2937; font-size: 22px; font-weight: bold;">
                        üöÄ Ricerca Intelligente per "${comune}"
                    </h2>
                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">
                        ${SITES.length} siti a confronto - Strategie multiple
                    </p>
                </div>
                <button onclick="closeModal()" 
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0;">
                    √ó
                </button>
            </div>
            
            <!-- Filtri applicati -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #4b5563;">üéØ Filtri applicati:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                    <div><strong>Comune:</strong> ${comune}</div>
                    ${filtri.tipologia ? `<div><strong>Tipologia:</strong> ${filtri.tipologia}</div>` : ''}
                    ${filtri.prezzoMin ? `<div><strong>Prezzo min:</strong> ‚Ç¨${parseInt(filtri.prezzoMin).toLocaleString('it-IT')}</div>` : ''}
                    ${filtri.prezzoMax ? `<div><strong>Prezzo max:</strong> ‚Ç¨${parseInt(filtri.prezzoMax).toLocaleString('it-IT')}</div>` : ''}
                </div>
            </div>
            
            <!-- Contenuto scorrevole -->
            <div style="flex: 1; overflow-y: auto; padding-right: 10px;">
                
                <!-- STRATEGIA 1: Ricerca diretta -->
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="background: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            1
                        </div>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: bold;">
                            üîó Ricerca Diretta
                        </h3>
                    </div>
                    <p style="margin: 0 0 15px 0; color: #6b7280; font-size: 14px;">
                        Siti con ricerca funzionante - Clicca e troverai subito risultati per "${comune}"
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
    `;
    
    // Siti con ricerca diretta
    strategie.diretta.forEach(site => {
        const searchUrl = costruisciUrlRicercaReale(site, filtri);
        modalContent += `
            <a href="${searchUrl}" 
               target="_blank"
               onclick="trackSearchClick('${site.name}')"
               style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
                      background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; 
                      text-decoration: none; color: #374151; transition: all 0.2s; cursor: pointer;"
               onmouseover="this.style.background='#dcfce7'; this.style.borderColor='#86efac'"
               onmouseout="this.style.background='#f0fdf4'; this.style.borderColor='#bbf7d0'">
                <span style="font-size: 20px;">${site.icon}</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${site.name}
                    </div>
                    <div style="font-size: 11px; color: #059669; margin-top: 2px;">
                        üîó Link diretto funzionante
                    </div>
                </div>
                <span style="color: #10b981; font-size: 14px;">‚ÜóÔ∏è</span>
            </a>
        `;
    });
    
    modalContent += `
                    </div>
                </div>
                
                <!-- STRATEGIA 2: Ricerca Google -->
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="background: #3b82f6; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            2
                        </div>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: bold;">
                            üîç Ricerca tramite Google
                        </h3>
                    </div>
                    <p style="margin: 0 0 15px 0; color: #6b7280; font-size: 14px;">
                        Google cercher√† "${comune}" solo su questi siti specifici
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
    `;
    
    // Siti con ricerca Google
    strategie.google.forEach(site => {
        const searchUrl = costruisciUrlRicercaReale(site, filtri);
        modalContent += `
            <a href="${searchUrl}" 
               target="_blank"
               onclick="trackSearchClick('${site.name}')"
               style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
                      background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; 
                      text-decoration: none; color: #374151; transition: all 0.2s; cursor: pointer;"
               onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'"
               onmouseout="this.style.background='#eff6ff'; this.style.borderColor='#bfdbfe'">
                <span style="font-size: 20px;">${site.icon}</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${site.name}
                    </div>
                    <div style="font-size: 11px; color: #3b82f6; margin-top: 2px;">
                        üîç Ricerca tramite Google
                    </div>
                </div>
                <span style="color: #3b82f6; font-size: 14px;">‚ÜóÔ∏è</span>
            </a>
        `;
    });
    
    modalContent += `
                    </div>
                </div>
                
                <!-- STRATEGIA 3: Navigazione assistita -->
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div style="background: #8b5cf6; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            3
                        </div>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: bold;">
                            üõ†Ô∏è Navigazione Assistita
                        </h3>
                    </div>
                    <p style="margin: 0 0 15px 0; color: #6b7280; font-size: 14px;">
                        Siti complessi - Apri la pagina di ricerca e inserisci "${comune}" manualmente
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
    `;
    
    // Siti con navigazione assistita
    strategie.assistita.forEach(site => {
        const searchUrl = costruisciUrlRicercaReale(site, filtri);
        modalContent += `
            <a href="${searchUrl}" 
               target="_blank"
               onclick="trackSearchClick('${site.name}')"
               style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
                      background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 8px; 
                      text-decoration: none; color: #374151; transition: all 0.2s; cursor: pointer;"
               onmouseover="this.style.background='#f3e8ff'; this.style.borderColor='#d8b4fe'"
               onmouseout="this.style.background='#faf5ff'; this.style.borderColor='#e9d5ff'">
                <span style="font-size: 20px;">${site.icon}</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${site.name}
                    </div>
                    <div style="font-size: 11px; color: #8b5cf6; margin-top: 2px;">
                        üõ†Ô∏è Apri e cerca manualmente
                    </div>
                </div>
                <span style="color: #8b5cf6; font-size: 14px;">‚ÜóÔ∏è</span>
            </a>
        `;
    });
    
    modalContent += `
                    </div>
                    
                    <!-- Istruzioni per siti complessi -->
                    <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a;">
                        <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px; font-weight: bold;">üìã Istruzioni per siti complessi:</h4>
                        <ol style="margin: 0; padding-left: 20px; color: #92400e; font-size: 13px; line-height: 1.6;">
                            <li><strong>Clicca sul sito</strong> per aprire la pagina di ricerca</li>
                            <li><strong>Cerca il campo "Comune" o "Localit√†"</strong></li>
                            <li><strong>Digita "${comune}"</strong> nel campo di ricerca</li>
                            <li><strong>Seleziona "Immobili"</strong> come tipologia</li>
                            <li><strong>Clicca su "Cerca"</strong> per vedere i risultati</li>
                        </ol>
                    </div>
                </div>
                
                <!-- RICERCA GENERICA GOOGLE -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; border: 1px solid #bae6fd;">
                    <h3 style="margin: 0 0 10px 0; color: #0369a1; font-size: 18px; font-weight: bold;">
                        üåê Ricerca Globale su Google
                    </h3>
                    <p style="margin: 0 0 15px 0; color: #0c4a6e; font-size: 14px;">
                        Cerca "${comune}" su TUTTI i siti di aste contemporaneamente
                    </p>
                    <button onclick="window.open('https://www.google.com/search?q=${comuneFormatted}+asta+immobiliare+giudiziaria+2024', '_blank')" 
                            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #0ea5e9, #3b82f6); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        üîç Cerca "aste ${comune}" su Google
                    </button>
                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        <button onclick="window.open('https://www.google.com/search?q=${comuneFormatted}+asta+giudiziaria', '_blank')" 
                                style="padding: 8px 16px; background: white; border: 1px solid #bae6fd; border-radius: 6px; color: #0369a1; cursor: pointer; font-size: 13px;">
                            Asta giudiziaria
                        </button>
                        <button onclick="window.open('https://www.google.com/search?q=${comuneFormatted}+asta+notarile', '_blank')" 
                                style="padding: 8px 16px; background: white; border: 1px solid #bae6fd; border-radius: 6px; color: #0369a1; cursor: pointer; font-size: 13px;">
                            Asta notarile
                        </button>
                        <button onclick="window.open('https://www.google.com/search?q=${comuneFormatted}+immobile+asta', '_blank')" 
                                style="padding: 8px 16px; background: white; border: 1px solid #bae6fd; border-radius: 6px; color: #0369a1; cursor: pointer; font-size: 13px;">
                            Immobile all'asta
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Footer con pulsanti -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                <button onclick="closeModal()" 
                        style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Chiudi
                </button>
                <button onclick="apriTutteStrategie('${comuneEncoded}')" 
                        style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üöÄ Apri tutti i siti
                </button>
            </div>
            
            <!-- Nota importante -->
            <div style="margin-top: 15px; padding: 12px; background: #fef2f2; border-radius: 6px; border: 1px solid #fecaca;">
                <p style="margin: 0; font-size: 12px; color: #dc2626; display: flex; align-items: flex-start; gap: 8px;">
                    <span style="font-size: 14px;">‚ö†Ô∏è</span>
                    <span><strong>Importante:</strong> Alcuni siti potrebbero bloccare l'apertura automatica. Se non si apre, copia l'URL e incollalo manualmente nel browser.</span>
                </p>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

// ========== FUNZIONE PER APRIRE TUTTI I SITI ==========
function apriTutteStrategie(comuneEncoded) {
    let count = 0;
    let delay = 0;
    
    // Prima strategia: siti diretti
    const sitiDiretti = SITES.filter(site => 
        ['Asta Legale', 'Astagiudiziaria', 'Aste online', 'Asteannunci', 
         'Asteavvisi', 'Immobiliare.it', 'Astetribunali24', 'Canale Aste',
         'Fallimenti.it', 'Gorealbid', 'Legalmente', 'Mercury', 'Repubblica']
        .includes(site.name)
    );
    
    sitiDiretti.forEach(site => {
        setTimeout(() => {
            const searchUrl = costruisciUrlRicercaReale(site, state.filters);
            if (searchUrl) {
                window.open(searchUrl, '_blank');
                count++;
            }
        }, delay);
        delay += 300; // 300ms tra un'apertura e l'altra
    });
    
    // Poi strategia Google (dopo 5 secondi)
    setTimeout(() => {
        const sitiGoogle = SITES.filter(site => 
            ['Astegiudiziarie', 'Enti e Tribunali', 'FALLCO Aste', 
             'Gara Virtuale', 'SIVAG', 'Aste Book']
            .includes(site.name)
        );
        
        sitiGoogle.forEach(site => {
            setTimeout(() => {
                const searchUrl = costruisciUrlRicercaReale(site, state.filters);
                if (searchUrl) {
                    window.open(searchUrl, '_blank');
                    count++;
                }
            }, delay);
            delay += 300;
        });
    }, 5000);
    
    // Infine siti assistiti (dopo 10 secondi)
    setTimeout(() => {
        const sitiAssistiti = SITES.filter(site => 
            ['PVP', 'Vendite Notartel', 'Avvisi Notartel']
            .includes(site.name)
        );
        
        sitiAssistiti.forEach(site => {
            setTimeout(() => {
                const searchUrl = costruisciUrlRicercaReale(site, state.filters);
                if (searchUrl) {
                    window.open(searchUrl, '_blank');
                    count++;
                }
            }, delay);
            delay += 300;
        });
        
        // Messaggio finale
        setTimeout(() => {
            alert(`‚úÖ Aperti ${count} siti in nuove schede!\n\nI siti si stanno aprendo a gruppi per evitare il blocco del browser.`);
        }, 15000);
    }, 10000);
}

// Funzione per avviare ricerche REALI
function avviaRicercheReali() {
    // Verifica se c'√® almeno un filtro
    if (!state.filters.comune && !state.filters.tipologia && !state.filters.prezzoMax) {
        alert("‚ö†Ô∏è Inserisci almeno un filtro (es: Comune) per effettuare la ricerca reale.");
        return;
    }
    
    // Prepara i filtri completi
    const filtriCompleti = {
        comune: state.filters.comune,
        tipologia: state.filters.tipologia,
        prezzoMin: state.filters.prezzoMin,
        prezzoMax: state.filters.prezzoMax
    };
    
    const urlList = [];
    const sitiConErrori = [];
    
    // Genera URL per tutti i siti
    SITES.forEach(site => {
        try {
            // ‚úÖ CORREZIONE: usa la funzione corretta
            const searchUrl = costruisciUrlRicercaReale(site, filtriCompleti);
            
            if (searchUrl) {
                urlList.push({
                    nome: site.name,
                    url: searchUrl,
                    icon: site.icon,
                    color: site.color
                });
            }
        } catch (error) {
            sitiConErrori.push(site.name);
            console.warn(`Errore generazione URL per ${site.name}:`, error);
        }
    });
    
    // Mostra pannello con link
    mostraPannelloRicercheReali(urlList);
    
    // Se ci sono errori, avvisa
    if (sitiConErrori.length > 0) {
        console.log(`‚ö†Ô∏è Errori per siti: ${sitiConErrori.join(', ')}`);
    }
}

// Funzione per mostrare il pannello delle ricerche reali
function mostraPannelloRicercheReali(urlList) {
    let modalContent = `
        <div style="padding: 20px; max-width: 700px; max-height: 80vh; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <h2 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
                    üåê Ricerche Reali sui Siti
                </h2>
                <button onclick="closeModal()" 
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0;">
                    √ó
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #4b5563;">üìã Filtri applicati:</h3>
                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; font-size: 14px;">
    `;
    
    // Mostra filtri applicati
    if (state.filters.comune) {
        modalContent += `<div><strong>Comune:</strong> ${state.filters.comune}</div>`;
    }
    if (state.filters.tipologia) {
        modalContent += `<div><strong>Tipologia:</strong> ${state.filters.tipologia}</div>`;
    }
    if (state.filters.prezzoMin) {
        modalContent += `<div><strong>Prezzo min:</strong> ‚Ç¨${parseInt(state.filters.prezzoMin).toLocaleString('it-IT')}</div>`;
    }
    if (state.filters.prezzoMax) {
        modalContent += `<div><strong>Prezzo max:</strong> ‚Ç¨${parseInt(state.filters.prezzoMax).toLocaleString('it-IT')}</div>`;
    }
    
    modalContent += `
                </div>
                <p style="margin: 10px 0 0 0; font-size: 13px; color: #6b7280;">
                    Clicca sui siti qui sotto per aprire le ricerche con i tuoi filtri.
                </p>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding-right: 5px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">
    `;
    
    // Mostra tutti i siti come pulsanti
    urlList.forEach((sito, idx) => {
        const displayUrl = sito.url.length > 50 ? sito.url.substring(0, 50) + '...' : sito.url;
        modalContent += `
                    <a href="${sito.url}" 
                       target="_blank"
                       onclick="trackSearchClick('${sito.nome.replace(/'/g, "\\'")}')"
                       style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
                              background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; 
                              text-decoration: none; color: #374151; transition: all 0.2s; cursor: pointer;"
                       onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'"
                       onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb'">
                        <span style="font-size: 20px;">${sito.icon}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${sito.nome}
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${displayUrl}
                            </div>
                        </div>
                        <span style="color: #3b82f6; font-size: 14px;">‚ÜóÔ∏è</span>
                    </a>
        `;
    });
    
    modalContent += `
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                <button onclick="closeModal()" 
                        style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Chiudi
                </button>
                <button onclick="apriTuttiSiti()" 
                        style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    üîì Apri tutti i siti
                </button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
                <p style="margin: 0; font-size: 12px; color: #0369a1;">
                    üí° <strong>Suggerimento:</strong> I siti si apriranno in nuove schede. Controlla il blocco popup del browser.
                </p>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

        function getColoreSito(siteName) {
    const site = SITES.find(s => s.name === siteName);
    return site ? site.color : 'gray';
}

        // Funzione per aprire tutti i siti in una volta
// Modifica la funzione apriTuttiSiti():
function apriTuttiSiti() {
    let count = 0;
    let delay = 0;
    
    SITES.forEach(site => {
        setTimeout(() => {
            const searchUrl = costruisciUrlRicercaReale(site, state.filters);
            if (searchUrl) {
                window.open(searchUrl, '_blank');
                count++;
                
                // Aggiorna contatore in tempo reale
                if (count === 1 || count % 5 === 0) {
                    const modalContent = document.querySelector('.modal-overlay > div');
                    if (modalContent) {
                        const apriBtn = modalContent.querySelector('button[onclick*="apriTuttiSiti"]');
                        if (apriBtn) {
                            apriBtn.innerHTML = `üîì Aperti ${count}/${SITES.length} siti`;
                        }
                    }
                }
            }
        }, delay);
        
        delay += 100; // Ritardo di 100ms tra un'apertura e l'altra
    });
    
    // Reset del pulsante dopo 5 secondi
    setTimeout(() => {
        const modalContent = document.querySelector('.modal-overlay > div');
        if (modalContent) {
            const apriBtn = modalContent.querySelector('button[onclick*="apriTuttiSiti"]');
            if (apriBtn) {
                apriBtn.innerHTML = `üîì Apri tutti i siti`;
                apriBtn.disabled = false;
            }
        }
        alert(`‚úÖ Aperti ${count} siti in nuove schede!`);
    }, Math.max(delay, 5000));
}

// Funzione per tracciare i click (opzionale)
function trackSearchClick(siteName) {
    console.log(`Ricerca reale su: ${siteName}`);
    // Qui puoi aggiungere analytics se vuoi
}
function deduplicateResults(results) {
    const seen = new Set();
    const deduplicated = [];
    
    for (const result of results) {
        const key = `${result.comune}_${result.indirizzo.split(' ')[0]}_${Math.floor(result.prezzo / 10000)}`;
        if (!seen.has(key)) {
            seen.add(key);
            deduplicated.push(result);
        }
    }
    
    return deduplicated;
}

function generateMockResults() {
    const comuneFiltro = state.filters.comune || '';
    const tipologiaFiltro = state.filters.tipologia || '';
    const prezzoMin = parseInt(state.filters.prezzoMin) || 0;
    const prezzoMax = parseInt(state.filters.prezzoMax) || 10000000;
    
    const comuni = comuneFiltro ? [comuneFiltro] : Object.keys(coordinateComuni);
    const tipologie = tipologiaFiltro ? [tipologiaFiltro] : ['Appartamento', 'Villa', 'Attico', 'Garage', 'Terreno', 'Capannone', 'Ufficio'];
    
    const caratteristiche = [
        'Con giardino privato', 'Box auto incluso', 'In centro storico', 
        'Zona residenziale tranquilla', 'Vista panoramica', 'Con piscina',
        'A due passi dal mare', 'Con ampio terrazzo', 'Recentemente ristrutturato',
        'Classe energetica A4', 'Con cantina', 'Doppi servizi', 'Impianto fotovoltaico'
    ];
    
    const condizioni = [
        'Ottime condizioni', 'Da ristrutturare completamente', 'Nuovo di costruzione',
        'Parzialmente ristrutturato', 'Libero immediatamente', 'In classe A',
        'Con certificazione energetica', 'Pronto per abitare'
    ];
    
    const results = [];
    const numResults = Math.floor(Math.random() * 8) + 12;
    
    for (let i = 0; i < numResults; i++) {
        const comune = comuni[Math.floor(Math.random() * comuni.length)];
        const tipologia = tipologie[Math.floor(Math.random() * tipologie.length)];
        const prezzo = Math.floor(Math.random() * (prezzoMax - prezzoMin)) + prezzoMin;
        
        if (prezzo < prezzoMin || prezzo > prezzoMax) continue;
        
        // Seleziona 1-3 fonti casuali per questo annuncio
        const fonti = [];
        const numFonti = Math.floor(Math.random() * 3) + 1;
        const fontiDisponibili = [...SITES];
        
        for (let j = 0; j < numFonti; j++) {
            if (fontiDisponibili.length === 0) break;
            const randomIndex = Math.floor(Math.random() * fontiDisponibili.length);
            const fonte = fontiDisponibili.splice(randomIndex, 1)[0];
            fonti.push({
                nome: fonte.name,
                url: fonte.url,
                icon: fonte.icon
            });
        }
        
        results.push({
            id: i + 1,
            tipologia: tipologia,
            indirizzo: `Via ${['Roma', 'Milano', 'Venezia', 'Garibaldi', 'Dante', 'Vittorio Emanuele'][Math.floor(Math.random() * 6)]} ${Math.floor(Math.random() * 200) + 1}`,
            comune: comune,
            prezzo: prezzo,
            descrizione: `${tipologia} di ${Math.floor(Math.random() * 300) + 50} mq a ${comune}, ${condizioni[Math.floor(Math.random() * condizioni.length)]}. ${caratteristiche[Math.floor(Math.random() * caratteristiche.length)]}.`,
            dataAsta: `${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}/${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}/2024`,
            metriQuadrati: Math.floor(Math.random() * 300) + 50,
            locali: Math.floor(Math.random() * 6) + 1,
            coordinate: coordinateBrescia[comune] || coordinateComuni[comune] || MAP_CENTER,
            fonti: fonti,
            urlEsempio: `https://www.example-aste.com/annuncio/${Math.floor(Math.random() * 10000)}`
        });
    }
    
    return results;
}

// ========== RICERCA REALE SUI SITI ==========

        function initMap() {
            if (map) map.remove();
            
            map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            state.searchResults.forEach(result => {
                if (result.coordinate) {
                    const marker = L.marker(result.coordinate).addTo(map);
      // Modifica nella funzione initMap() (circa riga 1950):
marker.bindPopup(`
    <div style="min-width: 250px;">
        <strong style="color: #1e40af;">${result.tipologia}</strong><br>
        <small>${result.indirizzo}, ${result.comune}</small><br>
        <strong style="color: #059669; font-size: 16px;">
            ‚Ç¨${result.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}
        </strong>
        ${result.fonti && result.fonti.length > 0 ? `
        <div style="margin-top: 8px;">
            <small style="color: #6b7280;">Pubblicato su:</small><br>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                ${result.fonti.slice(0, 3).map(fonte => `
                    <span style="font-size: 10px; padding: 2px 6px; background: #f3f4f6; border-radius: 10px;">
                        ${fonte.icon} ${fonte.nome.substring(0, 12)}${fonte.nome.length > 12 ? '...' : ''}
                    </span>
                `).join('')}
            </div>
            <button onclick="window.open('${result.fonti[0].url}', '_blank')" 
                    style="margin-top: 8px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; width: 100%;">
                üîç Vedi annuncio
            </button>
        </div>
        ` : ''}
    </div>
`);
                }
            });
            
            if (state.searchResults.length > 0) {
                const bounds = L.latLngBounds(state.searchResults.map(r => r.coordinate).filter(c => c));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

// Sostituisci completamente la funzione showAnnuncioDetails() (circa riga 1760):
function showAnnuncioDetails(annuncioId) {
    const annuncio = state.searchResults.find(a => a.id === annuncioId);
    if (!annuncio) return;
    
    let details = `
üìã DETTAGLI COMPLETI ANNUNCIO

üè† Tipologia: ${annuncio.tipologia}
üìç Indirizzo: ${annuncio.indirizzo}, ${annuncio.comune}
üí∞ Prezzo base d'asta: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}
üìè Metratura: ${annuncio.metriQuadrati} m¬≤
üö™ Locali: ${annuncio.locali}
üè∑Ô∏è Prezzo al m¬≤: ‚Ç¨${(annuncio.prezzo / annuncio.metriQuadrati).toFixed(2)}
üìÖ Data asta: ${annuncio.dataAsta}
üéØ Zona: ${getNomeZonaDaComune(annuncio.comune) || 'Non specificata'}

üìù Descrizione:
${annuncio.descrizione}

${annuncio.coordinate && annuncio.coordinate !== MAP_CENTER ? 
`üó∫Ô∏è Coordinate: ${annuncio.coordinate[0].toFixed(4)}, ${annuncio.coordinate[1].toFixed(4)}` : 
'üó∫Ô∏è Coordinate: Non disponibili'}
    `;
    
    // Se ci sono fonti, crea un messaggio con pulsanti
    if (annuncio.fonti && annuncio.fonti.length > 0) {
        const linkDiv = document.createElement('div');
        linkDiv.innerHTML = `
            <div style="padding: 15px; background: #f8fafc; border-radius: 10px; margin-top: 15px; max-width: 400px;">
                <h3 style="margin: 0 0 10px 0; color: #1e40af; font-size: 16px; font-weight: bold;">
                    üåê VISUALIZZA ANNUNCIO SUI SITI
                </h3>
                <p style="margin: 0 0 10px 0; color: #4b5563; font-size: 14px;">
                    Questo annuncio √® pubblicato su ${annuncio.fonti.length} portale${annuncio.fonti.length > 1 ? 'i' : ''}:
                </p>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                    ${annuncio.fonti.map(fonte => `
                        <button onclick="window.open('${fonte.url}', '_blank')" 
                                style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#9ca3af'"
                                onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db'">
                            <span style="font-size: 16px;">${fonte.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151;">${fonte.nome}</div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">Clicca per visitare il sito</div>
                            </div>
                            <span style="color: #3b82f6; font-size: 14px;">üîó</span>
                        </button>
                    `).join('')}
                </div>
                ${annuncio.urlEsempio ? `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #d1d5db;">
                    <button onclick="window.open('${annuncio.urlEsempio}', '_blank')" 
                            style="width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üîç Vedi annuncio completo (esempio)
                    </button>
                </div>
                ` : ''}
            </div>
        `;
        
        // Mostra prima i dettagli in alert
        alert(details);
        
        // Poi mostra la finestra con i link
        setTimeout(() => {
            const linkModal = document.createElement('div');
            linkModal.style.position = 'fixed';
            linkModal.style.top = '0';
            linkModal.style.left = '0';
            linkModal.style.right = '0';
            linkModal.style.bottom = '0';
            linkModal.style.background = 'rgba(0,0,0,0.5)';
            linkModal.style.display = 'flex';
            linkModal.style.alignItems = 'center';
            linkModal.style.justifyContent = 'center';
            linkModal.style.zIndex = '9999';
            
            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.borderRadius = '12px';
            modalContent.style.padding = '20px';
            modalContent.style.maxWidth = '450px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';
            modalContent.style.boxShadow = '0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)';
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: bold;">
                        üåê Collegamenti ai siti
                    </h2>
                    <button onclick="this.closest('.link-modal').remove()" 
                            style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">
                        √ó
                    </button>
                </div>
                <div style="margin-bottom: 15px; color: #4b5563; font-size: 14px;">
                    <p style="margin: 0 0 5px 0;">
                        <strong>${annuncio.tipologia}</strong> a ${annuncio.comune}
                    </p>
                    <p style="margin: 0; color: #059669; font-weight: 600;">
                        ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT')}
                    </p>
                </div>
                ${linkDiv.innerHTML}
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="this.closest('.link-modal').remove()" 
                            style="padding: 8px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Chiudi
                    </button>
                </div>
            `;
            
            linkModal.appendChild(modalContent);
            linkModal.classList.add('link-modal');
            linkModal.onclick = function(e) {
                if (e.target === linkModal) {
                    linkModal.remove();
                }
            };
            
            document.body.appendChild(linkModal);
        }, 100);
    } else {
        alert(details);
    }
}

        function geolocalizzaAnnuncio(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            if (!annuncio.coordinate || annuncio.coordinate === MAP_CENTER) {
                alert(`Coordinate non disponibili per ${annuncio.comune}.\n\nGeolocalizzazione possibile solo per comuni della provincia di Brescia.`);
                return;
            }
            
            // Centra la mappa sull'annuncio
            if (map) {
                map.setView(annuncio.coordinate, 15);
                
                // Apri il popup del marker
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker && 
                        layer.getLatLng().lat === annuncio.coordinate[0] && 
                        layer.getLatLng().lng === annuncio.coordinate[1]) {
                        layer.openPopup();
                    }
                });
                
                alert(`Mappa centrata su: ${annuncio.indirizzo}, ${annuncio.comune}`);
            } else {
                alert('Carica prima la mappa effettuando una ricerca.');
            }
        }

        function showClientSuggestions(annuncioId) {
            const annuncio = state.searchResults.find(a => a.id === annuncioId);
            if (!annuncio) return;
            
            // Ottieni la zona del comune dell'annuncio
            const zonaComune = getZonaDaComune(annuncio.comune);
            
            if (!zonaComune) {
                const nomeZona = getNomeZonaDaComune(annuncio.comune);
                alert(`Nessuna zona assegnata per ${annuncio.comune}.\n\nComune non presente nel database zone.`);
                return;
            }
            
            // Cerca clienti con questa zona (ZONE contiene codici numerici, es: ["3"])
            const matchedClients = state.clients.filter(client => {
                return client.ZONE && client.ZONE.includes(zonaComune);
            });
            
            if (matchedClients.length === 0) {
                const nomeZona = zoneInfo[zonaComune]?.nome || 'Sconosciuta';
                alert(`Nessun cliente trovato per la zona ${zonaComune} (${annuncio.comune}).\n\nZona ${zonaComune}: ${nomeZona}\n\nClienti cercano zona ${zonaComune}`);
                return;
            }
            
            let message = `üè† CLIENTI COMPATIBILI\n`;
            message += `üìç ${annuncio.tipologia} a ${annuncio.comune} (Zona ${zonaComune}: ${zoneInfo[zonaComune]?.nome})\n`;
            message += `üí∞ Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})}\n\n`;
            
            matchedClients.forEach((client, idx) => {
                const budgetFascia = budgetFasce.find(f => f.id === client.BUDGET_FASCIA);
                message += `${idx + 1}. ${client.COGNOME} ${client.NOME}\n`;
                message += `   üìû ${client.TELEFONO || 'Nessuno'}\n`;
                message += `   üìß ${client.MAIL || 'Nessuna'}\n`;
                message += `   üí∞ Budget: ${budgetFascia?.label || 'Non impostato'}\n`;
                message += `   üìù Note: ${client.NOTE || 'Nessuna'}\n`;
                message += `   üîµ Zone preferite: ${client.ZONE ? client.ZONE.map(z => `Zona ${z}`).join(', ') : 'Nessuna'}\n\n`;
            });
            
            message += `üìä Totale: ${matchedClients.length} cliente${matchedClients.length !== 1 ? 'i' : ''} compatibile${matchedClients.length !== 1 ? 'i' : ''}`;
            
            alert(message);
        }

        function renderModal() {
            // Implementazione semplice per ora
            const modalContainer = document.getElementById('modal-container');
            if (!state.showClientSuggestions) {
                modalContainer.innerHTML = '';
            }
        }

        // ========== IMPORT/EXPORT ==========
        function showImportModal() {
            state.activeTab = 'import';
            render();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processExcelFile(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropzone = event.currentTarget;
            dropzone.classList.remove('border-indigo-400', 'bg-indigo-50');
            dropzone.classList.add('border-gray-300');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.match(/\.(xlsx|xls)$/i)) {
                    processExcelFile(file);
                } else {
                    alert('Per favore carica solo file Excel (.xlsx o .xls)');
                }
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropzone = event.currentTarget;
            dropzone.classList.remove('border-gray-300');
            dropzone.classList.add('border-indigo-400', 'bg-indigo-50');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropzone = event.currentTarget;
            dropzone.classList.remove('border-indigo-400', 'bg-indigo-50');
            dropzone.classList.add('border-gray-300');
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    const importedClients = rows.map(row => {
                        const client = {};
                        headers.forEach((header, index) => {
                            if (header && row[index] !== undefined) {
                                const normalizedHeader = header
                                    .replace('CUSTOMER<br>CODE', 'CUSTOMER_CODE')
                                    .replace('CUSTOMER CODE', 'CUSTOMER_CODE')
                                    .replace('AREA D\'INTERESSE', 'AREA_INTERESSE')
                                    .replace('ATTIVI?', 'ATTIVI')
                                    .trim()
                                    .replace(/\s+/g, '_')
                                    .toUpperCase();
                                
                                client[normalizedHeader] = row[index];
                            }
                        });
                        
                        // Imposta valori di default per i nuovi campi
                        if (!client.ZONE) client.ZONE = [];
                        if (!client.BUDGET_FASCIA) client.BUDGET_FASCIA = 'under100';
                        if (!client.NOTE) client.NOTE = '';
                        
                        return client;
                    }).filter(client => client.COGNOME && client.NOME);
                    
                    state.importedData = importedClients;
                    render();
                    
                } catch (error) {
                    console.error('Errore:', error);
                    alert('Errore nella lettura del file Excel.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function confirmImport() {
            if (!state.importedData || state.importedData.length === 0) {
                alert('Nessun dato da importare');
                return;
            }
            
            // Aggiungi i nuovi clienti
            state.importedData.forEach(client => {
                // Assegna nuovo codice se duplicato
                if (state.clients.some(c => c.CUSTOMER_CODE === client.CUSTOMER_CODE)) {
                    let nuovoCodice = (parseInt(getUltimoCodice()) + 1).toString();
                    while (state.clients.some(c => c.CUSTOMER_CODE === nuovoCodice)) {
                        nuovoCodice = (parseInt(nuovoCodice) + 1).toString();
                    }
                    client.CUSTOMER_CODE = nuovoCodice;
                }
            });
            
            state.clients.push(...state.importedData);
            saveData();
            
            alert(`‚úÖ Importati ${state.importedData.length} clienti con successo!`);
            state.importedData = null;
            state.activeTab = 'clients';
            render();
        }

        function clearImport() {
            state.importedData = null;
            render();
        }
        
        function downloadTemplate(tipo) {
            let headers, data;
            
            if (tipo === 'completo') {
                headers = ['COGNOME', 'NOME', 'CUSTOMER CODE', 'TELEFONO', 'MAIL', 'ATTIVI?', 'ZONE', 'BUDGET', 'NOTE', 'AREA_INTERESSE'];
                data = [
                    ['Rossi', 'Mario', '1', '1234567890', 'mario@email.com', 'SI', '1,7', 'under100', 'Interessato a Brescia citt√†', 'Zona 1 e 7'],
                    ['Bianchi', 'Luigi', '2', '0987654321', 'luigi@email.com', 'SI', '3', 'under50', 'Cerca monolocale a Iseo', 'Lago d\'Iseo'],
                    ['Verdi', 'Giuseppe', '3', '5551234567', 'giuseppe@email.com', 'NO', '2,8', 'nolimit', 'Budget alto per Franciacorta', 'Garda e Franciacorta']
                ];
            } else {
                // Template base
                headers = ['COGNOME', 'NOME', 'CUSTOMER CODE', 'TELEFONO', 'MAIL', 'ATTIVI?', 'NOTE'];
                data = [
                    ['Rossi', 'Mario', '1', '1234567890', 'mario@email.com', 'SI', 'Interessato zona 1 e 7'],
                    ['Bianchi', 'Anna', '2', '0987654321', 'anna@email.com', 'SI', 'Cerca appartamento 3 locali'],
                    ['Verdi', 'Giovanni', '3', '5551234567', 'giovanni@email.com', 'NO', 'Non pi√π attivo']
                ];
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'Clienti');
            
            const fileName = `template_clienti_${tipo}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ Template ${tipo} scaricato come ${fileName}`);
        }
        
        function exportClientsToExcel() {
            if (state.clients.length === 0) {
                alert('Nessun cliente da esportare');
                return;
            }
            
            const headers = ['COGNOME', 'NOME', 'CUSTOMER CODE', 'TELEFONO', 'MAIL', 'ATTIVI?', 'ZONE', 'BUDGET', 'NOTE'];
            const data = state.clients.map(client => [
                client.COGNOME,
                client.NOME,
                client.CUSTOMER_CODE,
                client.TELEFONO,
                client.MAIL,
                client.ATTIVI,
                client.ZONE ? client.ZONE.join(', ') : '',
                client.BUDGET_FASCIA ? budgetFasce.find(f => f.id === client.BUDGET_FASCIA)?.label || '' : '',
                client.NOTE || ''
            ]);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'Clienti');
            
            const fileName = `clienti_brescia_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ Esportati ${state.clients.length} clienti in ${fileName}`);
        }

        function exportAllToPDF() {
            if (state.searchResults.length === 0) {
                alert('Nessun annuncio da esportare');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text('REPORT COMPLETO ANNUNCI ASTA IMMOBILIARE', 105, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} - ${state.searchResults.length} annunci trovati`, 105, y, { align: 'center' });
            y += 15;
            
            state.searchResults.forEach((annuncio, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(79, 70, 229);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${annuncio.tipologia} - ${annuncio.comune}`, 20, y);
                y += 7;
                
                doc.setFontSize(10);
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'normal');
                
                doc.text(`Indirizzo: ${annuncio.indirizzo}`, 25, y);
                y += 5;
                doc.text(`Prezzo: ‚Ç¨${annuncio.prezzo.toLocaleString('it-IT', {minimumFractionDigits: 2})} | m¬≤: ${annuncio.metriQuadrati}`, 25, y);
                y += 5;
                doc.text(`Data asta: ${annuncio.dataAsta}`, 25, y);
                y += 8;
                
                if (index < state.searchResults.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(20, y, 190, y);
                    y += 8;
                }
            });
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Piattaforma Aste Immobiliari', 105, 285, { align: 'center' });
            
            doc.save(`report-aste-${new Date().toISOString().split('T')[0]}.pdf`);
            alert(`‚úÖ Report PDF generato con ${state.searchResults.length} annunci!`);
        }
        
        // ========== FUNZIONI DI CONVERSIONE ==========
        function getZonaDaComune(comune) {
            if (!comune) return null;
            const comuneNormalizzato = comune.trim().toLowerCase();
            for (const [nomeComune, zona] of Object.entries(comuniBrescia)) {
                if (nomeComune.toLowerCase() === comuneNormalizzato) {
                    return zona;
                }
            }
            return null;
        }

        function getNomeZonaDaComune(comune) {
            const zona = getZonaDaComune(comune);
            if (!zona) return null;
            return zoneInfo[zona]?.nome || null;
        }

        // ========== UTILITY ==========
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
     
        // ========== INIZIALIZZAZIONE ==========
        loadInitialData();
        render();

        // Esponi funzioni globali
        window.showImportModal = showImportModal;
        window.toggleZoneSelection = toggleZoneSelection;
        window.selectBudget = selectBudget;
        window.saveNewClient = saveNewClient;
        window.saveEditedClient = saveEditedClient;
        window.editClient = editClient;
        window.deleteClient = deleteClient;
        window.showAddClientModal = showAddClientModal;
        window.closeModal = closeModal;
        window.showModal = showModal;
        window.handleDrop = handleDrop;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleFileSelect = handleFileSelect;
        window.confirmImport = confirmImport;
        window.clearImport = clearImport;
        window.exportClientsToExcel = exportClientsToExcel;
        window.exportAllToPDF = exportAllToPDF;
        window.showAnnuncioDetails = showAnnuncioDetails;
        window.showClientSuggestions = showClientSuggestions;
        window.geolocalizzaAnnuncio = geolocalizzaAnnuncio;
        window.downloadTemplate = downloadTemplate;
        window.avviaRicercheReali = avviaRicercheReali;
        window.apriTuttiSiti = apriTuttiSiti;
        window.trackSearchClick = trackSearchClick;

    </script>
</body>
</html>

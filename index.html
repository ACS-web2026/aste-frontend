<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Scraping Aste - Match Automatico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .match-card { transition: all 0.3s; }
        .match-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .badge-match { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- VerrÃ  popolato da JavaScript -->
    </div>

    <script>
        // ========== CONFIGURAZIONE ==========
        const CONFIG = {
            password: 'aste2025',
            maxResultsPerSite: 20,
            scrapingTimeout: 30000, // 30 secondi
            matchThreshold: 70 // % di match minimo
        };

        // ========== STATO GLOBALE ==========
        let state = {
            isAuthenticated: false,
            password: '',
            activeTab: 'search',
            isLoading: false,
            scrapingProgress: 0,
            scrapingStatus: '',
            
            filters: {
                comune: 'Brescia',
                tipologia: '',
                prezzoMin: '',
                prezzoMax: '250000'
            },
            
            clients: [
                {
                    id: 1,
                    nome: 'Mario Rossi',
                    cognome: 'Rossi',
                    telefono: '3331234567',
                    zone: ['1', '7'],
                    budgetMin: 50000,
                    budgetMax: 150000,
                    tipologie: ['Appartamento', 'Attico'],
                    note: 'Cerca in centro',
                    matchScore: 0
                },
                {
                    id: 2,
                    nome: 'Luigi Bianchi',
                    cognome: 'Bianchi',
                    telefono: '3345678901',
                    zone: ['2', '3'],
                    budgetMin: 100000,
                    budgetMax: 300000,
                    tipologie: ['Villa', 'Appartamento'],
                    note: 'Zona lago',
                    matchScore: 0
                },
                {
                    id: 3,
                    nome: 'Giuseppe Verdi',
                    cognome: 'Verdi',
                    telefono: '3356789012',
                    zone: ['1'],
                    budgetMin: 80000,
                    budgetMax: 200000,
                    tipologie: ['Appartamento'],
                    note: 'Solo cittÃ ',
                    matchScore: 0
                }
            ],
            
            searchResults: [],
            matches: [],
            currentScrapingSite: ''
        };

        // ========== SITI DA SCRAPARE ==========
        const SCRAPING_SITES = [
            {
                name: 'Asta Legale',
                url: 'https://www.astalegale.net/ricerca/',
                method: 'POST',
                params: { ricerca: '{COMUNE}', tipologia: '{TIPOLOGIA}' },
                selectors: {
                    container: '.risultati-ricerca .item',
                    titolo: 'h3 a',
                    prezzo: '.prezzo',
                    localita: '.localita',
                    link: 'h3 a@href',
                    descrizione: '.descrizione'
                }
            },
            {
                name: 'Immobiliare.it Aste',
                url: 'https://www.immobiliare.it/aste-immobiliari/{COMUE-FORMATTATO}/',
                method: 'GET',
                selectors: {
                    container: '.in-realEstateResults__item',
                    titolo: '.in-card__title',
                    prezzo: '.in-card__price',
                    localita: '.in-card__location',
                    link: '.in-card__title@href',
                    metri: '.in-card__features [data-test="features"]'
                }
            },
            {
                name: 'Subito Aste',
                url: 'https://www.subito.it/aste-immobiliari/{COMUE-FORMATTATO}/',
                method: 'GET',
                selectors: {
                    container: '.items__item',
                    titolo: '.BigCard-title',
                    prezzo: '.BigCard-price',
                    localita: '.BigCard-location',
                    link: '.BigCard-title@href'
                }
            }
        ];

        // ========== RENDER PRINCIPALE ==========
        function render() {
            const app = document.getElementById('app');
            
            if (!state.isAuthenticated) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMain();
            }
            
            attachEventListeners();
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-indigo-100 rounded-full mb-4">
                                <i class="fas fa-search text-3xl text-indigo-600"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800">Sistema Scraping Aste</h1>
                            <p class="text-gray-600 mt-2">Match automatico con clienti</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" 
                                   id="password-input"
                                   value="${state.password}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                   placeholder="Inserisci password">
                        </div>
                        
                        <button id="login-btn" 
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg">
                            <i class="fas fa-lock mr-2"></i> Accedi al Sistema
                        </button>
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-sm text-blue-800 text-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Password demo:</strong> aste2025
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            return `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <header class="bg-white shadow-md border-b">
                        <div class="max-w-7xl mx-auto px-4 py-4">
                            <div class="flex flex-col md:flex-row justify-between items-center">
                                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                                    <div class="bg-indigo-100 p-3 rounded-xl">
                                        <i class="fas fa-robot text-2xl text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-800">Scraping & Matching Aste</h1>
                                        <p class="text-gray-600 text-sm">Sistema automatizzato di ricerca e match</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-4">
                                    <div class="hidden md:block text-right">
                                        <p class="text-sm text-gray-600">Clienti attivi</p>
                                        <p class="text-lg font-bold text-indigo-600">${state.clients.length}</p>
                                    </div>
                                    <button id="logout-btn" 
                                            class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-5 py-2.5 rounded-lg font-medium transition-colors">
                                        <i class="fas fa-sign-out-alt mr-2"></i> Esci
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Tabs -->
                    <div class="bg-white border-b">
                        <div class="max-w-7xl mx-auto">
                            <div class="flex overflow-x-auto">
                                <button id="tab-search" 
                                        class="tab-btn flex-1 py-4 px-6 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'search' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                                    <i class="fas fa-search mr-2"></i> Ricerca & Scraping
                                </button>
                                <button id="tab-matches" 
                                        class="tab-btn flex-1 py-4 px-6 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'matches' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                                    <i class="fas fa-heart mr-2"></i> Match (${state.matches.length})
                                </button>
                                <button id="tab-clients" 
                                        class="tab-btn flex-1 py-4 px-6 border-b-2 font-medium whitespace-nowrap ${state.activeTab === 'clients' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                                    <i class="fas fa-users mr-2"></i> Clienti (${state.clients.length})
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Contenuto -->
                    <main class="max-w-7xl mx-auto px-4 py-8">
                        ${state.activeTab === 'search' ? renderSearchTab() : 
                          state.activeTab === 'matches' ? renderMatchesTab() : 
                          renderClientsTab()}
                    </main>
                </div>
            `;
        }

        function renderSearchTab() {
            return `
                <div class="space-y-8">
                    <!-- Pannello Ricerca -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="bg-blue-100 p-4 rounded-xl">
                                <i class="fas fa-cogs text-2xl text-blue-600"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Scraping Automatico</h2>
                                <p class="text-gray-600">Imposta i parametri e avvia la ricerca automatica</p>
                            </div>
                        </div>
                        
                        <!-- Filtri -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Comune</label>
                                <input type="text" 
                                       id="filter-comune"
                                       value="${state.filters.comune}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Es: Brescia">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipologia</label>
                                <select id="filter-tipologia" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                    <option value="">Tutte</option>
                                    <option value="Appartamento" ${state.filters.tipologia === 'Appartamento' ? 'selected' : ''}>Appartamento</option>
                                    <option value="Villa" ${state.filters.tipologia === 'Villa' ? 'selected' : ''}>Villa</option>
                                    <option value="Attico" ${state.filters.tipologia === 'Attico' ? 'selected' : ''}>Attico</option>
                                    <option value="Terreno" ${state.filters.tipologia === 'Terreno' ? 'selected' : ''}>Terreno</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo min (â‚¬)</label>
                                <input type="number" 
                                       id="filter-prezzo-min"
                                       value="${state.filters.prezzoMin}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                       placeholder="0">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo max (â‚¬)</label>
                                <input type="number" 
                                       id="filter-prezzo-max"
                                       value="${state.filters.prezzoMax}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                       placeholder="500000">
                            </div>
                        </div>
                        
                        <!-- Siti da scansionare -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                                <i class="fas fa-globe mr-2"></i> Siti da analizzare (${SCRAPING_SITES.length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                ${SCRAPING_SITES.map(site => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg border">
                                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <i class="fas fa-search text-blue-600"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-800">${site.name}</p>
                                            <p class="text-xs text-gray-500 truncate">${site.url}</p>
                                        </div>
                                        <div class="text-green-500">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Pulsante Avvio -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="start-scraping-btn"
                                    ${state.isLoading ? 'disabled' : ''}
                                    class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg transition-all ${state.isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl'}"
                                    style="min-height: 60px;">
                                ${state.isLoading ? `
                                    <div class="flex items-center justify-center">
                                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mr-3"></div>
                                        <span>Scraping in corso...</span>
                                    </div>
                                ` : `
                                    <div class="flex items-center justify-center">
                                        <i class="fas fa-play-circle text-2xl mr-3"></i>
                                        <div>
                                            <div>ðŸš€ AVVIA SCRAPING AUTOMATICO</div>
                                            <div class="text-sm font-normal opacity-90">Cerca e matcha automaticamente</div>
                                        </div>
                                    </div>
                                `}
                            </button>
                            
                            <button onclick="testScraping()"
                                    class="px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium">
                                <i class="fas fa-vial mr-2"></i> Test Scraping
                            </button>
                        </div>
                        
                        ${state.isLoading ? renderProgressBar() : ''}
                    </div>
                    
                    <!-- Risultati Scraping -->
                    ${state.searchResults.length > 0 ? renderScrapingResults() : ''}
                </div>
            `;
        }

        function renderProgressBar() {
            return `
                <div class="mt-8">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">
                            <i class="fas fa-sync-alt mr-2"></i> ${state.scrapingStatus}
                        </span>
                        <span class="text-sm font-medium text-gray-700">${Math.round(state.scrapingProgress)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="progress-bar bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full" 
                             style="width: ${state.scrapingProgress}%"></div>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Analisi: ${state.currentScrapingSite || 'In preparazione...'}
                    </div>
                </div>
            `;
        }

        function renderScrapingResults() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-list-alt mr-2"></i> Risultati Scraping
                            </h3>
                            <p class="text-gray-600">${state.searchResults.length} annunci trovati</p>
                        </div>
                        <button onclick="esportaRisultatiCSV()" 
                                class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                            <i class="fas fa-download mr-2"></i> Esporta CSV
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">SITO</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">TITOLO</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">LOCALITÃ€</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">PREZZO</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">MATCH</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">AZIONI</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${state.searchResults.slice(0, 10).map((result, index) => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                <i class="fas fa-globe mr-1"></i> ${result.source}
                                            </span>
                                        </td>
                                        <td class="py-3 px-4 font-medium">${result.titolo.substring(0, 50)}${result.titolo.length > 50 ? '...' : ''}</td>
                                        <td class="py-3 px-4">${result.localita}</td>
                                        <td class="py-3 px-4">
                                            <span class="font-bold text-green-700">${formatEuro(result.prezzo)}</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            ${result.matchScore > 0 ? `
                                                <span class="badge-match inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-green-500 to-emerald-600 text-white">
                                                    <i class="fas fa-heart mr-1"></i> ${result.matchScore}% match
                                                </span>
                                            ` : '<span class="text-gray-400 text-sm">Nessun match</span>'}
                                        </td>
                                        <td class="py-3 px-4">
                                            <div class="flex space-x-2">
                                                <button onclick="mostraDettaglioAnnuncio(${index})" 
                                                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <a href="${result.link}" target="_blank"
                                                   class="p-2 text-green-600 hover:bg-green-50 rounded-lg">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${state.searchResults.length > 10 ? `
                        <div class="mt-4 text-center">
                            <p class="text-gray-600">... e altri ${state.searchResults.length - 10} risultati</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderMatchesTab() {
            const matchesFiltrati = state.matches.filter(m => m.score >= CONFIG.matchThreshold);
            
            return `
                <div class="space-y-8">
                    <!-- Statistiche Match -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-2xl border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-green-800 mb-1">Match Totali</p>
                                    <p class="text-3xl font-bold text-green-900">${matchesFiltrati.length}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center">
                                    <i class="fas fa-heart text-green-600 text-xl"></i>
                                </div>
                            </div>
                            <p class="text-xs text-green-700 mt-2">Match con score > ${CONFIG.matchThreshold}%</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-100 p-6 rounded-2xl border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-blue-800 mb-1">Clienti Coinvolti</p>
                                    <p class="text-3xl font-bold text-blue-900">${new Set(matchesFiltrati.map(m => m.clientId)).size}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                            </div>
                            <p class="text-xs text-blue-700 mt-2">Clienti con match attivi</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-violet-100 p-6 rounded-2xl border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-purple-800 mb-1">Annunci Match</p>
                                    <p class="text-3xl font-bold text-purple-900">${new Set(matchesFiltrati.map(m => m.annuncioIndex)).size}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-purple-200 flex items-center justify-center">
                                    <i class="fas fa-home text-purple-600 text-xl"></i>
                                </div>
                            </div>
                            <p class="text-xs text-purple-700 mt-2">Annunci compatibili</p>
                        </div>
                    </div>
                    
                    <!-- Lista Match -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-heart mr-2 text-red-500"></i> Match Clienti-Annunci
                            </h3>
                            <p class="text-gray-600">Annunci compatibili con le richieste dei clienti</p>
                        </div>
                        
                        ${matchesFiltrati.length > 0 ? `
                            <div class="divide-y divide-gray-100">
                                ${matchesFiltrati.sort((a,b) => b.score - a.score).map(match => {
                                    const cliente = state.clients.find(c => c.id === match.clientId);
                                    const annuncio = state.searchResults[match.annuncioIndex];
                                    if (!cliente || !annuncio) return '';
                                    
                                    return `
                                        <div class="match-card p-6 hover:bg-gray-50">
                                            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                                                <!-- Info Cliente -->
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-3 mb-3">
                                                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                                            <i class="fas fa-user text-indigo-600"></i>
                                                        </div>
                                                        <div>
                                                            <h4 class="font-bold text-gray-800">${cliente.cognome} ${cliente.nome}</h4>
                                                            <p class="text-sm text-gray-600">
                                                                <i class="fas fa-phone-alt mr-1"></i> ${cliente.telefono}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-wrap gap-2 mb-2">
                                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                                            <i class="fas fa-euro-sign mr-1"></i> Budget: ${formatEuro(cliente.budgetMin)} - ${formatEuro(cliente.budgetMax)}
                                                        </span>
                                                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                                            <i class="fas fa-home mr-1"></i> ${cliente.tipologie.join(', ')}
                                                        </span>
                                                        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                                            <i class="fas fa-map-marker-alt mr-1"></i> Zone: ${cliente.zone.join(', ')}
                                                        </span>
                                                    </div>
                                                    ${cliente.note ? `<p class="text-sm text-gray-600"><i class="fas fa-sticky-note mr-1"></i> ${cliente.note}</p>` : ''}
                                                </div>
                                                
                                                <!-- Match Score -->
                                                <div class="flex flex-col items-center">
                                                    <div class="relative w-20 h-20">
                                                        <svg class="w-full h-full" viewBox="0 0 36 36">
                                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                                  fill="none"
                                                                  stroke="#e6e6e6"
                                                                  stroke-width="3"/>
                                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                                  fill="none"
                                                                  stroke="${getScoreColor(match.score)}"
                                                                  stroke-width="3"
                                                                  stroke-dasharray="${match.score}, 100"/>
                                                        </svg>
                                                        <div class="absolute inset-0 flex items-center justify-center">
                                                            <span class="text-xl font-bold" style="color: ${getScoreColor(match.score)}">
                                                                ${match.score}%
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <p class="text-xs text-gray-600 mt-2">Match Score</p>
                                                </div>
                                                
                                                <!-- Info Annuncio -->
                                                <div class="flex-1 lg:text-right">
                                                    <h4 class="font-bold text-gray-800 mb-2">${annuncio.titolo.substring(0, 60)}${annuncio.titolo.length > 60 ? '...' : ''}</h4>
                                                    <div class="space-y-2">
                                                        <p class="text-gray-700">
                                                            <i class="fas fa-map-marker-alt mr-2"></i>
                                                            ${annuncio.localita}
                                                        </p>
                                                        <p class="text-xl font-bold text-green-700">
                                                            <i class="fas fa-tag mr-2"></i>
                                                            ${formatEuro(annuncio.prezzo)}
                                                        </p>
                                                        <p class="text-sm text-gray-600">
                                                            <i class="fas fa-database mr-2"></i>
                                                            Fonte: ${annuncio.source}
                                                        </p>
                                                    </div>
                                                    <div class="mt-3 flex justify-end space-x-2">
                                                        <button onclick="contattaCliente(${cliente.id}, ${match.annuncioIndex})"
                                                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                                                            <i class="fas fa-phone mr-2"></i> Contatta
                                                        </button>
                                                        <a href="${annuncio.link}" target="_blank"
                                                           class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                                                            <i class="fas fa-external-link-alt mr-2"></i> Vedi
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Motivi del Match -->
                                            <div class="mt-4 pt-4 border-t border-gray-100">
                                                <h5 class="text-sm font-semibold text-gray-700 mb-2">
                                                    <i class="fas fa-check-circle mr-2 text-green-500"></i> Motivi della compatibilitÃ :
                                                </h5>
                                                <div class="flex flex-wrap gap-2">
                                                    ${match.reasons.map(reason => `
                                                        <span class="px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs">
                                                            <i class="fas fa-check mr-1"></i> ${reason}
                                                        </span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="p-12 text-center">
                                <div class="inline-flex items-center justify-center w-24 h-24 bg-gray-100 rounded-full mb-6">
                                    <i class="fas fa-heart-broken text-3xl text-gray-400"></i>
                                </div>
                                <h4 class="text-xl font-bold text-gray-700 mb-2">Nessun match trovato</h4>
                                <p class="text-gray-600 mb-6">Avvia lo scraping per trovare annunci compatibili con i tuoi clienti</p>
                                <button onclick="state.activeTab='search'; render();"
                                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-medium">
                                    <i class="fas fa-search mr-2"></i> Vai alla Ricerca
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderClientsTab() {
            return `
                <div class="space-y-8">
                    <!-- Toolbar Clienti -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6">
                            <div class="flex items-center gap-4">
                                <div class="bg-indigo-100 p-4 rounded-xl">
                                    <i class="fas fa-users text-2xl text-indigo-600"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800">Gestione Clienti</h2>
                                    <p class="text-gray-600">Configura i profili per il matching automatico</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="aggiungiCliente()" 
                                        class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                                    <i class="fas fa-plus mr-2"></i> Nuovo Cliente
                                </button>
                                <button onclick="importaClientiCSV()" 
                                        class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                                    <i class="fas fa-file-import mr-2"></i> Importa CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lista Clienti -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">NOME</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">CONTATTO</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">BUDGET</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">TIPOLOGIE</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">ZONE</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">MATCH</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">AZIONI</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${state.clients.map(cliente => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="py-3 px-4">
                                                <div class="font-medium text-gray-800">${cliente.cognome} ${cliente.nome}</div>
                                                <div class="text-sm text-gray-600">${cliente.note || 'Nessuna nota'}</div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="font-mono">${cliente.telefono}</div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="text-green-700 font-medium">${formatEuro(cliente.budgetMin)} - ${formatEuro(cliente.budgetMax)}</div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex flex-wrap gap-1">
                                                    ${cliente.tipologie.map(t => `
                                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${t}</span>
                                                    `).join('')}
                                                </div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex flex-wrap gap-1">
                                                    ${cliente.zone.map(z => `
                                                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">Zona ${z}</span>
                                                    `).join('')}
                                                </div>
                                            </td>
                                            <td class="py-3 px-4">
                                                ${cliente.matchScore > 0 ? `
                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-green-500 to-emerald-600 text-white">
                                                        <i class="fas fa-heart mr-1"></i> ${cliente.matchScore}%
                                                    </span>
                                                ` : '<span class="text-gray-400 text-sm">Nessuno</span>'}
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex space-x-2">
                                                    <button onclick="modificaCliente(${cliente.id})" 
                                                            class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="eliminaCliente(${cliente.id})" 
                                                            class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== FUNZIONI DI UTILITY ==========
        function formatEuro(amount) {
            return 'â‚¬' + parseInt(amount).toLocaleString('it-IT');
        }

        function getScoreColor(score) {
            if (score >= 80) return '#10b981'; // verde
            if (score >= 60) return '#3b82f6'; // blu
            if (score >= 40) return '#f59e0b'; // arancione
            return '#ef4444'; // rosso
        }

        // ========== SISTEMA DI SCRAPING ==========
        async function avviaScrapingCompleto() {
            if (state.isLoading) return;
            
            state.isLoading = true;
            state.scrapingProgress = 0;
            state.searchResults = [];
            state.matches = [];
            render();
            
            const totalSites = SCRAPING_SITES.length;
            const progressIncrement = 100 / totalSites;
            
            try {
                for (let i = 0; i < SCRAPING_SITES.length; i++) {
                    const site = SCRAPING_SITES[i];
                    state.currentScrapingSite = `Scraping ${site.name}...`;
                    state.scrapingStatus = `Analisi sito ${i+1}/${totalSites}`;
                    render();
                    
                    const risultati = await scrapeSite(site);
                    state.searchResults.push(...risultati);
                    
                    state.scrapingProgress += progressIncrement;
                    render();
                    
                    // Match automatico dopo ogni sito
                    await eseguiMatching();
                    
                    await delay(1000); // Pausa tra un sito e l'altro
                }
                
                state.scrapingStatus = 'Scraping completato!';
                state.scrapingProgress = 100;
                state.isLoading = false;
                state.currentScrapingSite = '';
                
                // Mostra risultati
                state.activeTab = 'matches';
                render();
                
                alert(`âœ… Scraping completato!\n\nTrovati: ${state.searchResults.length} annunci\nMatch trovati: ${state.matches.filter(m => m.score >= CONFIG.matchThreshold).length}`);
                
            } catch (error) {
                console.error('Errore scraping:', error);
                state.isLoading = false;
                state.scrapingStatus = 'Errore durante lo scraping';
                alert('Errore durante lo scraping. Controlla la console per dettagli.');
                render();
            }
        }

        async function scrapeSite(site) {
            // SIMULAZIONE DI SCRAPING (per demo)
            // Nella realtÃ , qui andrebbe una vera chiamata a un backend di scraping
            
            await delay(2000); // Simula tempo di caricamento
            
            const comune = state.filters.comune;
            const risultati = [];
            const numRisultati = Math.floor(Math.random() * 10) + 5;
            
            for (let i = 0; i < numRisultati; i++) {
                const prezzi = [50000, 75000, 120000, 180000, 250000, 350000, 500000];
                const tipologie = ['Appartamento', 'Villa', 'Attico', 'Terreno'];
                const localita = [`${comune} Centro`, `${comune} Nord`, `${comune} Sud`, `${comune} - Zona Storica`];
                
                risultati.push({
                    id: Date.now() + i,
                    source: site.name,
                    titolo: `${tipologie[Math.floor(Math.random() * tipologie.length)]} in vendita all'asta`,
                    prezzo: prezzi[Math.floor(Math.random() * prezzi.length)],
                    localita: localita[Math.floor(Math.random() * localita.length)],
                    descrizione: `Immobile di pregio in ottime condizioni. Asta giudiziaria in corso.`,
                    link: `https://${site.name.toLowerCase().replace(/\s+/g, '')}.it/asta-${i}`,
                    dataAsta: new Date(Date.now() + Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString('it-IT'),
                    tipologia: tipologie[Math.floor(Math.random() * tipologie.length)],
                    metriQuadrati: Math.floor(Math.random() * 200) + 50,
                    matchScore: 0
                });
            }
            
            return risultati;
        }

        async function eseguiMatching() {
            state.matches = [];
            
            state.searchResults.forEach((annuncio, annuncioIndex) => {
                state.clients.forEach(cliente => {
                    let score = 0;
                    const reasons = [];
                    
                    // Match per prezzo (40% del punteggio)
                    if (annuncio.prezzo >= cliente.budgetMin && annuncio.prezzo <= cliente.budgetMax) {
                        score += 40;
                        reasons.push(`Prezzo compatibile (${formatEuro(annuncio.prezzo)})`);
                    } else if (annuncio.prezzo <= cliente.budgetMax * 1.2) {
                        score += 20;
                        reasons.push(`Prezzo leggermente superiore`);
                    }
                    
                    // Match per tipologia (30% del punteggio)
                    if (cliente.tipologie.includes(annuncio.tipologia)) {
                        score += 30;
                        reasons.push(`Tipologia "${annuncio.tipologia}" richiesta`);
                    } else if (cliente.tipologie.length === 0) {
                        score += 15;
                    }
                    
                    // Match per zona (30% del punteggio)
                    const zonaAnnuncio = estraiZonaDaLocalita(annuncio.localita);
                    if (zonaAnnuncio && cliente.zone.includes(zonaAnnuncio)) {
                        score += 30;
                        reasons.push(`Zona ${zonaAnnuncio} preferita`);
                    } else {
                        // Match parziale per comune
                        if (annuncio.localita.toLowerCase().includes(state.filters.comune.toLowerCase())) {
                            score += 15;
                            reasons.push(`Nella zona di ${state.filters.comune}`);
                        }
                    }
                    
                    // Bonus per match perfetto
                    if (score >= 80) {
                        score = Math.min(100, score + 10);
                        reasons.push(`Match eccezionale!`);
                    }
                    
                    // Aggiorna score annuncio
                    annuncio.matchScore = Math.max(annuncio.matchScore, score);
                    
                    // Aggiorna score cliente
                    cliente.matchScore = Math.max(cliente.matchScore, score);
                    
                    // Salva match se supera la soglia
                    if (score >= CONFIG.matchThreshold) {
                        state.matches.push({
                            clientId: cliente.id,
                            annuncioIndex: annuncioIndex,
                            score: Math.round(score),
                            reasons: reasons,
                            data: new Date().toISOString()
                        });
                    }
                });
            });
            
            // Ordina match per score
            state.matches.sort((a, b) => b.score - a.score);
        }

        function estraiZonaDaLocalita(localita) {
            // Mappa semplificata comuni -> zone
            const mappaZone = {
                'brescia': '1',
                'centro': '1',
                'nord': '1',
                'sud': '1',
                'lago': '2',
                'gardone': '2',
                'salÃ²': '2',
                'iseo': '3',
                'marone': '3',
                'darfo': '4',
                'valcamonica': '4'
            };
            
            for (const [keyword, zona] of Object.entries(mappaZone)) {
                if (localita.toLowerCase().includes(keyword)) {
                    return zona;
                }
            }
            
            return null;
        }

        // ========== FUNZIONI AUSILIARIE ==========
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function testScraping() {
            // Test con dati di esempio
            state.searchResults = [
                {
                    id: 1,
                    source: 'Asta Legale',
                    titolo: 'Appartamento in centro storico - Asta giudiziaria',
                    prezzo: 120000,
                    localita: 'Brescia Centro',
                    tipologia: 'Appartamento',
                    link: 'https://astalegale.net/asta-1',
                    matchScore: 85
                },
                {
                    id: 2,
                    source: 'Immobiliare.it',
                    titolo: 'Villa con giardino vista lago',
                    prezzo: 280000,
                    localita: 'Gardone Riviera',
                    tipologia: 'Villa',
                    link: 'https://immobiliare.it/asta -villa',
                    matchScore: 75
                }
            ];
            
            state.matches = [
                {
                    clientId: 1,
                    annuncioIndex: 0,
                    score: 85,
                    reasons: ['Prezzo compatibile (â‚¬120.000)', 'Tipologia "Appartamento" richiesta', 'Zona 1 preferita']
                }
            ];
            
            state.activeTab = 'matches';
            render();
            
            alert('Test completato! Visualizza i match nella tab "Match".');
        }

        function mostraDettaglioAnnuncio(index) {
            const annuncio = state.searchResults[index];
            alert(`DETTAGLIO ANNUNCIO\n\n` +
                  `Sito: ${annuncio.source}\n` +
                  `Titolo: ${annuncio.titolo}\n` +
                  `LocalitÃ : ${annuncio.localita}\n` +
                  `Prezzo: ${formatEuro(annuncio.prezzo)}\n` +
                  `Tipologia: ${annuncio.tipologia}\n` +
                  `Match Score: ${annuncio.matchScore}%\n` +
                  `Link: ${annuncio.link}`);
        }

        function contattaCliente(clientId, annuncioIndex) {
            const cliente = state.clients.find(c => c.id === clientId);
            const annuncio = state.searchResults[annuncioIndex];
            
            alert(`ðŸ“ž CONTATTA CLIENTE\n\n` +
                  `Cliente: ${cliente.cognome} ${cliente.nome}\n` +
                  `Telefono: ${cliente.telefono}\n\n` +
                  `ðŸ“‹ ANNUNCIO DA PROPORRE:\n` +
                  `${annuncio.titolo}\n` +
                  `Prezzo: ${formatEuro(annuncio.prezzo)}\n` +
                  `LocalitÃ : ${annuncio.localita}\n\n` +
                  `Match Score: ${state.matches.find(m => m.clientId === clientId && m.annuncioIndex === annuncioIndex)?.score}%\n\n` +
                  `ðŸ’¡ SUGGERIMENTO:\n` +
                  `"Salve ${cliente.nome}, ho trovato un'asta che corrisponde alle sue richieste!"`);
        }

        function esportaRisultatiCSV() {
            const headers = ['Sito', 'Titolo', 'LocalitÃ ', 'Prezzo', 'Tipologia', 'Match%', 'Link'];
            const rows = state.searchResults.map(r => [
                r.source,
                r.titolo,
                r.localita,
                r.prezzo,
                r.tipologia,
                r.matchScore,
                r.link
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aste-${state.filters.comune}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`ðŸ“Š Esportati ${state.searchResults.length} annunci in formato CSV`);
        }

        function aggiungiCliente() {
            const nuovoCliente = {
                id: Date.now(),
                nome: prompt('Nome cliente:'),
                cognome: prompt('Cognome cliente:'),
                telefono: prompt('Telefono:'),
                zone: prompt('Zone (separate da virgola, es: 1,7):').split(',').map(z => z.trim()),
                budgetMin: parseInt(prompt('Budget minimo (â‚¬):')),
                budgetMax: parseInt(prompt('Budget massimo (â‚¬):')),
                tipologie: prompt('Tipologie (separate da virgola):').split(',').map(t => t.trim()),
                note: prompt('Note aggiuntive (opzionale):'),
                matchScore: 0
            };
            
            state.clients.push(nuovoCliente);
            render();
            alert('âœ… Cliente aggiunto con successo!');
        }

        function modificaCliente(id) {
            alert('Funzione di modifica cliente - In sviluppo');
        }

        function eliminaCliente(id) {
            if (confirm('Sei sicuro di eliminare questo cliente?')) {
                state.clients = state.clients.filter(c => c.id !== id);
                render();
                alert('Cliente eliminato');
            }
        }

        function importaClientiCSV() {
            alert('Funzione di importazione CSV - In sviluppo\n\nFormato atteso:\nCognome,Nome,Telefono,Zone,BudgetMin,BudgetMax,Tipologie,Note');
        }

        // ========== EVENT LISTENERS ==========
        function attachEventListeners() {
            // Login
            const loginBtn = document.getElementById('login-btn');
            const passwordInput = document.getElementById('password-input');
            
            if (loginBtn) loginBtn.onclick = handleLogin;
            if (passwordInput) {
                passwordInput.oninput = (e) => state.password = e.target.value;
                passwordInput.onkeypress = (e) => e.key === 'Enter' && handleLogin();
            }
            
            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    state.activeTab = btn.id.replace('tab-', '');
                    render();
                };
            });
            
            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.onclick = () => {
                state.isAuthenticated = false;
                render();
            };
            
            // Filtri
            const filterComune = document.getElementById('filter-comune');
            const filterTipologia = document.getElementById('filter-tipologia');
            const filterPrezzoMin = document.getElementById('filter-prezzo-min');
            const filterPrezzoMax = document.getElementById('filter-prezzo-max');
            
            if (filterComune) filterComune.oninput = (e) => state.filters.comune = e.target.value;
            if (filterTipologia) filterTipologia.onchange = (e) => state.filters.tipologia = e.target.value;
            if (filterPrezzoMin) filterPrezzoMin.oninput = (e) => state.filters.prezzoMin = e.target.value;
            if (filterPrezzoMax) filterPrezzoMax.oninput = (e) => state.filters.prezzoMax = e.target.value;
            
            // Scraping
            const startBtn = document.getElementById('start-scraping-btn');
            if (startBtn) startBtn.onclick = avviaScrapingCompleto;
        }

        function handleLogin() {
            if (state.password === CONFIG.password) {
                state.isAuthenticated = true;
                state.password = '';
                render();
            } else {
                alert('Password errata. Usa: aste2025');
            }
        }

        // ========== INIZIALIZZAZIONE ==========
        render();
        
        // Esponi funzioni globali
        window.testScraping = testScraping;
        window.mostraDettaglioAnnuncio = mostraDettaglioAnnuncio;
        window.contattaCliente = contattaCliente;
        window.esportaRisultatiCSV = esportaRisultatiCSV;
        window.aggiungiCliente = aggiungiCliente;
        window.modificaCliente = modificaCliente;
        window.eliminaCliente = eliminaCliente;
        window.importaClientiCSV = importaClientiCSV;
    </script>
</body>
</html>
